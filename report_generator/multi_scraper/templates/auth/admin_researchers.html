{% extends 'auth/base.html' %}
{% block content %}
<div class="app-layout">
  <aside class="sidebar">
    <div class="sidebar-brand"><div class="logo-icon">SQ</div> Admin</div>
    <nav class="sidebar-nav">
      <a href="/auth/admin"><span class="nav-icon">ğŸ </span> Dashboard</a>
      <a href="/auth/admin/researchers" class="active"><span class="nav-icon">ğŸ‘¥</span> Researchers</a>
      <a href="/auth/admin/submissions"><span class="nav-icon">ğŸ“‹</span> Submissions</a>
      <a href="/auth/admin/analytics"><span class="nav-icon">ğŸ“Š</span> Analytics</a>
      <a href="/tool"><span class="nav-icon">ğŸ”¬</span> Research Tool</a>
      <hr class="sidebar-divider">
      <a href="/auth/profile"><span class="nav-icon">ğŸ‘¤</span> Profile</a>
      <a href="/auth/logout"><span class="nav-icon">ğŸšª</span> Logout</a>
    </nav>
  </aside>

  <main class="main-content">
    <div class="card">
      <div class="card-header">
        <div>
          <h2 class="card-title">Researchers</h2>
          <p class="card-subtitle">Manage researcher accounts</p>
        </div>
        <a class="btn btn-primary btn-sm" href="/auth/admin/create_user">+ Create User</a>
      </div>
      <div class="table-toolbar">
        <div class="search-box"><span class="muted">ğŸ”</span><input id="searchBox" type="text" placeholder="Search usernameâ€¦"></div>
      </div>
      <table class="table-pro" id="researchersTable">
        <thead>
          <tr>
            <th>Username</th>
            <th>Role</th>
            <th>Created By</th>
            <th>Created At</th>
            <th>Last Login</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
            <tr data-username="{{ u.username|lower }}">
              <td><a href="/auth/admin/researchers/{{ u.username }}" style="font-weight:600;color:var(--primary);text-decoration:none">{{ u.username }}</a></td>
              <td><span class="badge badge-info">{{ u.role }}</span></td>
              <td class="muted">{{ u.created_by or 'â€”' }}</td>
              <td><span class="ts">{{ u.created_at or 'â€”' }}</span></td>
              <td><span class="ts">{{ u.last_login or 'â€”' }}</span></td>
              <td>
                <a href="/auth/admin/researchers/{{ u.username }}" class="btn btn-sm" style="background:#f0f2f6;color:#394150;margin-right:6px">View</a>
                <button class="btn btn-sm btn-danger" data-username="{{ u.username }}">Delete</button>
              </td>
            </tr>
          {% endfor %}
          {% if not users %}
            <tr><td colspan="6" class="muted" style="text-align:center;padding:24px">No researchers found</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </main>
</div>

<script>
  const searchBox = document.getElementById('searchBox');
  if (searchBox) {
    searchBox.addEventListener('input', () => {
      const term = searchBox.value.toLowerCase();
      document.querySelectorAll('#researchersTable tbody tr').forEach(row => {
        row.style.display = row.dataset.username.includes(term) ? '' : 'none';
      });
    });
  }

  document.getElementById('researchersTable').addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-username]');
    if (!btn) return;
    const username = btn.dataset.username;
    if (!confirm(`Delete user "${username}"? This will remove their messages and submissions.`)) return;
    try {
      const res = await fetch('/auth/admin/delete_user', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username }) });
      const data = await res.json();
      if (res.ok) { btn.closest('tr').remove(); }
      else { alert(data.error || 'Delete failed'); }
    } catch (err) { alert('Delete request failed'); }
  });
</script>
{% endblock %}