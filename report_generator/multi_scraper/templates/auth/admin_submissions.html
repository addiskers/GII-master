{% extends 'auth/base.html' %}
{% block content %}
  <style>
    .edit-input{width:100%;padding:9px 11px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;font-family:inherit}
    .edit-textarea{width:100%;padding:9px 11px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;font-family:inherit;min-height:110px;resize:vertical}
    .edit-input:focus,.edit-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(108,92,231,0.1)}
  </style>
<div class="app-layout">
  <aside class="sidebar">
    <div class="sidebar-brand"><div class="logo-icon">SQ</div> Admin</div>
    <nav class="sidebar-nav">
      <a href="/auth/admin"><span class="nav-icon">ğŸ </span> Dashboard</a>
      <a href="/auth/admin/researchers"><span class="nav-icon">ğŸ‘¥</span> Researchers</a>
      <a href="/auth/admin/submissions" class="active"><span class="nav-icon">ğŸ“‹</span> Submissions</a>
      <a href="/auth/admin/analytics"><span class="nav-icon">ğŸ“Š</span> Analytics</a>
      <a href="/tool"><span class="nav-icon">ğŸ”¬</span> Research Tool</a>
      <hr class="sidebar-divider">
      <a href="/auth/profile"><span class="nav-icon">ğŸ‘¤</span> Profile</a>
      <a href="/auth/logout"><span class="nav-icon">ğŸšª</span> Logout</a>
    </nav>
  </aside>

  <main class="main-content">
    <div class="card">
      <div class="card-header">
        <div>
          <h2 class="card-title">All Submissions</h2>
          <p class="card-subtitle">Complete RD submission data with all details</p>
        </div>
        <a href="/auth/admin/download_excel" class="btn btn-primary btn-sm">ğŸ“¥ Download Excel</a>
      </div>
      <div class="table-toolbar">
        <span class="muted text-sm fw-600">{{ submissions|length }} submissions</span>
        <div class="search-box"><span class="muted">ğŸ”</span><input id="searchBox" type="text" placeholder="Search market nameâ€¦"></div>
      </div>

          <div class="table-responsive">
            <table class="table-pro">
            <thead>
              <tr>
                <th>Market</th>
                <th>Researcher</th>
                <th>Submitted</th>
                <th>Sector</th>
                <th>Industry</th>
                <th>CAGR</th>
                <th>Size 2024</th>
                <th>Size 2033</th>
                <th>Segments</th>
                <th>Companies</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for s in submissions %}
              <tr data-market="{{ (s.market_name or '')|lower }}">
                <td style="font-weight:600">{{ s.market_name or 'â€”' }}</td>
                <td>{{ s.researcher_username }}</td>
                <td>
                  {% if s.submitted_at %}
                    <span class="ts">{{ s.submitted_at }}</span>
                  {% else %}
                    â€”
                  {% endif %}
                </td>
                <td>{{ s.sector or 'â€”' }}</td>
                <td>{{ s.industry or 'â€”' }}</td>
                <td>{{ s.cagr or 'â€”' }}%</td>
                <td>{{ s.market_size_2024 or 'â€”' }} {{ s.value_unit or '' }}</td>
                <td>{{ s.projected_size_2033 or 'â€”' }} {{ s.value_unit or '' }}</td>
                <td>{{ s.segments|length }}</td>
                <td>{{ s.companies|length }}</td>
                <td>
                  {% if s.downloaded == 1 %}
                    <span class="badge badge-success">Uploaded</span>
                  {% elif s.downloaded %}
                    <span class="badge badge-success">Downloaded</span>
                  {% else %}
                    <span class="badge badge-warning">Pending</span>
                  {% endif %}
                </td>
                <td>
                  <button class="btn-view" data-id="{{ s.id }}">View</button>
                  <button class="btn-toc" data-id="{{ s.id }}" data-name="{{ s.market_name }}" style="background:#6014FA;color:#fff;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;margin-left:4px" title="Generate TOC">TOC</button>
                  <button class="btn-skyquest" data-id="{{ s.id }}" data-name="{{ s.market_name }}">Submit</button>
                </td>
              </tr>
              {% endfor %}
              {% if not submissions %}
                <tr><td colspan="12" class="muted">No submissions yet</td></tr>
              {% endif %}
            </tbody>
          </table>
          </div>
    </div>
  </main>
</div>

<!-- Detail/Edit Modal -->
  <div id="detailModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;padding:20px">
    <div style="background:#fff;border-radius:16px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
      <div style="padding:24px;border-bottom:1px solid #e6e9f0;display:flex;align-items:center;justify-content:space-between">
        <h3 id="modalTitle" style="margin:0;font-size:20px;font-weight:700;color:#1f2430"></h3>
        <div>
          <button id="editBtn" class="btn-edit">âœï¸ Edit</button>
          <button id="closeModal" style="background:transparent;border:none;font-size:24px;cursor:pointer;color:#52596b;margin-left:8px">&times;</button>
        </div>
      </div>
      <div id="modalContent" style="padding:24px"></div>
    </div>
  </div>

  <script>
    let currentSubmission = null;
    let isEditMode = false;
    const submissions = {{ submissions|tojson }};

    // Search functionality
    const searchBox = document.getElementById('searchBox');
    const rows = Array.from(document.querySelectorAll('tbody tr'));
    if (searchBox) {
      searchBox.addEventListener('input', () => {
        const term = searchBox.value.toLowerCase();
        rows.forEach(row => {
          const market = row.dataset.market || '';
          row.style.display = market.includes(term) ? '' : 'none';
        });
      });
    }

    // Modal elements
    const modal = document.getElementById('detailModal');
    const closeBtn = document.getElementById('closeModal');
    const editBtn = document.getElementById('editBtn');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');

    function renderViewMode(sub) {
      return `
        <div class="grid-2" style="margin-bottom:24px">
          <div>
            <div style="font-size:12px;font-weight:600;color:#7a8aa0;margin-bottom:4px">Researcher</div>
            <div style="font-size:14px;color:#1f2430">${sub.researcher_username}</div>
          </div>
          <div>
            <div style="font-size:12px;font-weight:600;color:#7a8aa0;margin-bottom:4px">Created By</div>
            <div style="font-size:14px;color:#1f2430">${sub.created_by || 'â€”'}</div>
          </div>
        </div>

        <div style="margin-bottom:24px">
          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 12px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Industry Classification</h4>
          <div class="grid-2" style="gap:12px">
            <div><span style="font-size:12px;color:#7a8aa0">Sector:</span> <span style="font-size:13px;color:#1f2430">${sub.sector || 'â€”'}</span></div>
            <div><span style="font-size:12px;color:#7a8aa0">Industry Group:</span> <span style="font-size:13px;color:#1f2430">${sub.industry_group || 'â€”'}</span></div>
            <div><span style="font-size:12px;color:#7a8aa0">Industry:</span> <span style="font-size:13px;color:#1f2430">${sub.industry || 'â€”'}</span></div>
            <div><span style="font-size:12px;color:#7a8aa0">Sub-Industry:</span> <span style="font-size:13px;color:#1f2430">${sub.sub_industry || 'â€”'}</span></div>
          </div>
        </div>

        <div style="margin-bottom:24px">
          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 12px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Market Inputs</h4>
          <div class="grid-2" style="gap:12px">
            <div><span style="font-size:12px;color:#7a8aa0">CAGR:</span> <span style="font-size:13px;color:#1f2430;font-weight:600">${sub.cagr || 'â€”'}%</span></div>
            <div><span style="font-size:12px;color:#7a8aa0">Unit:</span> <span style="font-size:13px;color:#1f2430">${sub.value_unit || 'â€”'}</span></div>
            <div><span style="font-size:12px;color:#7a8aa0">Size 2024:</span> <span style="font-size:13px;color:#1f2430;font-weight:600">${sub.market_size_2024 || 'â€”'}</span></div>
            <div><span style="font-size:12px;color:#7a8aa0">Size 2025:</span> <span style="font-size:13px;color:#1f2430">${sub.market_size_2025 || 'â€”'}</span></div>
            <div><span style="font-size:12px;color:#7a8aa0">Projected 2033:</span> <span style="font-size:13px;color:#1f2430;font-weight:600">${sub.projected_size_2033 || 'â€”'}</span></div>
          </div>
        </div>

        <div style="margin-bottom:24px">
          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 12px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Segments (${(sub.segments || []).length})</h4>
          <div style="max-height:200px;overflow-y:auto;background:#f8f9fc;padding:12px;border-radius:8px">
            ${(sub.segments || []).map(s => `<div style="font-size:13px;color:#1f2430;padding:4px 0">${s}</div>`).join('') || '<div class="muted">No segments</div>'}
          </div>
        </div>

        <div style="margin-bottom:24px">
          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 12px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">AI Generated Segments (${(sub.ai_gen_seg || []).length})</h4>
          <div style="max-height:200px;overflow-y:auto;background:#f8f9fc;padding:12px;border-radius:8px">
            ${(sub.ai_gen_seg || []).map(s => `<div style="font-size:13px;color:#1f2430;padding:4px 0">${s}</div>`).join('') || '<div class="muted">No AI segments</div>'}
          </div>
        </div>

        <div>
          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 12px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Companies (${(sub.companies || []).length})</h4>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px">
            ${(sub.companies || []).map(c => `<div style="font-size:13px;color:#1f2430;padding:6px;background:#f8f9fc;border-radius:6px">${c}</div>`).join('') || '<div class="muted">No companies</div>'}
          </div>
        </div>
      `;
    }

    function renderEditMode(sub) {
      return `
        <form id="editForm">
          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 16px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Industry Classification</h4>
          <div class="grid-2" style="gap:16px;margin-bottom:24px">
            <div class="form-group">
              <label class="form-label">Sector</label>
              <input type="text" class="edit-input" name="sector" value="${sub.sector || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Industry Group</label>
              <input type="text" class="edit-input" name="industry_group" value="${sub.industry_group || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Industry</label>
              <input type="text" class="edit-input" name="industry" value="${sub.industry || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Sub-Industry</label>
              <input type="text" class="edit-input" name="sub_industry" value="${sub.sub_industry || ''}">
            </div>
          </div>

          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 16px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Market Inputs</h4>
          <div class="grid-2" style="gap:16px;margin-bottom:24px">
            <div class="form-group">
              <label class="form-label">CAGR (%)</label>
              <input type="text" class="edit-input" name="cagr" value="${sub.cagr || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Value Unit</label>
              <input type="text" class="edit-input" name="value_unit" value="${sub.value_unit || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Market Size 2024</label>
              <input type="text" class="edit-input" name="market_size_2024" value="${sub.market_size_2024 || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Market Size 2025</label>
              <input type="text" class="edit-input" name="market_size_2025" value="${sub.market_size_2025 || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Projected Size 2033</label>
              <input type="text" class="edit-input" name="projected_size_2033" value="${sub.projected_size_2033 || ''}">
            </div>
          </div>

          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 16px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Segments</h4>
          <div class="form-group" style="margin-bottom:24px">
            <label class="form-label">Segments (one per line)</label>
            <textarea class="edit-textarea" name="segments">${(sub.segments || []).join('\n')}</textarea>
          </div>

          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 16px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">AI Generated Segments</h4>
          <div class="form-group" style="margin-bottom:24px">
            <label class="form-label">AI Segments (one per line)</label>
            <textarea class="edit-textarea" name="ai_gen_seg">${(sub.ai_gen_seg || []).join('\n')}</textarea>
          </div>

          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 16px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Companies</h4>
          <div class="form-group" style="margin-bottom:24px">
            <label class="form-label">Companies (one per line)</label>
            <textarea class="edit-textarea" name="companies">${(sub.companies || []).join('\n')}</textarea>
          </div>

          <div style="display:flex;justify-content:flex-end;padding-top:16px;border-top:1px solid #e6e9f0">
            <button type="button" class="btn-cancel" id="cancelEditBtn">Cancel</button>
            <button type="submit" class="btn-save" style="margin-left:8px">ğŸ’¾ Save Changes</button>
          </div>
        </form>
      `;
    }

    function showModal(sub, editMode = false) {
      currentSubmission = sub;
      isEditMode = editMode;
      modalTitle.textContent = sub.market_name || 'Submission Details';
      editBtn.style.display = editMode ? 'none' : 'inline-block';
      
      if (editMode) {
        modalContent.innerHTML = renderEditMode(sub);
        // Attach form submit handler
        document.getElementById('editForm').addEventListener('submit', handleSave);
        document.getElementById('cancelEditBtn').addEventListener('click', () => showModal(sub, false));
      } else {
        modalContent.innerHTML = renderViewMode(sub);
      }
      
      modal.style.display = 'flex';
    }

    async function handleSave(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      
      const payload = {
        id: currentSubmission.id,
        sector: formData.get('sector'),
        industry_group: formData.get('industry_group'),
        industry: formData.get('industry'),
        sub_industry: formData.get('sub_industry'),
        cagr: formData.get('cagr'),
        value_unit: formData.get('value_unit'),
        market_size_2024: formData.get('market_size_2024'),
        market_size_2025: formData.get('market_size_2025'),
        projected_size_2033: formData.get('projected_size_2033'),
        segments: formData.get('segments').split('\n').map(s => s.trim()).filter(s => s),
        ai_gen_seg: formData.get('ai_gen_seg').split('\n').map(s => s.trim()).filter(s => s),
        companies: formData.get('companies').split('\n').map(s => s.trim()).filter(s => s)
      };

      try {
        const res = await fetch('/api/update-submission', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        
        if (data.success) {
          alert('âœ… Submission updated successfully!');
          // Update local data and refresh view
          Object.assign(currentSubmission, payload);
          showModal(currentSubmission, false);
          // Reload page to reflect changes in table
          setTimeout(() => location.reload(), 500);
        } else {
          alert('âŒ Error: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('âŒ Error: ' + err.message);
      }
    }

    // View button click
    document.querySelectorAll('.btn-view').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = parseInt(btn.dataset.id);
        const sub = submissions.find(s => s.id === id);
        if (sub) showModal(sub, false);
      });
    });

    // Edit button click
    editBtn.addEventListener('click', () => {
      if (currentSubmission) showModal(currentSubmission, true);
    });

    // Close modal
    closeBtn.addEventListener('click', () => { modal.style.display = 'none'; });
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

    // Generate TOC Handler
    document.querySelectorAll('.btn-toc').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const name = btn.dataset.name;
        btn.disabled = true;
        const origText = btn.textContent;
        btn.textContent = 'â³...';
        try {
          const res = await fetch('/api/generate-toc-from-submission', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ submission_id: id })
          });
          const data = await res.json();
          if (data.success) {
            const link = document.createElement('a');
            link.href = '/api/download-file?file_path=' + encodeURIComponent(data.file_path);
            link.download = data.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } else {
            alert('Error: ' + (data.error || 'Unknown error'));
          }
        } catch (err) {
          alert('Error: ' + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = origText;
        }
      });
    });

    // SkyQuest Submit Handler
    document.querySelectorAll('.btn-skyquest').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const name = btn.dataset.name;
        
        const confirmMsg = 'Submit "' + name + '" to SkyQuest?\n\n' +
          'This will:\n' +
          '1. Generate DOCX report (~10 min)\n' +
          '2. Generate image (~1-2 min)\n' +
          '3. Generate Excel (~2 min)\n' +
          '4. Upload all files to SkyQuest\n\n' +
          'Total time: ~15 minutes. Do not close this page.';
        
        if (!confirm(confirmMsg)) return;
        
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = 'Processing...';
        
        try {
          const res = await fetch('/api/submit-to-skyquest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ submission_id: id })
          });
          const data = await res.json();
          
          if (data.success) {
            alert('Success: ' + data.message);
            location.reload();
          } else {
            alert('Error: ' + (data.error || 'Unknown error'));
          }
        } catch (err) {
          alert('Error: ' + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });
    });
  </script>
{% endblock %}
