{% extends 'auth/base.html' %}
{% block content %}
  <style>
    .container{max-width:100%;margin:0;padding-left:24px}
    :root{
      --primary:#6C5CE7;
      --bg:#f5f6fa;
      --text:#1f2430;
      --muted:#7a8aa0;
      --border:#e6e9f0;
      --card:#ffffff;
      --success-bg:#e9f7ef;
      --success:#1e7d44;
      --warning-bg:#fff7e6;
      --warning:#b46900;
    }
    .page-chrome{position:relative}
    .page-chrome:before,.page-chrome:after{content:"";position:fixed;left:0;right:0;height:10px;background:var(--primary);z-index:0}
    .page-chrome:before{top:0}.page-chrome:after{bottom:0}
    .admin-layout{display:grid;grid-template-columns:250px 1fr;gap:18px;margin-top:12px}
    .sidebar{background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(31,36,48,0.08);padding:18px;min-height:70vh}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--text);margin-bottom:14px}
    .brand .logo{width:28px;height:28px;border-radius:8px;border:2px solid var(--primary);display:flex;align-items:center;justify-content:center;color:var(--primary)}
    .nav{display:flex;flex-direction:column;gap:8px}
    .nav a{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:10px;color:#394150;text-decoration:none;border:1px solid var(--border)}
    .nav a:hover{background:#f7f7fb}
    .nav a.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .main{display:flex;flex-direction:column;gap:14px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(31,36,48,0.08);padding:16px}
    .table-toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .search{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 12px}
    .search input{border:none;outline:none;flex:1}
    .table-pro{width:100%;border-collapse:separate;border-spacing:0}
    .table-pro thead th{background:#f7f7fb;color:#394150;font-weight:600;padding:12px;border-bottom:1px solid var(--border);font-size:13px}
    .table-pro tbody td{padding:12px;border-bottom:1px solid #f0f2f6;color:#2f3443;font-size:13px}
    .table-pro tbody tr:hover{background:#fafbff}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600}
    .badge-success{background:var(--success-bg);color:var(--success);border:1px solid #cbead7}
    .badge-warning{background:var(--warning-bg);color:var(--warning);border:1px solid #ffe0b2}
    .muted{color:var(--muted)}
    .page-title{font-size:22px;font-weight:700;color:var(--text);margin:0 0 4px 0}
    .page-subtitle{color:var(--muted);margin:0;font-size:14px}
    .btn-view{background:var(--primary);color:#fff;border:none;border-radius:8px;padding:6px 12px;font-size:12px;cursor:pointer;font-weight:600;transition:all 0.2s}
    .btn-view:hover{background:#5a4fd1;transform:translateY(-1px)}
    .btn-edit{background:#ff9800;color:#fff;border:none;border-radius:8px;padding:6px 12px;font-size:12px;cursor:pointer;font-weight:600;margin-left:6px}
    .btn-edit:hover{background:#f57c00}
    .btn-save{background:#1e7d44;color:#fff;border:none;border-radius:8px;padding:8px 16px;font-size:13px;cursor:pointer;font-weight:600}
    .btn-save:hover{background:#166534}
    .btn-cancel{background:#6c757d;color:#fff;border:none;border-radius:8px;padding:8px 16px;font-size:13px;cursor:pointer;font-weight:600;margin-left:8px}
    .btn-skyquest{background:#00b894;color:#fff;border:none;border-radius:8px;padding:6px 10px;font-size:11px;cursor:pointer;font-weight:600;margin-left:6px}
    .btn-skyquest:hover{background:#00a085}
    .btn-skyquest:disabled{background:#95a5a6;cursor:not-allowed}
    .edit-input{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;margin-top:4px}
    .edit-textarea{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;margin-top:4px;min-height:100px;resize:vertical}
    .form-group{margin-bottom:16px}
    .form-label{font-size:12px;font-weight:600;color:var(--muted);margin-bottom:4px;display:block}
  </style>
  <div class="page-chrome">
    <div class="admin-layout">
      <aside class="sidebar" aria-label="Admin navigation">
        <div class="brand"><div class="logo">‚¨¢</div> Dashboard <span class="muted">v0.1</span></div>
        <nav class="nav" id="adminNav">
          <a href="/auth/admin">Dashboard</a>
          <a href="/auth/admin/researchers">Researchers</a>
          <a href="/auth/admin/submissions" class="active">Submissions</a>
          <a href="/tool">Research Tool</a>
          <a href="/auth/logout">Logout</a>
        </nav>
      </aside>

      <main class="main">
        <div class="card">
          <h2 class="page-title">All Submissions</h2>
          <p class="page-subtitle">Complete RD submission data with all details</p>
        </div>

        <div class="card">
          <div class="table-toolbar">
            <div style="font-size:14px;font-weight:600;color:var(--muted)">{{ submissions|length }} Total Submissions</div>
            <div class="search"><span class="muted">üîç</span><input id="searchBox" type="text" placeholder="Search market name..." /></div>
          </div>

          <table class="table-pro">
            <thead>
              <tr>
                <th>Market</th>
                <th>Researcher</th>
                <th>Submitted</th>
                <th>Sector</th>
                <th>Industry</th>
                <th>CAGR</th>
                <th>Size 2024</th>
                <th>Size 2033</th>
                <th>Segments</th>
                <th>Companies</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for s in submissions %}
              <tr data-market="{{ (s.market_name or '')|lower }}">
                <td style="font-weight:600">{{ s.market_name or '‚Äî' }}</td>
                <td>{{ s.researcher_username }}</td>
                <td>
                  {% if s.submitted_at %}
                    <span class="ts">{{ s.submitted_at }}</span>
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>
                <td>{{ s.sector or '‚Äî' }}</td>
                <td>{{ s.industry or '‚Äî' }}</td>
                <td>{{ s.cagr or '‚Äî' }}%</td>
                <td>{{ s.market_size_2024 or '‚Äî' }} {{ s.value_unit or '' }}</td>
                <td>{{ s.projected_size_2033 or '‚Äî' }} {{ s.value_unit or '' }}</td>
                <td>{{ s.segments|length }}</td>
                <td>{{ s.companies|length }}</td>
                <td>
                  {% if s.downloaded %}
                    <span class="badge badge-success">Downloaded</span>
                  {% else %}
                    <span class="badge badge-warning">Pending</span>
                  {% endif %}
                </td>
                <td>
                  <button class="btn-view" data-id="{{ s.id }}">View</button>
                  <button class="btn-skyquest" data-id="{{ s.id }}" data-name="{{ s.market_name }}">Submit</button>
                </td>
              </tr>
              {% endfor %}
              {% if not submissions %}
                <tr><td colspan="12" class="muted">No submissions yet</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </main>
    </div>
  </div>

  <!-- Detail/Edit Modal -->
  <div id="detailModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;padding:20px">
    <div style="background:#fff;border-radius:16px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
      <div style="padding:24px;border-bottom:1px solid #e6e9f0;display:flex;align-items:center;justify-content:space-between">
        <h3 id="modalTitle" style="margin:0;font-size:20px;font-weight:700;color:#1f2430"></h3>
        <div>
          <button id="editBtn" class="btn-edit">‚úèÔ∏è Edit</button>
          <button id="closeModal" style="background:transparent;border:none;font-size:24px;cursor:pointer;color:#52596b;margin-left:8px">&times;</button>
        </div>
      </div>
      <div id="modalContent" style="padding:24px"></div>
    </div>
  </div>

  <script>
    let currentSubmission = null;
    let isEditMode = false;
    const submissions = {{ submissions|tojson }};

    // Active tab highlighting
    (function(){
      const nav = document.getElementById('adminNav');
      if(!nav) return;
      const links = Array.from(nav.querySelectorAll('a'));
      links.forEach(l => l.classList.remove('active'));
      const target = links.find(l => l.getAttribute('href') === '/auth/admin/submissions');
      if(target) target.classList.add('active');
    })();

    // Search functionality
    const searchBox = document.getElementById('searchBox');
    const rows = Array.from(document.querySelectorAll('tbody tr'));
    if (searchBox) {
      searchBox.addEventListener('input', () => {
        const term = searchBox.value.toLowerCase();
        rows.forEach(row => {
          const market = row.dataset.market || '';
          row.style.display = market.includes(term) ? '' : 'none';
        });
      });
    }

    // Timestamp formatting
    Array.from(document.querySelectorAll('span.ts')).forEach(el => {
      const iso = el.textContent.trim();
      if (!iso) return;
      const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})[T\s](\d{2}):(\d{2})/);
      if (m) {
        const [,y,mo,d,h,mi] = m;
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        el.textContent = `${d} ${months[parseInt(mo,10)-1]} ${y}, ${h}:${mi}`;
      }
    });

    // Modal elements
    const modal = document.getElementById('detailModal');
    const closeBtn = document.getElementById('closeModal');
    const editBtn = document.getElementById('editBtn');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');

    function renderViewMode(sub) {
      return `
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:24px">
          <div>
            <div style="font-size:12px;font-weight:600;color:#7a8aa0;margin-bottom:4px">Researcher</div>
            <div style="font-size:14px;color:#1f2430">${sub.researcher_username}</div>
          </div>
          <div>
            <div style="font-size:12px;font-weight:600;color:#7a8aa0;margin-bottom:4px">Created By</div>
            <div style="font-size:14px;color:#1f2430">${sub.created_by || '‚Äî'}</div>
          </div>
        </div>

        <div style="margin-bottom:24px">
          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 12px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Industry Classification</h4>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
            <div><span style="font-size:12px;color:#7a8aa0">Sector:</span> <span style="font-size:13px;color:#1f2430">${sub.sector || '‚Äî'}</span></div>
            <div><span style="font-size:12px;color:#7a8aa0">Industry Group:</span> <span style="font-size:13px;color:#1f2430">${sub.industry_group || '‚Äî'}</span></div>
            <div><span style="font-size:12px;color:#7a8aa0">Industry:</span> <span style="font-size:13px;color:#1f2430">${sub.industry || '‚Äî'}</span></div>
            <div><span style="font-size:12px;color:#7a8aa0">Sub-Industry:</span> <span style="font-size:13px;color:#1f2430">${sub.sub_industry || '‚Äî'}</span></div>
          </div>
        </div>

        <div style="margin-bottom:24px">
          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 12px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Market Inputs</h4>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
            <div><span style="font-size:12px;color:#7a8aa0">CAGR:</span> <span style="font-size:13px;color:#1f2430;font-weight:600">${sub.cagr || '‚Äî'}%</span></div>
            <div><span style="font-size:12px;color:#7a8aa0">Unit:</span> <span style="font-size:13px;color:#1f2430">${sub.value_unit || '‚Äî'}</span></div>
            <div><span style="font-size:12px;color:#7a8aa0">Size 2024:</span> <span style="font-size:13px;color:#1f2430;font-weight:600">${sub.market_size_2024 || '‚Äî'}</span></div>
            <div><span style="font-size:12px;color:#7a8aa0">Size 2025:</span> <span style="font-size:13px;color:#1f2430">${sub.market_size_2025 || '‚Äî'}</span></div>
            <div><span style="font-size:12px;color:#7a8aa0">Projected 2033:</span> <span style="font-size:13px;color:#1f2430;font-weight:600">${sub.projected_size_2033 || '‚Äî'}</span></div>
          </div>
        </div>

        <div style="margin-bottom:24px">
          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 12px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Segments (${(sub.segments || []).length})</h4>
          <div style="max-height:200px;overflow-y:auto;background:#f8f9fc;padding:12px;border-radius:8px">
            ${(sub.segments || []).map(s => `<div style="font-size:13px;color:#1f2430;padding:4px 0">${s}</div>`).join('') || '<div class="muted">No segments</div>'}
          </div>
        </div>

        <div style="margin-bottom:24px">
          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 12px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">AI Generated Segments (${(sub.ai_gen_seg || []).length})</h4>
          <div style="max-height:200px;overflow-y:auto;background:#f8f9fc;padding:12px;border-radius:8px">
            ${(sub.ai_gen_seg || []).map(s => `<div style="font-size:13px;color:#1f2430;padding:4px 0">${s}</div>`).join('') || '<div class="muted">No AI segments</div>'}
          </div>
        </div>

        <div>
          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 12px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Companies (${(sub.companies || []).length})</h4>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
            ${(sub.companies || []).map(c => `<div style="font-size:13px;color:#1f2430;padding:6px;background:#f8f9fc;border-radius:6px">${c}</div>`).join('') || '<div class="muted">No companies</div>'}
          </div>
        </div>
      `;
    }

    function renderEditMode(sub) {
      return `
        <form id="editForm">
          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 16px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Industry Classification</h4>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:24px">
            <div class="form-group">
              <label class="form-label">Sector</label>
              <input type="text" class="edit-input" name="sector" value="${sub.sector || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Industry Group</label>
              <input type="text" class="edit-input" name="industry_group" value="${sub.industry_group || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Industry</label>
              <input type="text" class="edit-input" name="industry" value="${sub.industry || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Sub-Industry</label>
              <input type="text" class="edit-input" name="sub_industry" value="${sub.sub_industry || ''}">
            </div>
          </div>

          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 16px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Market Inputs</h4>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:24px">
            <div class="form-group">
              <label class="form-label">CAGR (%)</label>
              <input type="text" class="edit-input" name="cagr" value="${sub.cagr || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Value Unit</label>
              <input type="text" class="edit-input" name="value_unit" value="${sub.value_unit || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Market Size 2024</label>
              <input type="text" class="edit-input" name="market_size_2024" value="${sub.market_size_2024 || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Market Size 2025</label>
              <input type="text" class="edit-input" name="market_size_2025" value="${sub.market_size_2025 || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Projected Size 2033</label>
              <input type="text" class="edit-input" name="projected_size_2033" value="${sub.projected_size_2033 || ''}">
            </div>
          </div>

          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 16px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Segments</h4>
          <div class="form-group" style="margin-bottom:24px">
            <label class="form-label">Segments (one per line)</label>
            <textarea class="edit-textarea" name="segments">${(sub.segments || []).join('\n')}</textarea>
          </div>

          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 16px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">AI Generated Segments</h4>
          <div class="form-group" style="margin-bottom:24px">
            <label class="form-label">AI Segments (one per line)</label>
            <textarea class="edit-textarea" name="ai_gen_seg">${(sub.ai_gen_seg || []).join('\n')}</textarea>
          </div>

          <h4 style="font-size:14px;font-weight:700;color:#1f2430;margin:0 0 16px 0;padding-bottom:8px;border-bottom:2px solid #e6e9f0">Companies</h4>
          <div class="form-group" style="margin-bottom:24px">
            <label class="form-label">Companies (one per line)</label>
            <textarea class="edit-textarea" name="companies">${(sub.companies || []).join('\n')}</textarea>
          </div>

          <div style="display:flex;justify-content:flex-end;padding-top:16px;border-top:1px solid #e6e9f0">
            <button type="button" class="btn-cancel" id="cancelEditBtn">Cancel</button>
            <button type="submit" class="btn-save" style="margin-left:8px">üíæ Save Changes</button>
          </div>
        </form>
      `;
    }

    function showModal(sub, editMode = false) {
      currentSubmission = sub;
      isEditMode = editMode;
      modalTitle.textContent = sub.market_name || 'Submission Details';
      editBtn.style.display = editMode ? 'none' : 'inline-block';
      
      if (editMode) {
        modalContent.innerHTML = renderEditMode(sub);
        // Attach form submit handler
        document.getElementById('editForm').addEventListener('submit', handleSave);
        document.getElementById('cancelEditBtn').addEventListener('click', () => showModal(sub, false));
      } else {
        modalContent.innerHTML = renderViewMode(sub);
      }
      
      modal.style.display = 'flex';
    }

    async function handleSave(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      
      const payload = {
        id: currentSubmission.id,
        sector: formData.get('sector'),
        industry_group: formData.get('industry_group'),
        industry: formData.get('industry'),
        sub_industry: formData.get('sub_industry'),
        cagr: formData.get('cagr'),
        value_unit: formData.get('value_unit'),
        market_size_2024: formData.get('market_size_2024'),
        market_size_2025: formData.get('market_size_2025'),
        projected_size_2033: formData.get('projected_size_2033'),
        segments: formData.get('segments').split('\n').map(s => s.trim()).filter(s => s),
        ai_gen_seg: formData.get('ai_gen_seg').split('\n').map(s => s.trim()).filter(s => s),
        companies: formData.get('companies').split('\n').map(s => s.trim()).filter(s => s)
      };

      try {
        const res = await fetch('/api/update-submission', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        
        if (data.success) {
          alert('‚úÖ Submission updated successfully!');
          // Update local data and refresh view
          Object.assign(currentSubmission, payload);
          showModal(currentSubmission, false);
          // Reload page to reflect changes in table
          setTimeout(() => location.reload(), 500);
        } else {
          alert('‚ùå Error: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }

    // View button click
    document.querySelectorAll('.btn-view').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = parseInt(btn.dataset.id);
        const sub = submissions.find(s => s.id === id);
        if (sub) showModal(sub, false);
      });
    });

    // Edit button click
    editBtn.addEventListener('click', () => {
      if (currentSubmission) showModal(currentSubmission, true);
    });

    // Close modal
    closeBtn.addEventListener('click', () => { modal.style.display = 'none'; });
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

    // SkyQuest Submit Handler
    document.querySelectorAll('.btn-skyquest').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const name = btn.dataset.name;
        
        const confirmMsg = 'Submit "' + name + '" to SkyQuest?\n\n' +
          'This will:\n' +
          '1. Generate DOCX report (~10 min)\n' +
          '2. Generate image (~1-2 min)\n' +
          '3. Generate Excel (~2 min)\n' +
          '4. Upload all files to SkyQuest\n\n' +
          'Total time: ~15 minutes. Do not close this page.';
        
        if (!confirm(confirmMsg)) return;
        
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = 'Processing...';
        
        try {
          const res = await fetch('/api/submit-to-skyquest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ submission_id: id })
          });
          const data = await res.json();
          
          if (data.success) {
            alert('Success: ' + data.message);
            location.reload();
          } else {
            alert('Error: ' + (data.error || 'Unknown error'));
          }
        } catch (err) {
          alert('Error: ' + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });
    });
  </script>
{% endblock %}
