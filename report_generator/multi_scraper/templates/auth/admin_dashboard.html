{% extends 'auth/base.html' %}
{% block content %}
  <style>
    .stats-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    .stat-card{position:relative;overflow:hidden;display:flex;flex-direction:column;justify-content:space-between;border:1px solid rgba(108,92,231,0.08);transition:all 0.25s}
    .stat-card:hover{transform:translateY(-3px);box-shadow:0 16px 40px rgba(108,92,231,0.12)}
    .stat-card::before{content:"";position:absolute;top:0;left:0;right:0;height:3px;background:var(--stat-color,var(--primary))}
    .stat-card.s-red{--stat-color:#ff6b6b}.stat-card.s-amber{--stat-color:#f59e0b}.stat-card.s-purple{--stat-color:#6C5CE7}.stat-card.s-green{--stat-color:#10b981}
    .stat-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
    .stat-title{color:var(--muted);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin:0}
    .stat-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;background:#f7f7fb}
    .stat-main{display:flex;align-items:baseline;gap:4px;margin-bottom:10px}
    .stat-number{font-size:34px;font-weight:800;color:var(--text);line-height:1}
    .stat-unit{color:var(--muted);font-size:13px;font-weight:500;margin-left:4px}
    .stat-footer{display:flex;justify-content:space-between;align-items:center;padding-top:8px;border-top:1px solid rgba(0,0,0,0.05)}
    .stat-trend{font-size:12px;font-weight:600;color:#10b981}
    .stat-context{font-size:11px;color:var(--muted)}
    .stat-bar{height:3px;background:#f0f2f6;border-radius:999px;overflow:hidden;margin-top:8px}
    .stat-bar-fill{height:100%;background:var(--stat-color,var(--primary));border-radius:999px;transition:width 0.6s ease-out}
    .sort-row{display:flex;align-items:center;gap:8px}
    .sort-row select{padding:7px 10px;border:1.5px solid var(--border);border-radius:9px;font-size:13px;background:#fff}
    @media(max-width:900px){.stats-4{grid-template-columns:repeat(2,1fr)}}
  </style>
<div class="app-layout">
  <aside class="sidebar">
    <div class="sidebar-brand"><div class="logo-icon">SQ</div> Admin</div>
    <nav class="sidebar-nav">
      <a href="/auth/admin" class="active"><span class="nav-icon">üè†</span> Dashboard</a>
      <a href="/auth/admin/researchers"><span class="nav-icon">üë•</span> Researchers</a>
      <a href="/auth/admin/submissions"><span class="nav-icon">üìã</span> Submissions</a>
      <a href="/auth/admin/analytics"><span class="nav-icon">üìä</span> Analytics</a>
      <a href="/tool"><span class="nav-icon">üî¨</span> Research Tool</a>
      <hr class="sidebar-divider">
      <a href="/auth/profile"><span class="nav-icon">üë§</span> Profile</a>
      <a href="/auth/logout"><span class="nav-icon">üö™</span> Logout</a>
    </nav>
  </aside>

  <main class="main-content">
    <div class="hero-card">
      <h3>Hello, {{ session.username }} üëã</h3>
      <p>Welcome to the admin dashboard. Manage researchers and submissions below.</p>
    </div>

    <div class="stats-4">
          <div class="card stat-card s-red">
            <div class="stat-header">
              <h4 class="stat-title">Total Submissions</h4>
              <div class="stat-icon">üìã</div>
            </div>
            <div class="stat-main">
              <span class="stat-number">{{ total_submissions }}</span>
            </div>
            <div class="stat-footer">
              <div class="stat-trend positive">
                <span>‚Üë 12%</span>
              </div>
              <div class="stat-context">vs last month</div>
            </div>
            <div class="stat-bar">
              <div class="stat-bar-fill" style="width: 75%"></div>
            </div>
          </div>

          <div class="card stat-card s-amber">
            <div class="stat-header">
              <h4 class="stat-title">Today's Submissions</h4>
              <div class="stat-icon">üìÖ</div>
            </div>
            <div class="stat-main">
              <span class="stat-number">{{ today_submissions }}</span>
              <span class="stat-unit">today</span>
            </div>
            <div class="stat-footer">
              <div class="stat-trend neutral">
                <span>üìä Daily</span>
              </div>
              <div class="stat-context">saved today</div>
            </div>
            <div class="stat-bar">
              <div class="stat-bar-fill" style="width: {% if total_submissions > 0 %}{{ (today_submissions / total_submissions * 100)|int }}{% else %}0{% endif %}%"></div>
            </div>
          </div>

          <div class="card stat-card s-purple">
            <div class="stat-header">
              <h4 class="stat-title">Researchers</h4>
              <div class="stat-icon">üë•</div>
            </div>
            <div class="stat-main">
              <span class="stat-number">{{ researchers_count }}</span>
              <span class="stat-unit">active</span>
            </div>
            <div class="stat-footer">
              <div class="stat-trend neutral">
                <span>‚Üí 0%</span>
              </div>
              <div class="stat-context">this month</div>
            </div>
            <div class="stat-bar">
              <div class="stat-bar-fill" style="width: 68%"></div>
            </div>
          </div>

          <div class="card stat-card s-green">
            <div class="stat-header">
              <h4 class="stat-title">Active Now</h4>
              <div class="stat-icon">üî¥</div>
            </div>
            <div class="stat-main">
              <span class="stat-number">{{ active_researchers_today }}</span>
              <span class="stat-unit">online</span>
            </div>
            <div class="stat-footer">
              <div class="stat-trend positive">
                <span>üü¢ Live</span>
              </div>
              <div class="stat-context">last 24h</div>
            </div>
            <div class="stat-bar">
              <div class="stat-bar-fill" style="width: 85%"></div>
            </div>
          </div>
    </div>

    <div class="card" id="submissionsSection">
      <div class="card-header">
        <h4 class="card-title">Recent Submissions</h4>
        <a href="/auth/admin/submissions" class="btn btn-primary btn-sm">View All ‚Üí</a>
      </div>
      <div class="table-toolbar">
        <div class="search-box"><span class="muted">üîç</span><input id="adminSearch" type="text" placeholder="Search researcher or market‚Ä¶"></div>
        <div class="sort-row">
          <span class="muted text-sm">Filter:</span>
          <select id="adminStatus">
            <option value="">All</option>
            <option value="pending">Pending</option>
            <option value="uploaded">Uploaded</option>
            <option value="downloaded">Downloaded</option>
          </select>
        </div>
      </div>
          <table class="table-pro" id="adminTable">
            <thead>
              <tr>
                <th>Researcher</th>
                <th>Market Name</th>
                <th>Submitted At</th>
                <th>Market Value (2024)</th>
                <th>CAGR</th>
                <th>Segments</th>
                <th>Companies</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for s in submissions %}
                <tr data-r="{{ s.researcher_username|lower }}" data-m="{{ (s.market_name or '')|lower }}" data-status="{% if s.downloaded == 1 %}uploaded{% elif s.downloaded %}downloaded{% else %}pending{% endif %}">
                  <td style="font-weight:600">{{ s.researcher_username }}</td>
                  <td>{{ s.market_name or '‚Äî' }}</td>
                  <td>{{ s.submitted_at|fmt_ts }}</td>
                  <td>{{ s.value_2024 or '‚Äî' }} {{ s.currency or '' }}</td>
                  <td>{{ s.cagr or '‚Äî' }}%</td>
                  <td>{{ s.segment_count or 0 }}</td>
                  <td>{{ s.company_count or 0 }}</td>
                  <td>
                    {% if s.downloaded == 1 %}
                      <span class="badge badge-success">Uploaded</span>
                    {% elif s.downloaded %}
                      <span class="badge badge-success">Downloaded</span>
                    {% else %}
                      <span class="badge badge-warning">Pending</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
              {% if not submissions %}
                <tr><td colspan="8" class="muted">No submissions yet</td></tr>
              {% endif %}
            </tbody>
          </table>
    </div>

    <div class="card" id="marketsSection">
      <div class="card-header">
        <h4 class="card-title">Users</h4>
        <a href="{{ url_for('admin_create_user') }}" class="btn btn-primary btn-sm">+ Create User</a>
      </div>
          <table class="table-pro" style="margin-top:8px">
            <thead>
              <tr><th>Username</th><th>Role</th><th>Created By</th><th>Created At</th><th>Last Login</th><th>Actions</th></tr>
            </thead>
            <tbody>
              {% for u in users %}
                <tr>
                  <td style="font-weight:600">{{ u['username'] }}</td>
                  <td>{{ u['role'] }}</td>
                  <td>{{ u['created_by'] or '‚Äî' }}</td>
                  <td>{{ u['created_at']|fmt_ts }}</td>
                  <td>{{ u['last_login']|fmt_ts }}</td>
                  <td>
                    <button class="btn-change-pwd" data-username="{{ u['username'] }}" style="background:#6C5CE7;color:#fff;border:none;border-radius:8px;padding:6px 10px;cursor:pointer;margin-right:6px">Password</button>
                    <button class="btn-delete-user" data-username="{{ u['username'] }}" data-role="{{ u['role'] }}" {% if u['role'] == 'admin' or u['username'] == session.username %}disabled title="Cannot delete admin or yourself"{% endif %} style="background:#e74c3c;color:#fff;border:none;border-radius:8px;padding:6px 10px;cursor:pointer">Delete</button>
                  </td>
                </tr>
              {% endfor %}
              {% if not users %}
                <tr><td colspan="6" class="muted">No users found</td></tr>
              {% endif %}
            </tbody>
          </table>
    </div>
  </main>
</div>

  <script>
    // Admin: Delete user client-side
    (function(){
      function bindDeleteButtons(){
        const buttons = Array.from(document.querySelectorAll('.btn-delete-user'));
        buttons.forEach(btn => {
          if(btn.__bound) return; // avoid double-binding
          btn.__bound = true;
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            if(btn.disabled) return;
            const username = btn.dataset.username;
            const role = btn.dataset.role;
            if(!username) return;
            const ok = window.confirm(`Delete user "${username}"? This cannot be undone.`);
            if(!ok) return;
            btn.disabled = true; btn.textContent = 'Deleting‚Ä¶';
            try{
              const res = await fetch('/auth/admin/delete_user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
              });
              const data = await res.json().catch(()=>({ status:'error', error:'Invalid response'}));
              if(res.ok && data && (data.ok === true || data.status === 'ok')){
                const row = btn.closest('tr');
                if(row) row.remove();
              } else {
                const msg = (data && (data.error||data.message)) || 'Delete failed';
                alert(msg);
                btn.disabled = (role === 'admin');
                btn.textContent = 'Delete';
              }
            }catch(err){
              console.error('delete user failed', err);
              alert('Network error while deleting user');
              btn.disabled = (role === 'admin');
              btn.textContent = 'Delete';
            }
          });
        });
      }
      // Bind once DOM is ready
      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', bindDeleteButtons);
      } else {
        bindDeleteButtons();
      }
    })();
  </script>

  <script>
    // Simple search/filter for submissions
    (function(){
      const q = document.getElementById('adminSearch');
      const status = document.getElementById('adminStatus');
      const rows = Array.from(document.querySelectorAll('#adminTable tbody tr'));
      function apply(){
        const term = (q && q.value||'').trim().toLowerCase();
        const st = (status && status.value||'').trim();
        rows.forEach(r=>{
          const match = (!term || r.dataset.r.includes(term) || r.dataset.c.includes(term) || r.dataset.m.includes(term));
          const stOk = (!st || r.dataset.status === st);
          r.style.display = (match && stOk) ? '' : 'none';
        });
      }
      q && q.addEventListener('input', apply);
      status && status.addEventListener('change', apply);
    })();
  </script>
  
  <!-- Chatbar: Admin <-> Researcher selector -->
  <style>
    .chatbar{position:fixed;right:18px;bottom:78px;width:360px;background:#fff;border:1px solid #e6e9f0;border-radius:14px;box-shadow:0 12px 32px rgba(31,36,48,0.14);display:none;flex-direction:column;overflow:hidden;z-index:1000}
    .chatbar.open{display:flex}
    .chatbar header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#6C5CE7;color:#fff;gap:8px}
    .chatbar .messages{max-height:280px;overflow:auto;padding:10px;background:#f7f7fb}
    .msg{display:flex;margin-bottom:8px}
    .msg .bubble{padding:8px 10px;border-radius:12px;max-width:75%}
    .msg.me{justify-content:flex-end}
    .msg.me .bubble{background:#6C5CE7;color:#fff;border-top-right-radius:4px}
    .msg.other .bubble{background:#fff;border:1px solid #e6e9f0;color:#1f2430;border-top-left-radius:4px}
    .chatbar form{display:flex;gap:8px;padding:10px;background:#fff;border-top:1px solid #e6e9f0}
    .chatbar input{flex:1;border:1px solid #e6e9f0;border-radius:10px;padding:8px 10px}
    .chatbar button{background:#6C5CE7;color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
    .chatbar .close{background:transparent;color:#fff;border:none;font-size:18px;line-height:18px;padding:0 6px}
    .chatbar select{border:1px solid rgba(255,255,255,0.6);background:rgba(255,255,255,0.25);color:#fff;border-radius:8px;padding:6px 8px}
    /* Floating action button */
    .chat-fab{position:fixed;right:18px;bottom:18px;width:52px;height:52px;border-radius:50%;background:#6C5CE7;color:#fff;display:flex;align-items:center;justify-content:center;border:none;box-shadow:0 8px 20px rgba(108,92,231,0.35);cursor:pointer;z-index:1001;font-size:22px}
    .chat-fab:hover{filter:brightness(1.05)}
  </style>
  <div class="chatbar" id="chatbar-admin" aria-hidden="true">
    <header>
      <span>Chat with User</span>
      <select id="chatTarget">
        {% for u in users %}
          {% if u.role != 'admin' %}
            <option value="{{ u.username }}">{{ u.username }}{% if u.role %} ({{ u.role }}){% endif %}</option>
          {% endif %}
        {% endfor %}
      </select>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="chatRefreshAdmin" style="background:rgba(255,255,255,0.2);color:#fff;border:none;border-radius:8px;padding:4px 8px;cursor:pointer">Refresh</button>
        <button id="chatCloseAdmin" class="close" aria-label="Close">√ó</button>
      </div>
    </header>
    <div class="messages" id="chatMessagesAdmin" aria-live="polite"></div>
    <form id="chatFormAdmin" autocomplete="off">
      <input type="text" id="chatInputAdmin" placeholder="Type a message" required />
      <button type="submit">Send</button>
    </form>
  </div>
  <button id="chatFabAdmin" class="chat-fab" aria-label="Open chat">üí¨</button>

  <script>
    (function(){
      const me = "{{ session.username }}";
      const targetSel = document.getElementById('chatTarget');
      const list = document.getElementById('chatMessagesAdmin');
      const input = document.getElementById('chatInputAdmin');
      const form = document.getElementById('chatFormAdmin');
      const refreshBtn = document.getElementById('chatRefreshAdmin');
      const chatbar = document.getElementById('chatbar-admin');
      const chatFab = document.getElementById('chatFabAdmin');
      const chatClose = document.getElementById('chatCloseAdmin');
      let pollTimer = null;
      function other(){ return (targetSel && targetSel.value) || ''; }
      function render(messages){
        list.innerHTML = '';
        messages.forEach(m => {
          const div = document.createElement('div');
          div.className = 'msg ' + (m.from_username === me ? 'me' : 'other');
          const bubble = document.createElement('div');
          bubble.className = 'bubble';
          // format: dd mon yyyy HH:MM
          function fmtIso(ts){
            const s = (ts || '').trim();
            const m = s.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})/);
            if(!m) return s.slice(0,16).replace('T',' ');
            const months = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
            const y = m[1], mo = parseInt(m[2],10), d = m[3], hh = m[4], mm = m[5];
            return `${d} ${months[mo-1]} ${y} ${hh}:${mm}`;
          }
          const when = fmtIso(m.sent_at);
          bubble.textContent = m.content + '  \u00b7 ' + when;
          div.appendChild(bubble);
          list.appendChild(div);
        });
        list.scrollTop = list.scrollHeight;
      }
      async function fetchMessages(){
        const o = other(); if(!o) { list.innerHTML = '<div class="muted">No researcher selected</div>'; return; }
        try{
          const res = await fetch(`/api/chat/messages?with=${encodeURIComponent(o)}&limit=200`);
          const data = await res.json();
          if(data && Array.isArray(data.messages)) render(data.messages);
        }catch(e){ console.warn('chat fetch failed', e); }
      }
      async function sendMessage(text){
        const o = other(); if(!o) return;
        try{
          await fetch('/api/chat/send', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ to: o, content: text }) });
          input.value = '';
          fetchMessages();
        }catch(e){ console.warn('chat send failed', e); }
      }
      form.addEventListener('submit', (ev)=>{ ev.preventDefault(); const t = input.value.trim(); if(t) sendMessage(t); });
      refreshBtn.addEventListener('click', fetchMessages);
      targetSel && targetSel.addEventListener('change', fetchMessages);
      function openChat(){
        chatbar.classList.add('open');
        chatbar.setAttribute('aria-hidden','false');
        fetchMessages();
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(fetchMessages, 2500);
        setTimeout(()=>input.focus(),10);
      }
      function closeChat(){
        chatbar.classList.remove('open');
        chatbar.setAttribute('aria-hidden','true');
        if (pollTimer){ clearInterval(pollTimer); pollTimer = null; }
      }
      chatFab.addEventListener('click', openChat);
      chatClose.addEventListener('click', closeChat);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeChat(); });
    })();
  </script>

  <!-- Password Change Modal -->
  <div id="pwdModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2000;align-items:center;justify-content:center">
    <div style="background:#fff;border-radius:14px;padding:24px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
      <h3 style="margin:0 0 16px 0;color:#1f2430">Change Password</h3>
      <p style="margin:0 0 16px 0;color:#7a8aa0;font-size:14px">Changing password for: <strong id="pwdUsername"></strong></p>
      <form id="pwdForm">
        <input type="hidden" id="pwdTargetUser" />
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:12px;font-weight:600;color:#7a8aa0;margin-bottom:6px">New Password</label>
          <input type="password" id="pwdNewPassword" required minlength="4" style="width:100%;padding:10px 12px;border:1px solid #e6e9f0;border-radius:8px;font-size:14px" placeholder="Enter new password" />
        </div>
        <div style="margin-bottom:16px">
          <label style="display:block;font-size:12px;font-weight:600;color:#7a8aa0;margin-bottom:6px">Confirm Password</label>
          <input type="password" id="pwdConfirmPassword" required minlength="4" style="width:100%;padding:10px 12px;border:1px solid #e6e9f0;border-radius:8px;font-size:14px" placeholder="Confirm new password" />
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button type="button" id="pwdCancel" style="background:#6c757d;color:#fff;border:none;border-radius:8px;padding:10px 16px;cursor:pointer">Cancel</button>
          <button type="submit" style="background:#6C5CE7;color:#fff;border:none;border-radius:8px;padding:10px 16px;cursor:pointer;font-weight:600">Save Password</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Password Change Modal
    (function(){
      const modal = document.getElementById('pwdModal');
      const form = document.getElementById('pwdForm');
      const targetInput = document.getElementById('pwdTargetUser');
      const usernameDisplay = document.getElementById('pwdUsername');
      const newPwdInput = document.getElementById('pwdNewPassword');
      const confirmPwdInput = document.getElementById('pwdConfirmPassword');
      const cancelBtn = document.getElementById('pwdCancel');

      function openModal(username){
        targetInput.value = username;
        usernameDisplay.textContent = username;
        newPwdInput.value = '';
        confirmPwdInput.value = '';
        modal.style.display = 'flex';
        setTimeout(() => newPwdInput.focus(), 100);
      }

      function closeModal(){
        modal.style.display = 'none';
      }

      // Bind change password buttons
      document.querySelectorAll('.btn-change-pwd').forEach(btn => {
        btn.addEventListener('click', () => openModal(btn.dataset.username));
      });

      cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });
      document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeModal(); });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = targetInput.value;
        const newPassword = newPwdInput.value;
        const confirmPassword = confirmPwdInput.value;

        if(newPassword !== confirmPassword){
          alert('Passwords do not match!');
          return;
        }

        if(newPassword.length < 4){
          alert('Password must be at least 4 characters!');
          return;
        }

        try{
          const res = await fetch('/auth/admin/change_password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, new_password: newPassword })
          });
          const data = await res.json();
          if(res.ok && data.status === 'ok'){
            alert('Password changed successfully!');
            closeModal();
          } else {
            alert('Error: ' + (data.error || 'Failed to change password'));
          }
        } catch(err){
          alert('Network error: ' + err.message);
        }
      });
    })();
  </script>
{% endblock %}
