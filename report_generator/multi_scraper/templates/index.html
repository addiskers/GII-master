<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Research Automation</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;800&family=Inter:wght@400;600;700&family=Segoe+UI:wght@400;600&display=swap">
    <style>
        :root {
            --primary: #6014FA;
            --surface: #F8F8F8;
            --white: #FFFFFF;
            --border: #E5E5E5;
            --text-primary: #2C2C2C;
            --text-secondary: #737373;
            --text-muted: #6B7280;
            --shadow: rgba(0, 0, 0, 0.05);
            --shadow-button: rgba(0, 0, 0, 0.10);
            --background-close: #F2F2F2;
            --close-text: #464646;
            --success: #10B981;
            --error: #EF4444;
            --warning: #F59E0B;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(0deg, var(--surface) 0%, var(--surface) 100%);
            overflow: hidden;
        }
        .automation-app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }
        .header {
            width: 100%;
            min-height: 96px;
            background: linear-gradient(90deg, var(--white) 0%, #f9f9ff 100%);
            box-shadow: 0 2px 10px var(--shadow);
            border: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            z-index: 100;
        }
        .header-content {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            position: relative;
            gap: 12px;
        }
        .logo-section {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }
        .logo-icon {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 8px;
            position: relative;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(96, 20, 250, 0.2);
        }
        .logo-graphics {
            position: relative;
            width: 34px;
            height: 21px;
            font-size: 1.5rem;
            font-weight: 800;
            font-family: 'Poppins', sans-serif;
            display: flex;
            align-items: center;
            transform: rotate(0deg);
        }
        .logo-graphics span {
            background: white;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            line-height: 1;
        }
        .logo-graphics .s {
            margin-right: -8%;
            z-index: 1;
        }
        .logo-graphics .q {
            z-index: 2;
        }
        .brand-text {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 4px;
            min-width: 0;
            flex: 1;
        }
        .brand-title {
            color: var(--primary);
            font-family: 'Poppins', sans-serif;
            font-size: 18px;
            font-weight: 700;
            line-height: 1.2;
            margin: 0;
        }
        .brand-subtitle {
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .name-tag {
            display: inline-flex;
            align-items: center;
            padding: 2px 9px;
            border-radius: 999px;
            font-family: 'Poppins', sans-serif;
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
            background: rgba(96,20,250,0.08);
            color: var(--primary);
            border: 1px solid rgba(96,20,250,0.18);
            letter-spacing: 0.3px;
        }
        .navigation-tabs {
            display: flex;
            height: auto;
            gap: 4px;
        }
        .tab-button {
            display: flex;
            height: 40px;
            padding: 12px;
            justify-content: center;
            align-items: center;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 600;
            line-height: 16px;
            text-align: center;
            background: transparent;
            color: var(--primary);
            transition: all 0.2s ease;
        }
        .tab-button.tab-active {
            background: var(--primary);
            color: var(--white);
        }
        .tab-button:hover:not(.tab-active) {
            background: rgba(96, 20, 250, 0.1);
        }
        .main-content {
            display: flex;
            flex: 1;
            height: 0;
            overflow: hidden;
        }
        .left-sidebar {
            width: 250px;
            height: 100%;
            background: var(--white);
            border-right: 1px solid var(--border);
            box-shadow: 0 1px 2px var(--shadow);
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 10px;
        }
        .input-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .link-icon {
            width: 20px;
            height: 20px;
        }
        .section-title {
            color: var(--text-secondary);
            font-family: 'Segoe UI', sans-serif;
            font-size: 18px;
            font-weight: 600;
            line-height: 28px;
            margin: 0;
        }
        .divider {
            width: 100%;
            height: 1px;
            background: var(--border);
        }
        .links-input {
            flex: 1;
            width: 100%;
            min-height: 400px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: 'Segoe UI', sans-serif;
            font-size: 14px;
            line-height: 20px;
            color: var(--text-secondary);
            background: #fcfcff;
            transition: all 0.3s ease;
            resize: none;
            outline: none;
        }
        .links-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(96, 20, 250, 0.1);
            transform: translateY(-1px);
        }
        .process-button, .generate-item-button, .add-subsegment-button, .add-subsubsegment-button, .add-subsubsubsegment-button, .add-subsubsubsubsegment-button {
            width: 100%;
            height: 44px;
            padding: 12px;
            background: var(--primary);
            border: none;
            border-radius: 6px;
            color: var(--white);
            font-family: 'Segoe UI', sans-serif;
            font-size: 14px;
            font-weight: 600;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px var(--shadow-button), 0 2px 4px -2px var(--shadow-button);
            transition: all 0.2s ease;
        }
        .process-button:hover, .generate-item-button:hover, .add-subsegment-button:hover, .add-subsubsegment-button:hover, .add-subsubsubsegment-button:hover, .add-subsubsubsubsegment-button:hover {
            background: #5012d4;
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px var(--shadow-button), 0 4px 6px -2px var(--shadow-button);
        }
        .process-button:disabled, .generate-item-button:disabled, .add-subsegment-button:disabled, .add-subsubsegment-button:disabled, .add-subsubsubsegment-button:disabled, .add-subsubsubsubsegment-button:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .add-subsegment-button, .add-subsubsegment-button, .add-subsubsubsegment-button, .add-subsubsubsubsegment-button {
            width: auto;
            height: 28px;
            font-size: 11px;
            padding: 6px 10px;
            margin-right: 4px;
        }
        .results-grid {
            flex: 1;
            padding: 15px;
            display: grid;
            gap: 8px;
            overflow: hidden;
        }
        .results-grid.count-0 {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .results-grid.count-1 {
            display: flex;
            justify-content: center;
            align-items: stretch;
        }
        .results-grid.count-1 .result-box {
            width: 70%;
            height: 100%;
        }
        .results-grid.count-2 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: 1fr;
        }
        .results-grid.count-3 {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: 1fr;
        }
        .results-grid.count-4 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }
        .results-grid.count-5,
        .results-grid.count-6 {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }
        .results-grid.count-0 .guide {
            display: flex;
        }
        .results-grid:not(.count-0) .guide {
            display: none;
        }
        .result-box {
            display: flex;
            width: 100%;
            height: 100%;
            flex-direction: column;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--white);
            box-shadow: 0 1px 2px var(--shadow);
            overflow: hidden;
            transition: all 0.2s ease;
        }
        .result-box:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            background: var(--white);
        }
        .result-title-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .globe-icon {
            width: 16px;
            height: 16px;
        }
        .result-title {
            color: var(--text-secondary);
            font-family: 'Segoe UI', sans-serif;
            font-size: 14px;
            font-weight: 600;
            line-height: 20px;
            margin: 0;
        }
        .close-button {
            display: flex;
            width: 22px;
            height: 22px;
            align-items: center;
            justify-content: center;
            border-radius: 11px;
            background: var(--background-close);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .close-button:hover {
            background: #e5e5e5;
            transform: scale(1.1);
        }
        .result-url {
            padding: 0 18px 8px 18px;
            color: var(--text-primary);
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
            font-weight: 400;
            line-height: 16px;
            word-break: break-all;
        }
        .result-url a {
            color: var(--primary);
            text-decoration: none;
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
            font-weight: 400;
            line-height: 16px;
        }
        .result-url a:hover {
            text-decoration: underline;
        }
        .result-content {
            flex: 1;
            padding: 0 18px 18px 18px;
            overflow-y: auto;
        }
        .file-tree {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .tree-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            min-height: 24px;
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
            font-weight: 400;
            line-height: 16px;
            color: var(--text-secondary);
        }
        .tree-item.folder {
            padding-left: 8px;
        }
        .tree-item.file {
            padding-left: 40px;
        }
        .tree-item.file:hover {
            background: rgba(96, 20, 250, 0.1);
            cursor: grab;
        }
        .tree-item.file.dragging {
            opacity: 0.5;
        }
        .chevron-icon, .folder-icon, .file-icon {
            width: 12px;
            height: 12px;
            flex-shrink: 0;
        }
        .right-sidebar {
            width: 450px;
            height: 100%;
            background: var(--white);
            border-left: 1px solid var(--border);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .comparison-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .comparison-title span {
            color: var(--text-secondary);
            font-family: 'Segoe UI', sans-serif;
            font-size: 14px;
            font-weight: 600;
            line-height: 20px;
            margin: 0;
        }
        .comparison-icon {
            width: 16px;
            height:16px;
        }
        .comparison-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .control-button {
            display: flex;
            width: 24px;
            height: 24px;
            padding: 4px;
            justify-content: center;
            align-items: center;
            border-radius: 6px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .control-button:hover {
            background: rgba(96, 20, 250, 0.1);
        }
        .comparison-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
        }
        .title-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .title-section label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
        }
        .title-section input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }
        .title-section input:focus {
            border-color: var(--primary);
        }
        .segments-section, .companies-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .segments-section h3, .companies-section h3 {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            margin: 0;
        }
        .segments-dropzone, .companies-dropzone, .subsegment-dropzone, .subsubsegment-dropzone, .subsubsubsegment-dropzone, .subsubsubsubsegment-dropzone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            transition: all 0.2s ease;
            min-height: 60px;
        }
        .segments-dropzone.drag-over, .companies-dropzone.drag-over, .subsegment-dropzone.drag-over, .subsubsegment-dropzone.drag-over, .subsubsubsegment-dropzone.drag-over, .subsubsubsubsegment-dropzone.drag-over {
            border-color: var(--primary);
            background: rgba(96, 20, 250, 0.05);
        }
        .dropzone-text {
            color: var(--text-muted);
            font-size: 12px;
            text-align: center;
            margin: 0;
        }
        .dropped-segments, .dropped-companies {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .dropped-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--white);
        }
        .dropped-item.segment {
            padding-left: 12px;
        }
        .dropped-item.subsegment {
            padding-left: 24px;
            background: #f9f9ff;
        }
        .dropped-item.subsubsegment {
            padding-left: 36px;
            background: #f0f0ff;
        }
        .dropped-item.subsubsubsegment {
            padding-left: 48px;
            background: #e8e8ff;
        }
        .dropped-item.subsubsubsubsegment {
            padding-left: 60px;
            background: #e0e0ff;
        }
        .dropped-item span {
            font-size: 12px;
            color: var(--text-primary);
        }
        .add-subsegment, .add-subsubsegment, .add-subsubsubsegment, .add-subsubsubsubsegment {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
        }
        .subsegment-section, .subsubsegment-section, .subsubsubsegment-section, .subsubsubsubsegment-section {
            display: none;
            flex-direction: column;
            gap: 8px;
        }
        .subsegment-section {
            padding-left: 24px;
        }
        .subsubsegment-section {
            padding-left: 36px;
        }
        .subsubsubsegment-section {
            padding-left: 48px;
        }
        .subsubsubsubsegment-section {
            padding-left: 60px;
        }
        .subsegment-section.active, .subsubsegment-section.active, .subsubsubsegment-section.active, .subsubsubsubsegment-section.active {
            display: flex;
        }
        .item-controls {
            display: flex;
            gap: 4px;
        }
        .download-section {
            display: none;
        }
        .download-button {
            width: 100%;
            height: 44px;
            padding: 12px;
            background: var(--success);
            border: none;
            border-radius: 6px;
            color: var(--white);
            font-family: 'Segoe UI', sans-serif;
            font-size: 14px;
            font-weight: 600;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px var(--shadow-button), 0 2px 4px -2px var(--shadow-button);
            transition: all 0.2s ease;
        }
        .download-button:hover {
            background: #0a8f66;
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px var(--shadow-button), 0 4px 6px -2px var(--shadow-button);
        }
        .download-button:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .generate-excel-button {
            width: 100%;
            height: 44px;
            padding: 12px;
            background: #1e40af;
            border: none;
            border-radius: 6px;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 14px;
            font-weight: 600;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px var(--shadow-button), 0 2px 4px -2px var(--shadow-button);
            transition: all 0.2s ease;
            margin-top: 8px;
            display: none;
        }
        .generate-excel-button:hover:not(:disabled) {
            background: #1e3a8a;
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px var(--shadow-button), 0 4px 6px -2px var(--shadow-button);
        }
        .generate-excel-button:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .save-data-button {
            height: 36px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #6014FA 0%, #5206E0 100%);
            border: none;
            border-radius: 6px;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
            font-weight: 600;
            line-height: 16px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(96, 20, 250, 0.2);
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .save-data-button:hover {
            background: linear-gradient(135deg, #5206E0 0%, #3F04C0 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(96, 20, 250, 0.3);
        }
        .save-data-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(96, 20, 250, 0.2);
        }
        .save-data-button:disabled {
            background: linear-gradient(135deg, #ccc 0%, #bbb 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }
        .loading-indicator {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            text-align: center;
            flex-direction: column;
            align-items: center;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 1400px) {
            .results-grid {
                gap: 8px;
                padding: 8px;
            }
            .result-box {
                max-height: 400px;
            }
        }
        @media (max-width: 1200px) {
            .left-sidebar {
                width: 280px;
            }
            .right-sidebar {
                width: 400px;
            }
            .results-grid {
                gap: 8px;
                padding: 8px;
            }
            .result-box {
                max-height: 360px;
            }
        }
        .drag-ghost {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        .drop-preview {
            border: 2px dashed var(--primary);
            background: rgba(96, 20, 250, 0.05);
        }
        .result-content::-webkit-scrollbar, .comparison-content::-webkit-scrollbar {
            width: 4px;
        }
        .result-content::-webkit-scrollbar-track, .comparison-content::-webkit-scrollbar-track {
            background: transparent;
        }
        .result-content::-webkit-scrollbar-thumb, .comparison-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }
        .result-content::-webkit-scrollbar-thumb:hover, .comparison-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        /* Switch styles */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .toggle-container label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary);
        }
        input:checked + .slider:before {
            transform: translateX(14px);
        }
        .manual-entry {
            display: none;
            margin-top: 8px;
            gap: 4px;
            flex-direction: column;
        }
        .manual-entry input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
            outline: none;
        }
        .manual-entry textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
            outline: none;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            resize: vertical;
            min-height: 80px;
        }
        .manual-entry input:focus,
        .manual-entry textarea:focus {
            border-color: var(--primary);
        }
        .manual-entry button {
            height: 32px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            align-self: flex-start;
        }
        .manual-entry button:hover {
            background: #5012d4;
        }
        /* Segments Viewer Styles */
        .segments-viewer {
            display: none;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            background: var(--white);
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        .segments-viewer.active {
            display: block;
        }
        .segments-viewer h4 {
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .segments-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .segment-item {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-primary);
            background: #f9f9ff;
        }
        .segment-item.subsegment {
            padding-left: 16px;
            background: #f0f0ff;
        }
        .segment-item.subsubsegment {
            padding-left: 32px;
            background: #e8e8ff;
        }
        .segment-item.subsubsubsegment {
            padding-left: 48px;
            background: #e0e0ff;
        }
        .segment-item.subsubsubsubsegment {
            padding-left: 64px;
            background: #d8d8ff;
        }
        .view-segments-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            cursor: pointer;
            user-select: none;
        }
        .view-segments-toggle span {
            font-size: 12px;
            color: var(--primary);
            font-weight: 600;
        }
        .view-segments-toggle .toggle-icon {
            width: 16px;
            height:16px;
            transition: transform 0.3s ease;
        }
        .view-segments-toggle.active .toggle-icon {
            transform: rotate(180deg);
        }
        /* Edit Button Styles */
        .edit-button {
            display: flex;
            width: 28px;
            height: 20px;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            background: var(--primary);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            font-size: 10px;
            font-weight: bold;
        }
        .edit-button:hover {
            background: #5012d4;
            transform: scale(1.1);
        }
        .item-controls {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        /* Edit Input Styles */
        .edit-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid var(--primary);
            border-radius: 3px;
            font-size: 12px;
            outline: none;
            background: white;
        }
        .edit-input:focus {
            box-shadow: 0 0 0 2px rgba(96, 20, 250, 0.2);
        }
        /* Industry Classification Select Styles */
        #sector-dropdown:hover, #industry-group-dropdown:hover, #industry-dropdown:hover, #sub-industry-dropdown:hover {
            border-color: #6014FA;
            box-shadow: 0 0 0 3px rgba(96, 20, 250, 0.08);
        }
        #sector-dropdown:focus, #industry-group-dropdown:focus, #industry-dropdown:focus, #sub-industry-dropdown:focus {
            outline: none;
            border-color: #6014FA;
            box-shadow: 0 0 0 4px rgba(96, 20, 250, 0.12);
        }
        #sector-dropdown:disabled, #industry-group-dropdown:disabled, #industry-dropdown:disabled, #sub-industry-dropdown:disabled {
            background-color: #F5F5F5;
            color: #A0A0A0;
            cursor: not-allowed;
            opacity: 0.6;
        }
        /* Market Inputs Select & Input Styles */
        #value-unit:hover, #cagr-2025-2033:hover, #market-size-2024:hover {
            border-color: #6014FA;
            box-shadow: 0 0 0 3px rgba(96, 20, 250, 0.08);
        }
        #value-unit:focus, #cagr-2025-2033:focus, #market-size-2024:focus {
            outline: none;
            border-color: #6014FA;
            box-shadow: 0 0 0 4px rgba(96, 20, 250, 0.12);
        }
        #market-size-2025:hover, #projected-size-2033:hover {
            border-color: #D9E8FF;
            box-shadow: 0 0 0 2px rgba(96, 20, 250, 0.06);
        }
        #edit-2025:hover, #edit-2033:hover {
            background:#5009E6;
            transform:translateY(-1px);
            box-shadow:0 4px 12px rgba(96, 20, 250, 0.25);
        }
        #edit-2025:active, #edit-2033:active {
            transform:translateY(0);
        }
        /* Guide Styles */
        .guide {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
        }
        .guide h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        .guide ol {
            list-style: decimal;
            text-align: left;
            max-width: 600px;
            font-size: 14px;
            line-height: 1.5;
        }
        .guide li {
            margin-bottom: 10px;
        }
        /* AI Button Styles */
        .ai-generate-button {
            height: 32px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            padding: 0 12px;
            margin-left: 8px;
            transition: all 0.2s ease;
        }
        .ai-generate-button:hover {
            background: #5012d4;
            transform: translateY(-1px);
        }
        .ai-generate-button:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }
        .ai-generate-button .loading-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 6px;
        }
        /* Add Level 1 Button Styles */
        .add-level1-button {
            height: 32px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            padding: 0 12px;
            margin-left: 8px;
            transition: all 0.2s ease;
        }
        .add-level1-button:hover {
            background: #5012d4;
            transform: translateY(-1px);
        }
        /* Clear Segments Button Styles */
        .clear-segments-button {
            height: 32px;
            background: var(--error);
            color: var(--white);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            padding: 0 12px;
            margin-left: 8px;
            transition: all 0.2s ease;
        }
        .clear-segments-button:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }
        .copy-list-btn {
            height: 32px;
            background: #6014FA;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            padding: 0 10px;
            margin-left: 8px;
            transition: all 0.2s ease;
        }
        .copy-list-btn:hover {
            background: #4c0fd0;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div id="app" class="automation-app">
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">
                        <div class="logo-graphics">
                            <span class="s">S</span>
                            <span class="q">Q</span>
                        </div>
                    </div>
                    <div class="brand-text">
                        <h1 class="brand-title">Market Research Automation</h1>
                        <div class="brand-subtitle">
                            <span class="name-tag">GRANDVIEW RESEARCH</span>
                            <span class="name-tag">MARKETSANDMARKETS</span>
                            <span class="name-tag">SNS INSIDER</span>
                            <span class="name-tag">MORDOR INTELLIGENCE</span>
                            <span class="name-tag">FORTUNE BUSINESS INSIGHTS</span>
                            <span class="name-tag">FUTURE MARKET INSIGHTS</span>
                            <span class="name-tag">ALLIED MARKET RESEARCH</span>
                            <span class="name-tag">SkyQuest Technology</span>
                            <span class="name-tag">MRF</span>
                            <span class="name-tag">TECHNAVIO</span>
                            <span class="name-tag">STRAITS RESEARCH</span>
                            <span class="name-tag">Precedence Research</span>
                            <span class="name-tag">Verified Market Research</span>
                            <span class="name-tag">Verified Market Reports</span>
                            <span class="name-tag">Global Market Insights</span>
                        </div>
                    </div>
                </div>
                <div class="navigation-tabs">
                    <button class="tab-button tab-active" data-tab="segments">Segments</button>
                    <button class="tab-button" data-tab="company">Company</button>
                    {% if session.get('role') == 'researcher' %}
                    <a class="tab-button" href="/auth/researcher" style="text-decoration:none">Researcher Dashboard</a>
                    {% endif %}
                    {% if session.get('role') == 'admin' %}
                    <a class="tab-button" href="/auth/admin" style="text-decoration:none">Dashboard</a>
                    {% endif %}
                </div>
            </div>
        </header>
        <main class="main-content">
            <aside class="left-sidebar">
                <div class="input-section">
                    <div class="section-header">
                        <svg class="link-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M8.33398 10.8332C8.69186 11.3117 9.14845 11.7075 9.67278 11.994C10.1971 12.2805 10.7769 12.4508 11.3729 12.4935C11.9688 12.5362 12.567 12.4502 13.1268 12.2414C13.6866 12.0326 14.1949 11.7058 14.6173 11.2832L17.1173 8.78322C17.8763 7.99738 18.2963 6.94487 18.2868 5.85238C18.2773 4.7599 17.8391 3.71485 17.0666 2.94231C16.294 2.16978 15.249 2.73157 14.1565 2.72208C13.064 2.71259 12.0115 2.13256 11.2257 2.89156L9.79232 4.31656" stroke="#6014FA" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M11.6659 9.16677C11.308 8.68833 10.8514 8.29245 10.3271 8.00599C9.80274 7.71953 9.22293 7.54918 8.62698 7.50649C8.03103 7.46381 7.43287 7.54980 6.87307 7.75862C6.31327 7.96744 5.80493 8.29421 5.38252 8.71677L2.88252 11.2168C2.12353 12.0026 1.70355 13.0551 1.71305 14.1476C1.72254 15.2401 2.16075 16.2851 2.93328 17.0577C3.70581 17.8302 4.75087 18.2684 5.84335 18.2779C6.93584 18.2874 7.98835 17.8674 8.77419 17.1084L10.1992 15.6834" stroke="#6014FA" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <h2 class="section-title">Paste Research Report URLs (Max 6)</h2>
                    </div>
                    <div class="divider"></div>
                    <textarea class="links-input" placeholder="Paste market research report URLs here, one per line...
Example:
https://www.grandviewresearch.com/industry-analysis/example-market
https://www.marketsandmarkets.com/Market-Reports/example-market-123.html"></textarea>
                </div>
                <button class="process-button">Process Links</button>
            </aside>
            <section class="results-grid count-0">
                <div class="guide">
                    <h2>How to Use Market Research Automation</h2>
                    <ol>
                        <li>Paste up to 6 market research report URLs in the left sidebar textarea, one per line.</li>
                        <li>Click "Process Links" to scrape the Table of Contents (TOC) and company profiles from the reports.</li>
                        <li>Once processed, results will appear here. Use the tabs "Segments" and "Company" to switch between TOC and company profiles views.</li>
                        <li>Drag and drop items from the results (segments or companies) into the right sidebar's "Segments" or "Companies" drop zones.</li>
                        <li>In the right sidebar, enter a title for your report, and ensure you have added segments and companies as needed.</li>
                        <li>Click "Generate Report" to create a combined DOCX file based on the selected items.</li>
                        <li>Once generated, click "Download Report" to save the DOCX file to your device.</li>
                    </ol>
                </div>
            </section>
            <aside class="right-sidebar">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <svg class="comparison-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M12 14C13.1046 14 14 13.1046 14 12C14 10.8954 13.1046 10 12 10C10.8954 10 10 10.8954 10 12C10 13.1046 10.8954 14 12 14Z" stroke="#6014FA" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M4 6C5.10457 6 6 5.10457 6 4C6 2.89543 5.10457 2 4 2C2.89543 2 2 2.89543 2 4C2 5.10457 2.89543 6 4 6Z" stroke="#6014FA" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8.66602 4H10.666C11.0196 4 11.3588 4.14048 11.6088 4.39052C11.8589 4.64057 11.9993 4.97971 11.9993 5.33333V10" stroke="#6014FA" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M7.33333 12H5.33333C4.97971 12 4.64057 11.8595 4.39052 11.6095C4.14048 11.3594 4 11.0203 4 10.6667V6" stroke="#6014FA" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Comparison Area</span>
                    </div>
                    <div class="comparison-controls">
                        <button class="control-button delete-button">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M2 4H14" stroke="#6014FA" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12.6673 4V13.3333C12.6673 14 12.0007 14.6667 11.334 14.6667H4.66732C4.00065 14.6667 3.33398 14 3.33398 13.3333V4" stroke="#6014FA" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M5.33398 3.99992V2.66659C5.33398 1.99992 6.00065 1.33325 6.66732 1.33325H9.33398C10.0007 1.33325 10.6673 1.99992 10.6673 2.66659V3.99992" stroke="#6014FA" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M6.66602 7.33325V11.3333" stroke="#6014FA" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9.33398 7.33325V11.3333" stroke="#6014FA" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="comparison-content">
                    <div class="title-section">
                        <label for="report-title">Title</label>
                        <input type="text" id="report-title" placeholder="Enter the title of the document to generate">
                        <small style="display: block; margin-top: 8px; font-size: 11px; color: #737373; font-style: italic;">ðŸ’¡ Tip: Don't use the word 'Global' in title</small>
                    </div>
                    <!-- Image Generation Section -->
                    <div style="margin-top:10px; border:2px solid #6014FA; border-radius:12px; padding:10px 14px; background:linear-gradient(135deg, #f8f8ff 0%, #fafbff 100%); box-shadow:0 2px 8px rgba(96, 20, 250, 0.08);">
                        <div style="display:flex; align-items:center; margin-bottom:8px;">
                            <div style="width:4px; height:24px; background:#6014FA; border-radius:2px; margin-right:12px;"></div>
                            <h3 style="margin:0; font-size:16px; font-weight:700; color:#2C2C2C; letter-spacing:0.3px;">AI Image Generator</h3>
                            <span style="margin-left:auto; font-size:11px; color:#737373; font-weight:600;">AUTO-GENERATE</span>
                        </div>
                        
                        <!-- Input Section -->
                        <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:14px;">
                            <label for="image-title-input" style="font-size:11px; font-weight:600; color:#2C2C2C; display:block;">Image Title</label>
                            <div style="display:flex; gap:6px; position:relative;">
                                <input type="text" id="image-title-input" placeholder="Enter title for image generation" style="flex:1; padding:10px 12px; padding-right:82px; border:2px solid #E5E5E5; border-radius:8px; font-size:11px; font-weight:500; background:white; color:#2C2C2C; transition:all 0.2s ease;" />
                                <button id="autofill-image-title-btn" style="position:absolute; right:44px; top:50%; transform:translateY(-50%); background:linear-gradient(135deg, rgba(96, 20, 250, 0.1) 0%, rgba(96, 20, 250, 0.05) 100%); border:1.5px solid #D4C5F9; cursor:pointer; color:#6014FA; font-size:13px; padding:6px 8px; border-radius:6px; transition:all 0.2s ease; display:flex; align-items:center; justify-content:center; width:30px; height:30px;" title="Auto-fill with report title">
                                    âš¡
                                </button>
                                <button id="generate-image-btn" style="padding:10px 14px; background:#6014FA; color:white; border:none; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer; transition:all 0.2s ease; white-space:nowrap; display:flex; align-items:center; justify-content:center; gap:4px; box-shadow:0 2px 8px rgba(96, 20, 250, 0.2); width:36px; height:36px;">
                                    <span id="generate-text">âœ¨</span>
                                    <span id="generate-spinner" style="display:none; width:10px; height:10px; border:2px solid rgba(255,255,255,0.3); border-top:2px solid white; border-radius:50%; animation: spin 0.6s linear infinite;"></span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Image Preview Container -->
                        <div id="image-preview-container" style="display:none; border:2px solid #E5E5E5; border-radius:8px; overflow:hidden; background:white; margin-bottom:16px;">
                            <div style="display:flex; align-items:center; gap:8px; padding:12px; background:#F8F8F8; border-bottom:1px solid #E5E5E5;">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M8 1.5C4.41 1.5 1.5 4.41 1.5 8s2.91 6.5 6.5 6.5 6.5-2.91 6.5-6.5-2.91-6.5-6.5-6.5zM7 11h2v2H7zm0-8h2v6H7z" fill="#6014FA"/>
                                </svg>
                                <span style="font-size:12px; font-weight:600; color:#2C2C2C;">Generated Image Preview</span>
                                <button id="close-preview-btn" style="margin-left:auto; background:none; border:none; cursor:pointer; color:#737373; font-size:16px; padding:0; display:flex; align-items:center; justify-content:center;">&times;</button>
                            </div>
                            <div style="padding:16px; text-align:center;">
                                <img id="generated-image" src="" alt="Generated Market Image" style="max-width:100%; max-height:400px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.1);" />
                            </div>
                            <div style="padding:12px; background:#F8F8F8; border-top:1px solid #E5E5E5; display:flex; gap:8px;">
                                <button id="download-image-btn" style="flex:1; padding:8px 12px; background:#10B981; color:white; border:none; border-radius:6px; font-size:11px; font-weight:600; cursor:pointer; transition:all 0.2s ease; display:flex; align-items:center; justify-content:center; gap:6px;">
                                    <span>â†“ Download</span>
                                </button>
                                <button id="use-image-btn" style="flex:1; padding:8px 12px; background:#6014FA; color:white; border:none; border-radius:6px; font-size:11px; font-weight:600; cursor:pointer; transition:all 0.2s ease; display:flex; align-items:center; justify-content:center; gap:6px;">
                                    <span>âœ“ Done</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Status Message -->
                        <div id="image-status-message" style="display:none; padding:12px; border-radius:6px; font-size:12px; font-weight:500; text-align:center;"></div>
                    </div>
                    <!-- Cascading Dropdown Section -->
                    <div class="industry-classification" style="margin-top:10px; border:2px solid #6014FA; border-radius:12px; padding:10px 14px; background:linear-gradient(135deg, #f8f8ff 0%, #fafbff 100%); box-shadow:0 2px 8px rgba(96, 20, 250, 0.08);">
                        <div style="display:flex; align-items:center; margin-bottom:8px;">
                            <div style="width:4px; height:24px; background:#6014FA; border-radius:2px; margin-right:12px;"></div>
                            <h3 style="margin:0; font-size:16px; font-weight:700; color:#2C2C2C; letter-spacing:0.3px;">Industry Classification</h3>
                            <span style="margin-left:auto; font-size:11px; color:#737373; font-weight:600;">4-LEVEL TAXONOMY</span>
                        </div>
                        <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px;">
                            <!-- Sector Dropdown -->
                            <div>
                                <label for="sector-dropdown" style="font-size:11px; font-weight:700; display:block; margin-bottom:6px; color:#2C2C2C; text-transform:uppercase; letter-spacing:0.3px;">Sector</label>
                                <select id="sector-dropdown" style="width:100%; padding:8px 10px; border:2px solid #E5E5E5; border-radius:8px; font-size:12px; font-weight:500; background:white; color:#2C2C2C; cursor:pointer; transition:all 0.2s ease;">
                                    <option value="">Select Sector</option>
                                </select>
                            </div>
                            <!-- Industry Group Dropdown -->
                            <div>
                                <label for="industry-group-dropdown" style="font-size:11px; font-weight:700; display:block; margin-bottom:6px; color:#2C2C2C; text-transform:uppercase; letter-spacing:0.3px;">Industry Group</label>
                                <select id="industry-group-dropdown" style="width:100%; padding:8px 10px; border:2px solid #E5E5E5; border-radius:8px; font-size:12px; font-weight:500; background:white; color:#2C2C2C; cursor:pointer; transition:all 0.2s ease;" disabled>
                                    <option value="">Select Industry Group</option>
                                </select>
                            </div>
                            <!-- Industry Dropdown -->
                            <div>
                                <label for="industry-dropdown" style="font-size:11px; font-weight:700; display:block; margin-bottom:6px; color:#2C2C2C; text-transform:uppercase; letter-spacing:0.3px;">Industry</label>
                                <select id="industry-dropdown" style="width:100%; padding:8px 10px; border:2px solid #E5E5E5; border-radius:8px; font-size:12px; font-weight:500; background:white; color:#2C2C2C; cursor:pointer; transition:all 0.2s ease;" disabled>
                                    <option value="">Select Industry</option>
                                </select>
                            </div>
                            <!-- Sub-Industry Dropdown -->
                            <div>
                                <label for="sub-industry-dropdown" style="font-size:11px; font-weight:700; display:block; margin-bottom:6px; color:#2C2C2C; text-transform:uppercase; letter-spacing:0.3px;">Sub-Industry</label>
                                <select id="sub-industry-dropdown" style="width:100%; padding:8px 10px; border:2px solid #E5E5E5; border-radius:8px; font-size:12px; font-weight:500; background:white; color:#2C2C2C; cursor:pointer; transition:all 0.2s ease;" disabled>
                                    <option value="">Select Sub-Industry</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="market-inputs" style="margin-top:14px;">
                        <div style="background:linear-gradient(135deg, #f9f9ff 0%, #fbfbff 100%); border:2px solid #6014FA; border-radius:12px; padding:10px 14px; box-shadow:0 2px 8px rgba(96, 20, 250, 0.08);">
                            <div style="display:flex; align-items:center; margin-bottom:16px;">
                                <div style="width:4px; height:24px; background:#6014FA; border-radius:2px; margin-right:12px;"></div>
                                <h3 style="margin:0; font-size:16px; font-weight:700; color:#2C2C2C; letter-spacing:0.3px;">Market Inputs</h3>
                                <span style="margin-left:auto; font-size:11px; color:#737373; font-weight:600;">Auto-Calculate</span>
                            </div>
                            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:16px;">
                                <!-- Value Unit -->
                                <div style="display:flex; flex-direction:column; height:100%;">
                                    <label for="value-unit" style="font-size:11px; font-weight:700; display:block; margin-bottom:6px; color:#2C2C2C; text-transform:uppercase; letter-spacing:0.3px;">Value Unit</label>
                                    <select id="value-unit" style="width:100%; padding:10px 12px; border:2px solid #E5E5E5; border-radius:8px; font-size:12px; font-weight:500; background:white; color:#2C2C2C; cursor:pointer; transition:all 0.2s ease; flex:1;">
                                        <option value="">Select unit</option>
                                        <option value="Million">Million</option>
                                        <option value="Billion">Billion</option>
                                        <option value="Trillion">Trillion</option>
                                    </select>
                                    <small class="unit-error" style="color:#c0392b; display:none; font-size:10px; margin-top:4px;">Required</small>
                                </div>
                                <!-- Market Size 2024 -->
                                <div style="display:flex; flex-direction:column; height:100%;">
                                    <label for="market-size-2024" style="font-size:11px; font-weight:700; display:block; margin-bottom:6px; color:#2C2C2C; text-transform:uppercase; letter-spacing:0.3px;">Market Size 2024</label>
                                    <input id="market-size-2024" type="number" step="0.01" placeholder="e.g., 150.34" style="width:100%; padding:10px 12px; border:2px solid #E5E5E5; border-radius:8px; font-size:12px; font-weight:500; background:white; color:#2C2C2C; transition:all 0.2s ease; flex:1;" />
                                    <small class="ms2024-error" style="color:#c0392b; display:none; font-size:10px; margin-top:4px;">Required</small>
                                </div>
                                <!-- CAGR -->
                                <div style="display:flex; flex-direction:column; height:100%;">
                                    <label for="cagr-2025-2033" style="font-size:11px; font-weight:700; display:block; margin-bottom:6px; color:#2C2C2C; text-transform:uppercase; letter-spacing:0.3px;">CAGR(2025-2033)%</label>
                                    <input id="cagr-2025-2033" type="number" step="0.01" placeholder="e.g., 18.57" style="width:100%; padding:10px 12px; border:2px solid #E5E5E5; border-radius:8px; font-size:12px; font-weight:500; background:white; color:#2C2C2C; transition:all 0.2s ease; flex:1;" />
                                    <small class="cagr-error" style="color:#c0392b; display:none; font-size:10px; margin-top:4px;">Required</small>
                                </div>
                            </div>
                            <!-- Calculated Values Section -->
                            <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:16px; margin-top:16px; padding-top:16px; border-top:1px solid #E5E5E5;">
                                <!-- Market Size 2025 -->
                                <div style="display:flex; flex-direction:column; height:100%;">
                                    <label for="market-size-2025" style="font-size:11px; font-weight:700; display:block; margin-bottom:6px; color:#2C2C2C; text-transform:uppercase; letter-spacing:0.3px;">Market Size 2025 (Auto)</label>
                                    <div style="display:flex; gap:8px; flex:1;">
                                        <input id="market-size-2025" type="number" step="0.01" placeholder="Auto-calculated" style="width:100%; padding:10px 12px; border:2px solid #D9E8FF; border-radius:8px; font-size:12px; font-weight:500; background:#F8FAFF; color:#2C2C2C; transition:all 0.2s ease; flex:1;" readonly />
                                        <button id="edit-2025" style="padding:10px 12px; background:#6014FA; color:white; border:none; border-radius:8px; font-size:11px; font-weight:600; cursor:pointer; transition:all 0.2s ease; white-space:nowrap;">Edit</button>
                                    </div>
                                    <small class="ms2025-error" style="color:#c0392b; display:none; font-size:10px; margin-top:4px;">Required</small>
                                </div>
                                <!-- Projected Size 2033 -->
                                <div style="display:flex; flex-direction:column; height:100%;">
                                    <label for="projected-size-2033" style="font-size:11px; font-weight:700; display:block; margin-bottom:6px; color:#2C2C2C; text-transform:uppercase; letter-spacing:0.3px;">Projected Size 2033 (Auto)</label>
                                    <div style="display:flex; gap:8px; flex:1;">
                                        <input id="projected-size-2033" type="number" step="0.01" placeholder="Auto-calculated" style="width:100%; padding:10px 12px; border:2px solid #D9E8FF; border-radius:8px; font-size:12px; font-weight:500; background:#F8FAFF; color:#2C2C2C; transition:all 0.2s ease; flex:1;" readonly />
                                        <button id="edit-2033" style="padding:10px 12px; background:#6014FA; color:white; border:none; border-radius:8px; font-size:11px; font-weight:600; cursor:pointer; transition:all 0.2s ease; white-space:nowrap;">Edit</button>
                                    </div>
                                    <small class="ms2033-error" style="color:#c0392b; display:none; font-size:10px; margin-top:4px;">Required</small>
                                </div>
                            </div>
                        </div>
                    <!-- KMI Input Section (For TOC Only) -->
                    <div style="margin-top:10px; border:2px solid #6014FA; border-radius:12px; padding:10px 14px; background:linear-gradient(135deg, #f8f8ff 0%, #fafbff 100%); box-shadow:0 2px 8px rgba(96, 20, 250, 0.08);">
                        <div style="display:flex; align-items:center; margin-bottom:8px;">
                            <div style="width:4px; height:24px; background:#6014FA; border-radius:2px; margin-right:12px;"></div>
                            <h3 style="margin:0; font-size:16px; font-weight:700; color:#2C2C2C; letter-spacing:0.3px;">KMI (Key Market Insights)</h3>
                            <span style="margin-left:auto; font-size:11px; color:#737373; font-weight:600;">For TOC &amp; SkyQuest</span>
                        </div>
                        <!-- Fixed KMI checkboxes (always included in SkyQuest submission) -->
                        <div id="kmi-fixed-checkboxes" style="display:flex; flex-wrap:wrap; gap:6px 12px; margin-bottom:10px;">
                            <label style="display:flex; align-items:center; gap:5px; font-size:12px; font-weight:500; color:#2C2C2C; cursor:pointer;">
                                <input type="checkbox" class="kmi-fixed-cb" value="Key Success Factors" checked disabled style="accent-color:#6014FA;"> Key Success Factors
                            </label>
                            <label style="display:flex; align-items:center; gap:5px; font-size:12px; font-weight:500; color:#2C2C2C; cursor:pointer;">
                                <input type="checkbox" class="kmi-fixed-cb" value="Market Impacting Factors" checked disabled style="accent-color:#6014FA;"> Market Impacting Factors
                            </label>
                            <label style="display:flex; align-items:center; gap:5px; font-size:12px; font-weight:500; color:#2C2C2C; cursor:pointer;">
                                <input type="checkbox" class="kmi-fixed-cb" value="Top Investment Pockets" checked disabled style="accent-color:#6014FA;"> Top Investment Pockets
                            </label>
                            <label style="display:flex; align-items:center; gap:5px; font-size:12px; font-weight:500; color:#2C2C2C; cursor:pointer;">
                                <input type="checkbox" class="kmi-fixed-cb" value="Ecosystem Mapping" checked disabled style="accent-color:#6014FA;"> Ecosystem Mapping
                            </label>
                            <label style="display:flex; align-items:center; gap:5px; font-size:12px; font-weight:500; color:#2C2C2C; cursor:pointer;">
                                <input type="checkbox" class="kmi-fixed-cb" value="Market Attractiveness Index 2025" checked disabled style="accent-color:#6014FA;"> Market Attractiveness Index 2025
                            </label>
                            <label style="display:flex; align-items:center; gap:5px; font-size:12px; font-weight:500; color:#2C2C2C; cursor:pointer;">
                                <input type="checkbox" class="kmi-fixed-cb" value="PESTEL Analysis" checked disabled style="accent-color:#6014FA;"> PESTEL Analysis
                            </label>
                            <label style="display:flex; align-items:center; gap:5px; font-size:12px; font-weight:500; color:#2C2C2C; cursor:pointer;">
                                <input type="checkbox" class="kmi-fixed-cb" value="Regulatory Landscape" checked disabled style="accent-color:#6014FA;"> Regulatory Landscape
                            </label>
                        </div>
                        <textarea id="kmi-data-input" placeholder="Enter additional Key Market Insights here, one per line (optional)...
Example:
Pricing Analysis
Case Studies" style="width:100%; padding:12px; border:2px solid #E5E5E5; border-radius:8px; font-size:12px; font-weight:500; background:white; color:#2C2C2C; font-family:'Segoe UI', sans-serif; resize:vertical; min-height:60px; transition:all 0.2s ease;"></textarea>
                    </div>
                    <div class="segments-section">
                        <h3>Segments</h3>
                        <div class="toggle-container">
                            <label for="manual-segments">Manual Entry</label>
                            <label class="switch">
                                <input type="checkbox" id="manual-segments" class="manual-switch" data-section="segments">
                                <span class="slider"></span>
                            </label>
                            <button class="ai-generate-button" id="ai-generate-segments">
                                AI
                            </button>
                            <button class="clear-segments-button" id="clear-segments">
                                Clear All
                            </button>
                            <button class="copy-list-btn" id="copy-segments-btn" title="Copy segments as numbered list">Copy</button>
                        </div>
                        <div class="segments-dropzone">
                            <p class="dropzone-text">Drag and drop segments here</p>
                        </div>
                        <div class="manual-entry" data-section="segments">
                            <input type="text" placeholder="Enter segment name">
                            <button class="add-manual-button" data-section="segments">Add</button>
                        </div>
                        <div class="bulk-import" style="margin-top:8px;">
                            <label for="bulk-segments-input" style="display:block; font-size:12px; color:#6B7280; margin-bottom:6px;">Bulk Segments Import</label>
                            <textarea id="bulk-segments-input" placeholder="Paste numbered segments here, e.g.:
1. Transit Type
1.1. Metro
1.1.1. Urban Metro" style="width:100%; padding:10px; border:1px solid #E5E5E5; border-radius:6px; font-size:12px; min-height:100px; resize:vertical;"></textarea>
                            <button id="import-bulk-segments-btn" class="process-button" style="margin-top:8px; width:100%;">Import Bulk Segments</button>
                            <button id="get-all-segments-btn" class="generate-item-button" style="margin-top:8px; width:100%; background:#fff; color:#6014FA; border:1px solid #E5E5E5;">Get All Segments</button>
                        </div>
                        <div class="view-segments-toggle">
                            <svg class="toggle-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M4 6L8 10L12 6" stroke="#6014FA" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>View Segments</span>
                        </div>
                        <div class="segments-viewer">
                            <h4>All Segments</h4>
                            <div class="segments-list"></div>
                        </div>
                        <div class="dropped-segments"></div>
                    </div>
                    <div class="companies-section">
                        <h3>Companies</h3>
                        <div class="toggle-container">
                            <label for="manual-companies">Manual Entry</label>
                            <label class="switch">
                                <input type="checkbox" id="manual-companies" class="manual-switch" data-section="companies">
                                <span class="slider"></span>
                            </label>
                            <button class="ai-generate-button" id="ai-generate-companies">
                                AI
                            </button>
                            <button class="clear-segments-button" id="clear-companies">
                                Clear All
                            </button>
                            <button class="copy-list-btn" id="copy-companies-btn" title="Copy companies">Copy</button>
                        </div>
                        <div class="companies-dropzone">
                            <p class="dropzone-text">Drag and drop company names here</p>
                        </div>
                        <div class="manual-entry" data-section="companies">
                            <textarea placeholder="Enter company name(s) - one per line for bulk entry" rows="4"></textarea>
                            <button class="add-manual-button" data-section="companies">Add</button>
                        </div>
                        <div class="dropped-companies"></div>
                    </div>
                    <!-- 4 Main Action Buttons -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 16px; row-gap: 14px;">
                        <button id="generate-report-btn" class="generate-item-button" style="height: 44px;">Generate Report</button>
                        <button id="save-data-btn" class="save-data-button" title="Save all data to JSON file" style="width: 100%; height: 44px;">Save</button>
                        <button id="generate-toc-btn" class="generate-item-button" style="height: 44px; background: #2563eb; margin-top: 4px;" title="Generate Table of Contents">
                            ðŸ“„ Generate TOC
                        </button>
                        <button id="generate-short-rd-btn" class="generate-item-button" style="height: 44px; background: #059669; margin-top: 4px;" title="Generate Short Research Document">
                            ðŸ“‹ Generate Short RD
                        </button>
                    </div>
                    <div class="download-section" style="margin-top: 14px;">
                        <button class="download-button" disabled>Download Report</button>
                        <button class="generate-excel-button" disabled>Generate Excel</button>
                        <!-- Removed: Submit to Creator (creator role removed) -->
                    </div>
                </div>
            </aside>
        </main>
        <div class="loading-indicator">
            <div class="spinner"></div>
            <p>Processing URLs...</p>
        </div>
    </div>
    <script>
        class MarketResearchAutomation {
            constructor() {
                this.results = [];
                this.draggedElement = null;
                this.currentTab = 'segments';
                this.reportBlob = null;
                this.lastGeneratedDoc = null;
                this.lastGeneratedMeta = null;
                this.segmentChangeLog = [];
                this.aiSegmentsSnapshotFlat = [];
                this.aiSegmentsJSON = null;  // Store AI-generated segments in JSON format
                this.originalAiSegments = null; // Preserve original AI segments exactly as returned (immutable copy)
                this.activeSubSegmentDropzone = null;
                this.activeSubSubSegmentDropzone = null;
                this.activeSubSubSubSegmentDropzone = null;
                this.activeSubSubSubSubSegmentDropzone = null;
                this.activeManualTarget = null;
                this.segmentsViewerVisible = false;
                this.init();
            }

            init() {
                this.bindEvents();
                this.switchTab('segments');
                // Removed: this.fetchCreators();
                this.initializeIndustryClassification();
                this.initializeMarketInputs();
            }

            initializeMarketInputs() {
                const marketSize2024 = document.getElementById('market-size-2024');
                const cagr = document.getElementById('cagr-2025-2033');
                const marketSize2025 = document.getElementById('market-size-2025');
                const projectedSize2033 = document.getElementById('projected-size-2033');
                const edit2025Btn = document.getElementById('edit-2025');
                const edit2033Btn = document.getElementById('edit-2033');

                // Function to calculate market values using CAGR formula: FV = PV Ã— (1 + CAGR)^n
                const calculateValues = () => {
                    const ms2024 = parseFloat(marketSize2024.value);
                    const cagrRate = parseFloat(cagr.value);

                    if (!isNaN(ms2024) && !isNaN(cagrRate) && ms2024 > 0 && cagrRate >= 0) {
                        // Calculate 2025 (1 year from 2024)
                        const ms2025 = ms2024 * Math.pow(1 + cagrRate / 100, 1);
                        marketSize2025.value = ms2025.toFixed(2);

                        // Calculate 2033 (8 years from 2024, or 9 years from 2025)
                        // Using 2024 as base: (1 + CAGR)^8 = 2033
                        const ms2033 = ms2024 * Math.pow(1 + cagrRate / 100, 9);
                        projectedSize2033.value = ms2033.toFixed(2);
                    }
                };

                // Auto-calculate on input change
                marketSize2024.addEventListener('input', calculateValues);
                cagr.addEventListener('input', calculateValues);

                // Edit buttons to make fields editable
                edit2025Btn.addEventListener('click', () => {
                    marketSize2025.toggleAttribute('readonly');
                    edit2025Btn.textContent = marketSize2025.readOnly ? 'Edit' : 'Lock';
                    edit2025Btn.style.background = marketSize2025.readOnly ? '#6014FA' : '#FF6B35';
                    if (!marketSize2025.readOnly) {
                        marketSize2025.focus();
                        marketSize2025.style.borderColor = '#FF6B35';
                        marketSize2025.style.background = 'white';
                    } else {
                        marketSize2025.style.borderColor = '#D9E8FF';
                        marketSize2025.style.background = '#F8FAFF';
                    }
                });

                edit2033Btn.addEventListener('click', () => {
                    projectedSize2033.toggleAttribute('readonly');
                    edit2033Btn.textContent = projectedSize2033.readOnly ? 'Edit' : 'Lock';
                    edit2033Btn.style.background = projectedSize2033.readOnly ? '#6014FA' : '#FF6B35';
                    if (!projectedSize2033.readOnly) {
                        projectedSize2033.focus();
                        projectedSize2033.style.borderColor = '#FF6B35';
                        projectedSize2033.style.background = 'white';
                    } else {
                        projectedSize2033.style.borderColor = '#D9E8FF';
                        projectedSize2033.style.background = '#F8FAFF';
                    }
                });
            }

            initializeIndustryClassification() {
                // Industry classification data - matches Materials and Utilities sectors with 4 levels
                const industryData = {
                    "sectors": [
                        {
                            "name": "Materials",
                            "id": "materials",
                            "industry_groups": [
                                {
                                    "name": "Diversified Materials",
                                    "id": "diversified_materials",
                                    "industries": [
                                        {
                                            "name": "Metals & Mining",
                                            "id": "metals_mining",
                                            "sub_industries": [
                                                "Silver",
                                                "Diversified Metals & Mining",
                                                "Gold",
                                                "Copper",
                                                "Steel",
                                                "Aluminum",
                                                "Precious Metals & Minerals"
                                            ]
                                        },
                                        {
                                            "name": "Chemicals",
                                            "id": "chemicals",
                                            "sub_industries": [
                                                "Commodity Chemicals",
                                                "Fertilizers & Agricultural Chemicals",
                                                "Specialty Chemicals",
                                                "Industrial Gases",
                                                "Diversified Chemicals"
                                            ]
                                        },
                                        {
                                            "name": "Paper & Forest Products",
                                            "id": "paper_forest",
                                            "sub_industries": [
                                                "Paper Products",
                                                "Forest Products"
                                            ]
                                        },
                                        {
                                            "name": "Construction Materials",
                                            "id": "construction_materials",
                                            "sub_industries": [
                                                "Construction Materials"
                                            ]
                                        },
                                        {
                                            "name": "Containers & Packaging",
                                            "id": "containers_packaging",
                                            "sub_industries": [
                                                "Paper Packaging",
                                                "Metal & Glass Containers"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "name": "Utilities",
                            "id": "utilities",
                            "industry_groups": [
                                {
                                    "name": "Diversified Utilities Services",
                                    "id": "diversified_utilities",
                                    "industries": [
                                        {
                                            "name": "Electric Utilities",
                                            "id": "electric_utilities",
                                            "sub_industries": [
                                                "Electric Utilities"
                                            ]
                                        },
                                        {
                                            "name": "Gas Utilities",
                                            "id": "gas_utilities",
                                            "sub_industries": [
                                                "Gas Utilities"
                                            ]
                                        },
                                        {
                                            "name": "Multi-Utilities",
                                            "id": "multi_utilities",
                                            "sub_industries": [
                                                "Multi-Utilities"
                                            ]
                                        },
                                        {
                                            "name": "Water Utilities",
                                            "id": "water_utilities",
                                            "sub_industries": [
                                                "Water Utilities"
                                            ]
                                        },
                                        {
                                            "name": "Independent Power and Renewable Electricity Producers",
                                            "id": "independent_power_renewable",
                                            "sub_industries": [
                                                "Independent Power Producers & Energy Traders",
                                                "Renewable Electricity"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "name": "Real Estate",
                            "id": "real_estate",
                            "industry_groups": [
                                {
                                    "name": "Real Estate Services",
                                    "id": "real_estate_services",
                                    "industries": [
                                        {
                                            "name": "Equity Real Estate Investment Trusts (REITs)",
                                            "id": "equity_reits",
                                            "sub_industries": [
                                                "Diversified REITs",
                                                "Industrial REITs",
                                                "Office REITs",
                                                "Health Care REITs",
                                                "Retail REITs",
                                                "Specialized REITs",
                                                "Hotel & Resort REITs",
                                                "Residential REITs"
                                            ]
                                        },
                                        {
                                            "name": "Real Estate Management & Development",
                                            "id": "real_estate_mgmt_dev",
                                            "sub_industries": [
                                                "Real Estate Operating Companies",
                                                "Real Estate Development",
                                                "Real Estate Services",
                                                "Diversified Real Estate Activities"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "name": "Consumer Staples",
                            "id": "consumer_staples",
                            "industry_groups": [
                                {
                                    "name": "Food & Staples Retailing",
                                    "id": "food_staples_retailing",
                                    "industries": [
                                        {
                                            "name": "Food & Staples Retailing",
                                            "id": "Food & Staples Retailing",
                                            "sub_industries": [
                                                "Drug Retail",
                                                "Food Retail",
                                                "Hypermarkets & Super Centers",
                                                "Food Distributors"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "name": "Food, Beverage & Tobacco",
                                    "id": "food_beverage_tobacco",
                                    "industries": [
                                        {
                                            "name": "Food Products",
                                            "id": "food_products",
                                            "sub_industries": [
                                                "Agricultural products",
                                                "Packaged Foods & Meats"
                                            ]
                                        },
                                        {
                                            "name": "Beverages",
                                            "id": "beverages",
                                            "sub_industries": [
                                                "Brewers",
                                                "Soft Drinks",
                                                "Distillers & Vintners"
                                            ]
                                        },
                                        {
                                            "name": "Tobacco",
                                            "id": "tobacco",
                                            "sub_industries": [
                                                "Tobacco"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "name": "Household & Personal Products",
                                    "id": "household_personal_products",
                                    "industries": [
                                        {
                                            "name": "Household Products",
                                            "id": "household_products",
                                            "sub_industries": [
                                                "Household Products"
                                            ]
                                        },
                                        {
                                            "name": "Personal Products",
                                            "id": "personal_products",
                                            "sub_industries": [
                                                "Personal Products"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "name": "Health Care",
                            "id": "health_care",
                            "industry_groups": [
                                {
                                    "name": "Health Care Equipment & Services",
                                    "id": "health_care_equipment_services",
                                    "industries": [
                                        {
                                            "name": "Health Care Equipment & Supplies",
                                            "id": "health_care_equipment_supplies",
                                            "sub_industries": [
                                                "Health Care Equipment",
                                                "Health Care Supplies"
                                            ]
                                        },
                                        {
                                            "name": "Health Care Providers & Services",
                                            "id": "health_care_providers_services",
                                            "sub_industries": [
                                                "Health Care Distributors",
                                                "Health Care Facilities",
                                                "Managed Health Care",
                                                "Health Care Services"
                                            ]
                                        },
                                        {
                                            "name": "Health Care Technology",
                                            "id": "health_care_technology",
                                            "sub_industries": [
                                                "Health Care Technology"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "name": "Pharmaceuticals, Biotechnology & Life Sciences",
                                    "id": "pharma_biotech_life_sciences",
                                    "industries": [
                                        {
                                            "name": "Biotechnology",
                                            "id": "biotechnology",
                                            "sub_industries": [
                                                "Biotechnology"
                                            ]
                                        },
                                        {
                                            "name": "Pharmaceuticals",
                                            "id": "pharmaceuticals",
                                            "sub_industries": [
                                                "Pharmaceuticals"
                                            ]
                                        },
                                        {
                                            "name": "Life Sciences Tools & Services",
                                            "id": "life_sciences_tools_services",
                                            "sub_industries": [
                                                "Life Sciences Tools & Services"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "name": "Financials",
                            "id": "financials",
                            "industry_groups": [
                                {
                                    "name": "Insurance",
                                    "id": "insurance",
                                    "industries": [
                                        {
                                            "name": "Insurance Services",
                                            "id": "insurance_services",
                                            "sub_industries": [
                                                "Reinsurance",
                                                "Insurance Brokers",
                                                "Multi-line Insurance",
                                                "Life & Health Insurance",
                                                "Property & Casualty Insurance"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "name": "Diversified Financials",
                                    "id": "diversified_financials",
                                    "industries": [
                                        {
                                            "name": "Consumer Finance",
                                            "id": "consumer_finance",
                                            "sub_industries": [
                                                "Consumer Finance"
                                            ]
                                        },
                                        {
                                            "name": "Diversified Financial Services",
                                            "id": "diversified_financial_services",
                                            "sub_industries": [
                                                "Multi-Sector Holdings",
                                                "Other Diversified Financial Services",
                                                "Specialized Finance"
                                            ]
                                        },
                                        {
                                            "name": "Capital Markets",
                                            "id": "capital_markets",
                                            "sub_industries": [
                                                "Financial Exchanges & Data",
                                                "Investment Banking & Brokerage",
                                                "Diversified Capital Markets",
                                                "Asset Management & Custody Banks"
                                            ]
                                        },
                                        {
                                            "name": "Mortgage Real Estate Investment Trusts (REITs)",
                                            "id": "mortgage_reits",
                                            "sub_industries": [
                                                "Mortgage REITs"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "name": "Banks",
                                    "id": "banks",
                                    "industries": [
                                        {
                                            "name": "Banking Services",
                                            "id": "banking_services",
                                            "sub_industries": [
                                                "Regional Banks",
                                                "Diversified Banks"
                                            ]
                                        },
                                        {
                                            "name": "Thrifts & Mortgage Finance",
                                            "id": "thrifts_mortgage_finance",
                                            "sub_industries": [
                                                "Thrifts & Mortgage Finance"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "name": "Industrials",
                            "id": "industrials",
                            "industry_groups": [
                                {
                                    "name": "Capital Goods",
                                    "id": "capital_goods",
                                    "industries": [
                                        {
                                            "name": "Building Products",
                                            "id": "building_products",
                                            "sub_industries": [
                                                "Building Products"
                                            ]
                                        },
                                        {
                                            "name": "Industrial Conglomerates",
                                            "id": "industrial_conglomerates",
                                            "sub_industries": [
                                                "Industrial Conglomerates"
                                            ]
                                        },
                                        {
                                            "name": "Machinery",
                                            "id": "machinery",
                                            "sub_industries": [
                                                "Industrial Machinery",
                                                "Construction Machinery & Heavy Trucks",
                                                "Agricultural & Farm Machinery"
                                            ]
                                        },
                                        {
                                            "name": "Aerospace & Defense",
                                            "id": "aerospace_defense",
                                            "sub_industries": [
                                                "Aerospace & Defense"
                                            ]
                                        },
                                        {
                                            "name": "Construction & Engineering",
                                            "id": "construction_engineering",
                                            "sub_industries": [
                                                "Construction & Engineering"
                                            ]
                                        },
                                        {
                                            "name": "Electrical Equipment",
                                            "id": "electrical_equipment",
                                            "sub_industries": [
                                                "Electrical Components & Equipment",
                                                "Heavy Electrical Equipment"
                                            ]
                                        },
                                        {
                                            "name": "Trading Companies & Distributors",
                                            "id": "trading_companies_distributors",
                                            "sub_industries": [
                                                "Trading Companies & Distributors"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "name": "Transportation",
                                    "id": "transportation",
                                    "industries": [
                                        {
                                            "name": "Airlines",
                                            "id": "airlines",
                                            "sub_industries": [
                                                "Airlines"
                                            ]
                                        },
                                        {
                                            "name": "Air Freight & Logistics",
                                            "id": "air_freight_logistics",
                                            "sub_industries": [
                                                "Air Freight & Logistics"
                                            ]
                                        },
                                        {
                                            "name": "Marine",
                                            "id": "marine",
                                            "sub_industries": [
                                                "Marine"
                                            ]
                                        },
                                        {
                                            "name": "Road & Rail",
                                            "id": "road_rail",
                                            "sub_industries": [
                                                "Railroads",
                                                "Trucking"
                                            ]
                                        },
                                        {
                                            "name": "Transportation Infrastructure",
                                            "id": "transportation_infrastructure",
                                            "sub_industries": [
                                                "Marine Ports & Services",
                                                "Highways & Railtracks",
                                                "Airport Services"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "name": "Information Technology",
                            "id": "information_technology",
                            "industry_groups": [
                                {
                                    "name": "Semiconductors & Semiconductor Equipment",
                                    "id": "semiconductors_semiconductor_equipment",
                                    "industries": [
                                        {
                                            "name": "Semiconductor Services & Semiconductor Equipment",
                                            "id": "semiconductor_services_equipment",
                                            "sub_industries": [
                                                "Semiconductor Equipment",
                                                "Semiconductors"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "name": "Technology Hardware & Equipment",
                                    "id": "technology_hardware_equipment",
                                    "industries": [
                                        {
                                            "name": "Communications Equipment",
                                            "id": "communications_equipment",
                                            "sub_industries": [
                                                "Communications Equipment"
                                            ]
                                        },
                                        {
                                            "name": "Technology Hardware, Storage & Peripherals",
                                            "id": "technology_hardware_storage_peripherals",
                                            "sub_industries": [
                                                "Technology Hardware, Storage & Peripherals"
                                            ]
                                        },
                                        {
                                            "name": "Electronic Equipment, Instruments & Components",
                                            "id": "electronic_equipment_instruments_components",
                                            "sub_industries": [
                                                "Electronic Components",
                                                "Electronic Equipment & Instruments",
                                                "Technology Distributors",
                                                "Electronic Manufacturing Services"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "name": "Software & Services",
                                    "id": "software_services",
                                    "industries": [
                                        {
                                            "name": "IT Services",
                                            "id": "it_services",
                                            "sub_industries": [
                                                "Data Processing & Outsourced Services",
                                                "Internet Services & Infrastructure",
                                                "IT Consulting & Other Services"
                                            ]
                                        },
                                        {
                                            "name": "Software",
                                            "id": "software",
                                            "sub_industries": [
                                                "Systems Software",
                                                "Application Software",
                                                "Home Entertainment Software"
                                            ]
                                        },
                                        {
                                            "name": "Internet Software & Services",
                                            "id": "internet_software_services",
                                            "sub_industries": [
                                                "Internet Software & Services"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "name": "Communication Services",
                            "id": "communication_services",
                            "industry_groups": [
                                {
                                    "name": "Media & Entertainment",
                                    "id": "media_entertainment",
                                    "industries": [
                                        {
                                            "name": "Media",
                                            "id": "media",
                                            "sub_industries": [
                                                "Cable & Satellite",
                                                "Broadcasting",
                                                "Publishing",
                                                "Advertising"
                                            ]
                                        },
                                        {
                                            "name": "Entertainment",
                                            "id": "entertainment",
                                            "sub_industries": [
                                                "Movies & Entertainment",
                                                "Interactive Home Entertainment"
                                            ]
                                        },
                                        {
                                            "name": "Interactive Media & Services",
                                            "id": "interactive_media_services",
                                            "sub_industries": [
                                                "Interactive Media & Services"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "name": "Telecommunication Services",
                                    "id": "telecommunication_services",
                                    "industries": [
                                        {
                                            "name": "Diversified Telecommunication Services",
                                            "id": "diversified_telecommunication_services",
                                            "sub_industries": [
                                                "Alternative Carriers",
                                                "Integrated Telecommunication Services"
                                            ]
                                        },
                                        {
                                            "name": "Wireless Telecommunication Services",
                                            "id": "wireless_telecommunication_services",
                                            "sub_industries": [
                                                "Wireless Telecommunication Services"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "name": "Energy",
                            "id": "energy",
                            "industry_groups": [
                                {
                                    "name": "Energy Fuel",
                                    "id": "energy_fuel",
                                    "industries": [
                                        {
                                            "name": "Oil, Gas & Consumable Fuels",
                                            "id": "oil_gas_consumable_fuels",
                                            "sub_industries": [
                                                "Oil & Gas Refining & Marketing",
                                                "Integrated Oil & Gas",
                                                "Oil & Gas Storage & Transportation",
                                                "Coal & Consumable Fuels",
                                                "Oil & Gas Exploration & Production"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "name": "Energy Service",
                                    "id": "energy_service",
                                    "industries": [
                                        {
                                            "name": "Energy Equipment & Services",
                                            "id": "energy_equipment_services",
                                            "sub_industries": [
                                                "Oil & Gas Equipment & Services",
                                                "Oil & Gas Drilling"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "name": "Consumer Discretionary",
                            "id": "consumer_discretionary",
                            "industry_groups": [
                                {
                                    "name": "Consumer Durables & Apparel",
                                    "id": "consumer_durables_apparel",
                                    "industries": [
                                        {
                                            "name": "Household Durables",
                                            "id": "household_durables",
                                            "sub_industries": [
                                                "Consumer Electronics",
                                                "Housewares & Specialties",
                                                "Homebuilding",
                                                "Home Furnishings",
                                                "Household Appliances"
                                            ]
                                        },
                                        {
                                            "name": "Leisure Products",
                                            "id": "leisure_products",
                                            "sub_industries": [
                                                "Leisure Products"
                                            ]
                                        },
                                        {
                                            "name": "Textiles, Apparel & Luxury Goods",
                                            "id": "textiles_apparel_luxury_goods",
                                            "sub_industries": [
                                                "Apparel, Accessories & Luxury Goods",
                                                "Footwear",
                                                "Textiles"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "name": "Consumer Services",
                                    "id": "consumer_services",
                                    "industries": [
                                        {
                                            "name": "Hotels, Restaurants & Leisure",
                                            "id": "hotels_restaurants_leisure",
                                            "sub_industries": [
                                                "Casinos & Gaming",
                                                "Hotels, Resorts & Cruise Lines",
                                                "Leisure Facilities",
                                                "Restaurants"
                                            ]
                                        },
                                        {
                                            "name": "Diversified Consumer Services",
                                            "id": "diversified_consumer_services",
                                            "sub_industries": [
                                                "Education Services",
                                                "Specialized Consumer Services"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "name": "Automobiles & Components",
                                    "id": "automobiles_components",
                                    "industries": [
                                        {
                                            "name": "Auto Components",
                                            "id": "auto_components",
                                            "sub_industries": [
                                                "Tires & Rubber",
                                                "Auto Parts & Equipment"
                                            ]
                                        },
                                        {
                                            "name": "Automobiles",
                                            "id": "automobiles",
                                            "sub_industries": [
                                                "Motorcycle Manufacturers",
                                                "Automobile Manufacturers"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "name": "Retailing",
                                    "id": "retailing",
                                    "industries": [
                                        {
                                            "name": "Multiline Retail",
                                            "id": "multiline_retail",
                                            "sub_industries": [
                                                "Department Stores",
                                                "General Merchandise Stores"
                                            ]
                                        },
                                        {
                                            "name": "Specialty Retail",
                                            "id": "specialty_retail",
                                            "sub_industries": [
                                                "Apparel Retail",
                                                "Homefurnishing Retail",
                                                "Automotive Retail",
                                                "Specialty Stores",
                                                "Computer & Electronics Retail",
                                                "Home Improvement Retail"
                                            ]
                                        },
                                        {
                                            "name": "Distributors",
                                            "id": "distributors",
                                            "sub_industries": [
                                                "Distributors"
                                            ]
                                        },
                                        {
                                            "name": "Internet & Direct Marketing Retail",
                                            "id": "internet_direct_marketing_retail",
                                            "sub_industries": [
                                                "Internet & Direct Marketing Retail"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "name": "Media",
                                    "id": "media_consumer_discretionary",
                                    "industries": [
                                        {
                                            "name": "Diversified Media Services",
                                            "id": "diversified_media_services",
                                            "sub_industries": [
                                                "Advertising",
                                                "Movies & Entertainment",
                                                "Publishing",
                                                "Cable & Satellite",
                                                "Broadcasting"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                };

                // Store data in window for accessibility
                window.industryClassificationData = industryData;

                // Populate Sectors
                const sectorDropdown = document.getElementById('sector-dropdown');
                industryData.sectors.forEach(sector => {
                    const option = document.createElement('option');
                    option.value = sector.id;
                    option.textContent = sector.name;
                    sectorDropdown.appendChild(option);
                });

                // Add cascade event listeners
                document.getElementById('sector-dropdown').addEventListener('change', (e) => this.handleSectorChange(e));
                document.getElementById('industry-group-dropdown').addEventListener('change', (e) => this.handleIndustryGroupChange(e));
                document.getElementById('industry-dropdown').addEventListener('change', (e) => this.handleIndustryChange(e));
            }

            handleSectorChange(e) {
                const sectorId = e.target.value;
                const industryGroupDropdown = document.getElementById('industry-group-dropdown');
                const industryDropdown = document.getElementById('industry-dropdown');
                const subIndustryDropdown = document.getElementById('sub-industry-dropdown');

                // Reset dependent dropdowns
                industryGroupDropdown.innerHTML = '<option value="">Select Industry Group</option>';
                industryDropdown.innerHTML = '<option value="">Select Industry</option>';
                subIndustryDropdown.innerHTML = '<option value="">Select Sub-Industry</option>';
                industryGroupDropdown.disabled = true;
                industryDropdown.disabled = true;
                subIndustryDropdown.disabled = true;

                if (!sectorId) return;

                const sector = window.industryClassificationData.sectors.find(s => s.id === sectorId);
                if (sector && sector.industry_groups) {
                    sector.industry_groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = group.name;
                        industryGroupDropdown.appendChild(option);
                    });
                    industryGroupDropdown.disabled = false;
                }
            }

            handleIndustryGroupChange(e) {
                const sectorId = document.getElementById('sector-dropdown').value;
                const groupId = e.target.value;
                const industryDropdown = document.getElementById('industry-dropdown');
                const subIndustryDropdown = document.getElementById('sub-industry-dropdown');

                // Reset dependent dropdowns
                industryDropdown.innerHTML = '<option value="">Select Industry</option>';
                subIndustryDropdown.innerHTML = '<option value="">Select Sub-Industry</option>';
                industryDropdown.disabled = true;
                subIndustryDropdown.disabled = true;

                if (!groupId || !sectorId) return;

                const sector = window.industryClassificationData.sectors.find(s => s.id === sectorId);
                const group = sector?.industry_groups?.find(g => g.id === groupId);

                if (group && group.industries) {
                    group.industries.forEach(industry => {
                        const option = document.createElement('option');
                        option.value = industry.id;
                        option.textContent = industry.name;
                        industryDropdown.appendChild(option);
                    });
                    industryDropdown.disabled = false;
                }
            }

            handleIndustryChange(e) {
                const sectorId = document.getElementById('sector-dropdown').value;
                const groupId = document.getElementById('industry-group-dropdown').value;
                const industryId = e.target.value;
                const subIndustryDropdown = document.getElementById('sub-industry-dropdown');

                // Reset dependent dropdown
                subIndustryDropdown.innerHTML = '<option value="">Select Sub-Industry</option>';
                subIndustryDropdown.disabled = true;

                if (!industryId || !groupId || !sectorId) return;

                const sector = window.industryClassificationData.sectors.find(s => s.id === sectorId);
                const group = sector?.industry_groups?.find(g => g.id === groupId);
                const industry = group?.industries?.find(i => i.id === industryId);

                if (industry && industry.sub_industries) {
                    industry.sub_industries.forEach(subIndustry => {
                        const option = document.createElement('option');
                        option.value = subIndustry;
                        option.textContent = subIndustry;
                        subIndustryDropdown.appendChild(option);
                    });
                    subIndustryDropdown.disabled = false;
                }
            }

            async autoGenerateCompanies(marketName) {
                try {
                    const droppedCompaniesContainer = document.querySelector('.dropped-companies');
                    
                    // Check if companies are already generated
                    const existingCompanies = Array.from(droppedCompaniesContainer.querySelectorAll('.dropped-item span'))
                        .map(span => span.textContent.trim())
                        .filter(c => c);
                    
                    if (existingCompanies.length >= 20) {
                        // Already have 20 companies, skip generation
                        return;
                    }
                    
                    // Collect scraped company names from results (similar to segments)
                    const scrapedCompaniesRaw = [];
                    if (Array.isArray(this.results)) {
                        this.results.forEach(r => {
                            // Look for company_profiles, companies, or similar fields
                            if (r && Array.isArray(r.company_profiles)) {
                                scrapedCompaniesRaw.push(...r.company_profiles);
                            } else if (r && Array.isArray(r.companies)) {
                                scrapedCompaniesRaw.push(...r.companies);
                            } else if (r && r.company_names && Array.isArray(r.company_names)) {
                                scrapedCompaniesRaw.push(...r.company_names);
                            }
                        });
                    }
                    
                    // Deduplicate scraped companies
                    const scrapedCompanies = Array.from(new Set(scrapedCompaniesRaw
                        .map(c => typeof c === 'string' ? c.trim() : '')
                        .filter(Boolean)));
                    
                    // Show loading state
                    const loadingMsg = document.createElement('div');
                    loadingMsg.className = 'loading-companies';
                    loadingMsg.textContent = 'Generating companies...';
                    loadingMsg.style.cssText = 'padding: 8px 12px; color: #666; font-size: 13px; text-align: center;';
                    droppedCompaniesContainer.appendChild(loadingMsg);
                    
                    // Call the backend to generate companies - pass both scraped and existing companies
                    const allScrapedCompanies = [...scrapedCompanies, ...existingCompanies];
                    const response = await fetch('/api/generate-companies', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            market_name: marketName,
                            scraped_companies: allScrapedCompanies.length > 0 ? allScrapedCompanies : undefined
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to generate companies');
                    }
                    
                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    // Remove loading message
                    loadingMsg.remove();
                    
                    // Clear existing companies
                    droppedCompaniesContainer.innerHTML = '';
                    
                    // Add 20 generated companies as bullet points
                    if (result.COMPANY_PROFILES && Array.isArray(result.COMPANY_PROFILES)) {
                        result.COMPANY_PROFILES.forEach((company, index) => {
                            const item = document.createElement('div');
                            item.classList.add('dropped-item', 'company');
                            item.dataset.type = 'company';
                            
                            item.innerHTML = `
                                <span>${this.escapeHtml(company)}</span>
                                <div class="item-controls">
                                    <button class="edit-button" data-action="edit">Edit</button>
                                    <button class="close-button">
                                        <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                            <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                            <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                </div>
                            `;
                            
                            // Add edit button functionality
                            item.querySelector('[data-action="edit"]').addEventListener('click', () => {
                                this.editCompany(item);
                            });
                            
                            // Add close button functionality
                            item.querySelector('.close-button').addEventListener('click', () => {
                                item.remove();
                            });
                            
                            droppedCompaniesContainer.appendChild(item);
                        });
                        
                        const scrapedCount = scrapedCompanies.length;
                        const msg = scrapedCount > 0 
                            ? `Generated 20 company profiles (${scrapedCount} from scraped data)` 
                            : 'Generated 20 company profiles';
                        this.showNotification(msg, 'success');
                    }
                } catch (error) {
                    console.error('Error generating companies:', error);
                    this.showNotification(`Error generating companies: ${error.message}`, 'error');
                }
            }

            async handleAIGenerateCompanies() {
                const title = document.querySelector('#report-title')?.value?.trim();
                
                if (!title) {
                    this.showNotification('Please enter a market title first.', 'warning');
                    return;
                }
                
                const aiButton = document.getElementById('ai-generate-companies');
                const originalText = aiButton.innerHTML;
                aiButton.innerHTML = '<span class="loading-spinner"></span> Generating...';
                aiButton.disabled = true;
                
                try {
                    await this.autoGenerateCompanies(title);
                } catch (error) {
                    console.error('Error in handleAIGenerateCompanies:', error);
                    this.showNotification(`Error: ${error.message}`, 'error');
                } finally {
                    aiButton.innerHTML = originalText;
                    aiButton.disabled = false;
                }
            }

            editCompany(companyElement) {
                const span = companyElement.querySelector('span');
                const currentText = span.textContent;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentText;
                input.className = 'edit-input';
                
                span.style.display = 'none';
                companyElement.querySelector('.item-controls').style.display = 'none';
                companyElement.insertBefore(input, companyElement.firstChild);
                
                input.focus();
                input.select();
                
                const saveEdit = () => {
                    const newText = input.value.trim();
                    if (newText && newText !== currentText) {
                        span.textContent = newText;
                        this.showNotification(`Company updated to "${newText}"`, 'info');
                    }
                    
                    input.remove();
                    span.style.display = '';
                    companyElement.querySelector('.item-controls').style.display = 'flex';
                };
                
                const cancelEdit = () => {
                    input.remove();
                    span.style.display = '';
                    companyElement.querySelector('.item-controls').style.display = 'flex';
                };
                
                input.addEventListener('blur', saveEdit);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        saveEdit();
                    } else if (e.key === 'Escape') {
                        cancelEdit();
                    }
                });
            }

            bindEvents() {
                const selectors = {
                    processButton: '.process-button',
                    linksInput: '.links-input',
                    tabButtons: '.tab-button',
                    segmentsDropzone: '.segments-dropzone',
                    companiesDropzone: '.companies-dropzone',
                    deleteButton: '.delete-button',
                    generateButton: '.generate-item-button',
                    downloadButton: '.download-button',
                    viewSegmentsToggle: '.view-segments-toggle',
                    clearSegmentsButton: '#clear-segments',
                    submitButton: '.submit-button',
                    creatorSelect: '.creator-select',
                    reportTitle: '#report-title'
                };

                const processButton = document.querySelector(selectors.processButton);
                processButton.addEventListener('click', () => this.processLinks());

                const linksInput = document.querySelector(selectors.linksInput);
                linksInput.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        this.processLinks();
                    }
                });

                document.querySelectorAll(selectors.tabButtons).forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                const segmentsDropzone = document.querySelector(selectors.segmentsDropzone);
                segmentsDropzone.addEventListener('dragover', this.handleDragOver.bind(this));
                segmentsDropzone.addEventListener('drop', this.handleDrop.bind(this, 'segments'));
                segmentsDropzone.addEventListener('dragleave', this.handleDragLeave.bind(this));

                const companiesDropzone = document.querySelector(selectors.companiesDropzone);
                companiesDropzone.addEventListener('dragover', this.handleDragOver.bind(this));
                companiesDropzone.addEventListener('drop', this.handleDrop.bind(this, 'companies'));
                companiesDropzone.addEventListener('dragleave', this.handleDragLeave.bind(this));

                const deleteButton = document.querySelector(selectors.deleteButton);
                deleteButton.addEventListener('click', () => this.clearComparison());

                const generateButton = document.getElementById('generate-report-btn') || document.querySelector(selectors.generateButton);
                if (generateButton) {
                    generateButton.addEventListener('click', () => this.generateReport());
                }

                const downloadButton = document.querySelector(selectors.downloadButton);
                downloadButton.addEventListener('click', () => this.downloadReport());

                const generateExcelButton = document.querySelector('.generate-excel-button');
                if (generateExcelButton) {
                    generateExcelButton.addEventListener('click', () => this.generateExcel());
                }

                // Removed: submitButton event listener - creator role removed

                const viewSegmentsToggle = document.querySelector(selectors.viewSegmentsToggle);
                viewSegmentsToggle.addEventListener('click', () => this.toggleSegmentsViewer());

                const clearSegmentsButton = document.querySelector(selectors.clearSegmentsButton);
                clearSegmentsButton.addEventListener('click', () => this.clearAllSegments());

                // Bulk import segments
                const importBulkBtn = document.getElementById('import-bulk-segments-btn');
                if (importBulkBtn) {
                    importBulkBtn.addEventListener('click', () => this.handleBulkImportSegments());
                }
                // Get All Segments -> copy View Segments into Bulk Import textarea
                const getAllSegmentsBtn = document.getElementById('get-all-segments-btn');
                if (getAllSegmentsBtn) {
                    getAllSegmentsBtn.addEventListener('click', () => this.handleGetAllSegments());
                }

                // Add save data button event listener
                const saveDataBtn = document.getElementById('save-data-btn');
                if (saveDataBtn) {
                    saveDataBtn.addEventListener('click', () => this.saveAllData());
                }

                // Add Generate TOC button event listener
                const generateTocBtn = document.getElementById('generate-toc-btn');
                if (generateTocBtn) {
                    generateTocBtn.addEventListener('click', () => this.generateTOC());
                }

                // Add Generate Short RD button event listener
                const generateShortRdBtn = document.getElementById('generate-short-rd-btn');
                if (generateShortRdBtn) {
                    generateShortRdBtn.addEventListener('click', () => this.generateShortRD());
                }

                document.querySelectorAll('.manual-switch').forEach(switchElem => {
                    switchElem.addEventListener('change', (e) => {
                        const section = e.target.dataset.section;
                        const manualEntry = document.querySelector(`.manual-entry[data-section="${section}"]`);
                        manualEntry.style.display = e.target.checked ? 'flex' : 'none';
                        // Preserve current active dropzone selections when opening manual entry
                        // so users can continue adding to selected AI sub-levels without reselecting.
                    });
                });

                document.querySelectorAll('.add-manual-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const section = e.target.dataset.section;
                        this.handleManualAdd(section);
                    });
                });

                // Add AI generation button event listener
                const aiGenerateButton = document.getElementById('ai-generate-segments');
                if (aiGenerateButton) {
                    aiGenerateButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.generateAISegments(true);
                    });
                }

                // Add AI generation button for companies
                const aiGenerateCompaniesButton = document.getElementById('ai-generate-companies');
                if (aiGenerateCompaniesButton) {
                    aiGenerateCompaniesButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.handleAIGenerateCompanies();
                    });
                }

                // Add Clear All button for companies
                const clearCompaniesButton = document.getElementById('clear-companies');
                if (clearCompaniesButton) {
                    clearCompaniesButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const droppedCompanies = document.querySelector('.dropped-companies');
                        droppedCompanies.innerHTML = '';
                        this.showNotification('Companies cleared.', 'info');
                    });
                }

                // Copy Segments button
                const copySegBtn = document.getElementById('copy-segments-btn');
                if (copySegBtn) {
                    copySegBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const segments = this.collectAllSegmentsForViewer();
                        if (!segments || segments.length === 0) {
                            this.showNotification('No segments to copy.', 'warning');
                            return;
                        }
                        this._copyText(segments.join('\n'), copySegBtn, 'Segments copied to clipboard.', 'Copy failed.');
                    });
                }

                // Copy Companies button
                const copyCompBtn = document.getElementById('copy-companies-btn');
                if (copyCompBtn) {
                    copyCompBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const companies = Array.from(document.querySelectorAll('.dropped-companies .dropped-item span')).map(span => span.textContent.trim());
                        if (!companies.length) {
                            this.showNotification('No companies to copy.', 'warning');
                            return;
                        }
                        this._copyText(companies.join('\n'), copyCompBtn, 'Companies copied to clipboard.', 'Copy failed.');
                    });
                }

                // Add Decrement Level (-1 level) button listener
                const decrementLevelBtn = document.getElementById('decrement-level');
                if (decrementLevelBtn) {
                    decrementLevelBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.goUpOneLevel();
                    });
                }
            }

            // Removed: fetchCreators() - creator role removed

            _copyText(text, btn, successMsg, failMsg) {
                const orig = btn.textContent;
                const onSuccess = () => {
                    btn.textContent = 'âœ“ Copied!';
                    setTimeout(() => { btn.textContent = orig; }, 1500);
                    this.showNotification(successMsg, 'success');
                };
                const onFail = () => {
                    btn.textContent = 'âœ— Failed';
                    setTimeout(() => { btn.textContent = orig; }, 1500);
                    this.showNotification(failMsg, 'error');
                };
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(onSuccess).catch(() => {
                        // fallback for HTTP
                        try {
                            const ta = document.createElement('textarea');
                            ta.value = text;
                            ta.style.cssText = 'position:fixed;top:-9999px;left:-9999px;opacity:0';
                            document.body.appendChild(ta);
                            ta.focus();
                            ta.select();
                            const ok = document.execCommand('copy');
                            document.body.removeChild(ta);
                            ok ? onSuccess() : onFail();
                        } catch (e) { onFail(); }
                    });
                } else {
                    try {
                        const ta = document.createElement('textarea');
                        ta.value = text;
                        ta.style.cssText = 'position:fixed;top:-9999px;left:-9999px;opacity:0';
                        document.body.appendChild(ta);
                        ta.focus();
                        ta.select();
                        const ok = document.execCommand('copy');
                        document.body.removeChild(ta);
                        ok ? onSuccess() : onFail();
                    } catch (e) { onFail(); }
                }
            }

            clearAllSegments() {
                const droppedSegments = document.querySelector('.dropped-segments');
                droppedSegments.innerHTML = '';
                
                // Reset active dropzone states
                this.activeSubSegmentDropzone = null;
                this.activeSubSubSegmentDropzone = null;
                this.activeSubSubSubSegmentDropzone = null;
                this.activeSubSubSubSubSegmentDropzone = null;
                
                // Update segments viewer if visible
                if (this.segmentsViewerVisible) {
                    this.updateSegmentsViewer();
                }
                
                this.showNotification('All segments cleared.', 'info');
            }

            addLevel1Segment() {
                const droppedItems = document.querySelector('.dropped-segments');
                const segmentCount = Array.from(droppedItems.children).filter(child => child.dataset.type === 'segment').length + 1;
                const item = document.createElement('div');
                item.classList.add('dropped-item', 'segment');
                item.dataset.type = 'segment';
                const displayText = `${segmentCount}. New Segment`;

                item.innerHTML = `
                    <span>${this.escapeHtml(displayText)}</span>
                    <div class="item-controls">
                        <button class="edit-button" data-action="edit">Edit</button>
                        <button class="add-subsegment-button" data-action="add-subsegment">+ lvl-2</button>
                        <button class="close-button">
                            <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                `;

                const subSegmentSection = document.createElement('div');
                subSegmentSection.classList.add('subsegment-section');
                subSegmentSection.dataset.parentSegment = "New Segment";
                subSegmentSection.innerHTML = `
                    <div class="subsegment-dropzone">
                        <p class="dropzone-text">Drag and drop sub-segments here</p>
                    </div>
                    <div class="dropped-subsegments"></div>
                `;

                droppedItems.appendChild(item);
                droppedItems.appendChild(subSegmentSection);

                const subSegmentDropzone = subSegmentSection.querySelector('.subsegment-dropzone');
                subSegmentDropzone.addEventListener('dragover', this.handleDragOver.bind(this));
                subSegmentDropzone.addEventListener('drop', this.handleSubSegmentDrop.bind(this, subSegmentSection));
                subSegmentDropzone.addEventListener('dragleave', this.handleDragLeave.bind(this));

                item.querySelector('[data-action="add-subsegment"]').addEventListener('click', () => {
                    const isActive = subSegmentSection.classList.contains('active');
                    // Only deactivate other sections at the same level, not all sections
                    document.querySelectorAll('.subsegment-section').forEach(section => {
                        if (section !== subSegmentSection) {
                            section.classList.remove('active');
                        }
                    });
                    if (!isActive) {
                        subSegmentSection.classList.add('active');
                        this.activeSubSegmentDropzone = subSegmentSection;
                    }
                    this.renumberSegments();
                });

                // Add edit functionality
                item.querySelector('[data-action="edit"]').addEventListener('click', () => {
                    this.editSegment(item);
                });

                item.querySelector('.close-button').addEventListener('click', () => {
                    item.remove();
                    subSegmentSection.remove();
                    this.renumberSegments();
                });

                this.renumberSegments();
                
                // Update segments viewer if visible
                if (this.segmentsViewerVisible) {
                    this.updateSegmentsViewer();
                }
            }

            async generateAISegments(userTriggered = false) {
                // Prevent automatic execution
                if (!userTriggered) {
                    return;
                }

                const titleInput = document.getElementById('report-title');
                const title = titleInput ? titleInput.value.trim() : '';
                
                // Collect scraped segments from results
                const scrapedSegmentsRaw = [];
                if (Array.isArray(this.results)) {
                    this.results.forEach(r => {
                        if (r && Array.isArray(r.table_of_contents)) {
                            scrapedSegmentsRaw.push(...r.table_of_contents);
                        }
                    });
                }
                const scrapedSegments = Array.from(new Set(scrapedSegmentsRaw
                    .map(s => typeof s === 'string' ? s.replace(/^\d+(?:\.\d+)*\.\s*/, '').trim() : '')
                    .filter(Boolean)));
                
                // If no scraped segments, require title and then generate independently based on title
                const useTitleOnly = scrapedSegments.length === 0;
                if (useTitleOnly && !title) {
                    this.showNotification('Please enter a title first to generate AI segments.', 'warning');
                    return;
                }

                const aiButton = document.getElementById('ai-generate-segments');
                
                // Show loading state
                const originalText = aiButton.innerHTML;
                aiButton.innerHTML = '<span class="loading-spinner"></span> Generating...';
                aiButton.disabled = true;

                try {
                    let response;
                    if (useTitleOnly) {
                        // Fallback: generate segments purely from title
                        response = await fetch('/api/generate-ai-segments', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title })
                        });
                    } else {
                        // Primary: analyze scraped segments with optional title context
                        response = await fetch('/api/analyze-ai-segments', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title, scraped_segments: scrapedSegments })
                        });
                    }

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to generate segments');
                    }

                    // Preserve original AI-generated segments exactly as returned (immutable copy)
                    if (result.segments && Array.isArray(result.segments)) {
                        // Immutable deep copy stored separately so user edits won't change it
                        this.originalAiSegments = JSON.parse(JSON.stringify(result.segments));
                        // Console log for testing: show length and a small sample (first 3)
                        try {
                            console.log('originalAiSegments set (source: AI generation)', { length: this.originalAiSegments.length, sample: this.originalAiSegments.slice(0, 3) });
                        } catch (e) { console.warn('Failed to log originalAiSegments', e); }
                        // Also keep a JSON wrapper for backward compatibility (do not mutate this)
                        this.aiSegmentsJSON = { segments: JSON.parse(JSON.stringify(result.segments)) };
                    }

                    // Clear existing segments
                    const droppedSegments = document.querySelector('.dropped-segments');
                    droppedSegments.innerHTML = '';

                    // Add generated segments
                    if (result.segments && Array.isArray(result.segments)) {
                        this.addAIGeneratedSegments(result.segments, droppedSegments, 1);
                        // Snapshot AI segments flattened for submission metadata
                        this.aiSegmentsSnapshotFlat = this.flattenSegments(result.segments);
                        // Reset change log when new AI set arrives
                        this.segmentChangeLog = [];
                    }
                    
                    this.showNotification('AI segments generated successfully!', 'success');

                } catch (error) {
                    console.error('Error generating AI segments:', error);
                    this.showNotification(`Error: ${error.message}`, 'error');
                } finally {
                    // Restore button state
                    aiButton.innerHTML = originalText;
                    aiButton.disabled = false;
                }
            }

            flattenSegments(segments) {
                const out = [];
                const walk = (arr, prefix = '') => {
                    (arr || []).forEach((seg, idx) => {
                        const num = prefix ? `${prefix}.${idx + 1}` : `${idx + 1}`;
                        out.push(`${num}. ${seg.name}`);
                        if (Array.isArray(seg.subsegments) && seg.subsegments.length) {
                            walk(seg.subsegments, num);
                        }
                    });
                };
                walk(segments, '');
                return out;
            }

            // Parse bulk segments pasted by user into hierarchical tree structure
            parseBulkSegmentsToTree(text) {
                if (!text || !text.trim()) return [];
                const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                const pattern = /^(\d+(?:\.\d+)*)\.\s+(.*)$/;

                // First pass: create nodes map and preserve input order
                const order = [];
                const map = {};

                lines.forEach(line => {
                    const m = line.match(pattern);
                    if (!m) return; // skip invalid lines
                    const key = m[1];
                    const name = m[2].trim();
                    if (map[key]) return; // duplicate key - skip
                    map[key] = { name: name, subsegments: [] };
                    order.push(key);
                });

                // Second pass: attach nodes to parents when possible, otherwise root
                const roots = [];
                order.forEach(key => {
                    const node = map[key];
                    const parts = key.split('.');
                    if (parts.length === 1) {
                        roots.push(node);
                    } else {
                        const parentKey = parts.slice(0, -1).join('.');
                        if (map[parentKey]) {
                            map[parentKey].subsegments.push(node);
                        } else {
                            // Parent missing: fallback to root
                            roots.push(node);
                        }
                    }
                });

                return roots;
            }

            async handleBulkImportSegments() {
                const txt = (document.getElementById('bulk-segments-input') || {}).value || '';
                const parsed = this.parseBulkSegmentsToTree(txt);
                if (!parsed || parsed.length === 0) {
                    this.showNotification('No valid segments found in input.', 'error');
                    return;
                }

                // Clear existing segments and add parsed segments using existing renderer
                this.clearAllSegments();
                const droppedSegments = document.querySelector('.dropped-segments');
                this.addAIGeneratedSegments(parsed, droppedSegments, 1);

                if (this.segmentsViewerVisible) {
                    this.updateSegmentsViewer();
                }

                this.showNotification('Bulk segments imported successfully!', 'success');
            }

            handleGetAllSegments() {
                const textarea = document.getElementById('bulk-segments-input');
                if (!textarea) return;

                const segments = this.collectAllSegmentsForViewer();
                if (!segments || segments.length === 0) {
                    this.showNotification('No segments to copy.', 'warning');
                    return;
                }

                // Join segments with newline and paste into textarea
                textarea.value = segments.join('\n');

                // Bring focus to textarea for quick editing
                textarea.focus();

                this.showNotification('All segments copied to Bulk Segments Import textarea.', 'success');
            }

            addAIGeneratedSegments(segments, parentContainer = null, level = 1, parentNumber = '', parentData = {}) {
                // Stop at level 5
                if (level > 5) {
                    return;
                }
                
                const container = parentContainer || document.querySelector('.dropped-segments');
                
                if (!segments || !Array.isArray(segments)) {
                    console.error('Invalid segments array:', segments);
                    return;
                }
                
                segments.forEach((segment, index) => {
                    const currentNumber = parentNumber ? `${parentNumber}.${index + 1}` : `${index + 1}`;
                    
                    // Build parent data for this segment
                    const currentParentData = { ...parentData };
                    if (level === 1) {
                        currentParentData.parentSegment = segment.name;
                    } else if (level === 2) {
                        currentParentData.parentSubSegment = segment.name;
                    } else if (level === 3) {
                        currentParentData.parentSubSubSegment = segment.name;
                    } else if (level === 4) {
                        currentParentData.parentSubSubSubSegment = segment.name;
                    }
                    
                    const segmentItem = this.createSegmentItem(segment.name, level, index + 1, currentNumber, currentParentData);
                    container.appendChild(segmentItem);
                    
                    if (segment.subsegments && segment.subsegments.length > 0 && level < 5) {
                        const subsegmentSection = this.createSubsegmentSection(segment.name, level);
                        subsegmentSection.classList.add('active');
                        
                        // Set additional parent data attributes for proper drop handling at deeper levels
                        if (level >= 2 && parentData.parentSegment) {
                            subsegmentSection.dataset.parentSegment = parentData.parentSegment;
                        }
                        if (level >= 3 && parentData.parentSubSegment) {
                            subsegmentSection.dataset.parentSubSegment = parentData.parentSubSegment;
                        }
                        if (level >= 4 && parentData.parentSubSubSegment) {
                            subsegmentSection.dataset.parentSubSubSegment = parentData.parentSubSubSegment;
                        }
                        
                        container.appendChild(subsegmentSection);
                        
                        // Add drop zone event listeners for AI-generated sections
                        this.addDropZoneListeners(subsegmentSection, level);
                        
                        // Get the correct container class based on the level
                        let containerClass;
                        switch(level) {
                            case 1:
                                containerClass = '.dropped-subsegments';
                                break;
                            case 2:
                                containerClass = '.dropped-subsubsegments';
                                break;
                            case 3:
                                containerClass = '.dropped-subsubsubsegments';
                                break;
                            case 4:
                                containerClass = '.dropped-subsubsubsubsegments';
                                break;
                            default:
                                containerClass = '.dropped-subsegments';
                        }
                        
                        const targetContainer = subsegmentSection.querySelector(containerClass);
                        
                        if (targetContainer) {
                            segment.subsegments.forEach((subsegment, subIndex) => {
                                this.createAIDroppedItem(subsegment, targetContainer, level, currentNumber, subIndex + 1, currentParentData);
                            });
                        }
                    }
                });
                
                this.renumberSegments();
            }

            addDropZoneListeners(subsegmentSection, level) {
                let dropzoneClass;
                switch(level) {
                    case 1:
                        dropzoneClass = '.subsegment-dropzone';
                        break;
                    case 2:
                        dropzoneClass = '.subsubsegment-dropzone';
                        break;
                    case 3:
                        dropzoneClass = '.subsubsubsegment-dropzone';
                        break;
                    case 4:
                        dropzoneClass = '.subsubsubsubsegment-dropzone';
                        break;
                    default:
                        dropzoneClass = '.subsegment-dropzone';
                }
                
                const dropzone = subsegmentSection.querySelector(dropzoneClass);
                if (dropzone) {
                    dropzone.addEventListener('dragover', this.handleDragOver.bind(this));
                    dropzone.addEventListener('dragleave', this.handleDragLeave.bind(this));
                    
                    switch(level) {
                        case 1:
                            dropzone.addEventListener('drop', this.handleSubSegmentDrop.bind(this, subsegmentSection));
                            break;
                        case 2:
                            dropzone.addEventListener('drop', this.handleSubSubSegmentDrop.bind(this, subsegmentSection));
                            break;
                        case 3:
                            dropzone.addEventListener('drop', this.handleSubSubSubSegmentDrop.bind(this, subsegmentSection));
                            break;
                        case 4:
                            dropzone.addEventListener('drop', this.handleSubSubSubSubSegmentDrop.bind(this, subsegmentSection));
                            break;
                    }
                }
            }

            createAIDroppedItem(segment, targetContainer, level, parentNumber, subIndex, parentData) {
                // Limit to maximum level 5 (no level 6)
                if (level > 5) {
                    return;
                }
                
                // Create the dropped item element
                const droppedItem = document.createElement('div');
                droppedItem.classList.add('dropped-item');
                droppedItem.draggable = true;
                
                let itemClass, nextLevelButton, nextLevelSection, nextLevelDropzone;
                const displayNumber = `${parentNumber}.${subIndex}`;
                
                switch(level) {
                    case 1: // subsegment
                        itemClass = 'subsegment';
                        nextLevelButton = 'add-subsubsegment-button';
                        nextLevelSection = 'subsubsegment-section';
                        nextLevelDropzone = 'subsubsegment-dropzone';
                        droppedItem.dataset.parentSegment = parentData.parentSegment;
                        break;
                    case 2: // subsubsegment
                        itemClass = 'subsubsegment';
                        nextLevelButton = 'add-subsubsubsegment-button';
                        nextLevelSection = 'subsubsubsegment-section';
                        nextLevelDropzone = 'subsubsubsegment-dropzone';
                        droppedItem.dataset.parentSegment = parentData.parentSegment;
                        droppedItem.dataset.parentSubSegment = parentData.parentSubSegment;
                        break;
                    case 3: // subsubsubsegment
                        itemClass = 'subsubsubsegment';
                        nextLevelButton = 'add-subsubsubsubsegment-button';
                        nextLevelSection = 'subsubsubsubsegment-section';
                        nextLevelDropzone = 'subsubsubsubsegment-dropzone';
                        droppedItem.dataset.parentSegment = parentData.parentSegment;
                        droppedItem.dataset.parentSubSegment = parentData.parentSubSegment;
                        droppedItem.dataset.parentSubSubSegment = parentData.parentSubSubSegment;
                        break;
                    case 4: // subsubsubsubsegment
                        itemClass = 'subsubsubsubsegment';
                        nextLevelButton = ''; // No level 6 button
                        nextLevelSection = '';
                        nextLevelDropzone = '';
                        droppedItem.dataset.parentSegment = parentData.parentSegment;
                        droppedItem.dataset.parentSubSegment = parentData.parentSubSegment;
                        droppedItem.dataset.parentSubSubSegment = parentData.parentSubSubSegment;
                        droppedItem.dataset.parentSubSubSubSegment = parentData.parentSubSubSubSegment;
                        break;
                    default:
                        itemClass = 'subsegment';
                        nextLevelButton = 'add-subsubsegment-button';
                        nextLevelSection = 'subsubsegment-section';
                        nextLevelDropzone = 'subsubsegment-dropzone';
                        droppedItem.dataset.parentSegment = parentData.parentSegment;
                        break;
                }
                
                droppedItem.classList.add(itemClass);
                droppedItem.dataset.type = itemClass;
                
                const displayText = `${displayNumber}. ${segment.name}`;
                const actionType = itemClass ? itemClass.replace('segment', '') : 'sub';
                droppedItem.innerHTML = `
                    <span>${this.escapeHtml(displayText)}</span>
                    <div class="item-controls">
                        <button class="edit-button" data-action="edit">Edit</button>
                        ${level < 4 ? `<button class="${nextLevelButton}" data-action="add-${actionType}segment">+ lvl-${level + 2}</button>` : ''}
                        <button class="close-button">
                            <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                `;
                
                // Add event listeners for interactivity
                const closeButton = droppedItem.querySelector('.close-button');
                closeButton.addEventListener('click', () => {
                    droppedItem.remove();
                    const nextSibling = droppedItem.nextElementSibling;
                    if (nextSibling && (
                        nextSibling.classList.contains('subsegment-section') ||
                        nextSibling.classList.contains('subsubsegment-section') ||
                        nextSibling.classList.contains('subsubsubsegment-section') ||
                        nextSibling.classList.contains('subsubsubsubsegment-section')
                    )) {
                        nextSibling.remove();
                    }
                    this.renumberSegments();
                });

                // Add drag event listeners
                droppedItem.addEventListener('dragstart', this.handleDragStart.bind(this));
                droppedItem.addEventListener('dragend', this.handleDragEnd.bind(this));

                // Add edit functionality
                const editButton = droppedItem.querySelector('[data-action="edit"]');
                if (editButton) {
                    editButton.addEventListener('click', () => {
                        this.editSegment(droppedItem);
                    });
                }

                // Add level-specific button listeners (only up to level 4)
                if (level < 4) {
                    const levelButton = droppedItem.querySelector(`[data-action="add-${actionType}segment"]`);
                    if (levelButton) {
                        this.addLevelButtonListener(droppedItem, levelButton, level + 1, `add-${actionType}segment`);
                    }
                }
                
                // Create the next level section if we're not at the maximum level (level 5)
                if (level < 4) {
                    const nextSection = document.createElement('div');
                    nextSection.classList.add(nextLevelSection);
                    
                    // Set parent data attributes for the next section
                    if (level === 1) {
                        nextSection.dataset.parentSegment = parentData.parentSegment;
                        nextSection.dataset.parentSubSegment = segment.name;
                    } else if (level === 2) {
                        nextSection.dataset.parentSegment = parentData.parentSegment;
                        nextSection.dataset.parentSubSegment = parentData.parentSubSegment;
                        nextSection.dataset.parentSubSubSegment = segment.name;
                    } else if (level === 3) {
                        nextSection.dataset.parentSegment = parentData.parentSegment;
                        nextSection.dataset.parentSubSegment = parentData.parentSubSegment;
                        nextSection.dataset.parentSubSubSegment = parentData.parentSubSubSegment;
                        nextSection.dataset.parentSubSubSubSegment = segment.name;
                    }
                    
                    nextSection.innerHTML = `
                        <div class="${nextLevelDropzone}">
                            <p class="dropzone-text">Drag and drop sub-${'sub-'.repeat(level)}segments here</p>
                        </div>
                        <div class="dropped-${'sub'.repeat(level + 1)}segments"></div>
                    `;
                    
                    // Add to container
                    targetContainer.appendChild(droppedItem);
                    targetContainer.appendChild(nextSection);
                    
                    // Bind dropzone listeners via central helper for consistency
                    this.addDropZoneListeners(nextSection, level + 1);
                    
                    // Recursively create subsegments if they exist (but only up to level 5)
                    if (segment.subsegments && segment.subsegments.length > 0 && level < 4) {
                        const nextLevelContainer = nextSection.querySelector(`.dropped-${'sub'.repeat(level + 1)}segments`);
                        if (nextLevelContainer) {
                            nextSection.classList.add('active');
                            
                            const nextParentData = { ...parentData };
                            if (level === 1) {
                                nextParentData.parentSubSegment = segment.name;
                            } else if (level === 2) {
                                nextParentData.parentSubSubSegment = segment.name;
                            } else if (level === 3) {
                                nextParentData.parentSubSubSubSegment = segment.name;
                            }
                            
                            segment.subsegments.forEach((subsegment, subSubIndex) => {
                                this.createAIDroppedItem(subsegment, nextLevelContainer, level + 1, displayNumber, subSubIndex + 1, nextParentData);
                            });
                        }
                    }
                } else {
                    // For level 5 items, just add them without creating a next level section
                    targetContainer.appendChild(droppedItem);
                }
            }

            addLevelButtonListener(item, levelButton, level, buttonAction) {
                levelButton.addEventListener('click', () => {
                    const parentSegment = item.querySelector('span').textContent.replace(/^\d+(\.\d+)*\.\s*/, '');
                    
                switch(level) {
                    case 1: // Add subsegment
                        this.createSubsegmentSectionForAI(item, parentSegment);
                        this.activeManualTarget = { level: 1, sectionElem: this.activeSubSegmentDropzone };
                        break;
                    case 2: // Add subsubsegment
                        this.createSubsubsegmentSectionForAI(item, parentSegment);
                        this.activeManualTarget = { level: 2, sectionElem: this.activeSubSubSegmentDropzone };
                        break;
                    case 3: // Add subsubsubsegment
                        this.createSubsubsubsegmentSectionForAI(item, parentSegment);
                        this.activeManualTarget = { level: 3, sectionElem: this.activeSubSubSubSegmentDropzone };
                        break;
                    case 4: // Add subsubsubsubsegment
                        this.createSubsubsubsubsegmentSectionForAI(item, parentSegment);
                        this.activeManualTarget = { level: 4, sectionElem: this.activeSubSubSubSubSegmentDropzone };
                        break;
                }
                    this.renumberSegments();
                });
            }

            createSubsegmentSectionForAI(item, parentSegment) {
                const droppedItems = item.parentElement;
                let subSegmentSection = droppedItems.querySelector(`.subsegment-section[data-parent-segment="${parentSegment}"]`);
                
                if (!subSegmentSection) {
                    subSegmentSection = this.createSubsegmentSection(parentSegment, 1);
                    subSegmentSection.classList.add('active');
                    droppedItems.appendChild(subSegmentSection);
                    // Use centralized dropzone binding
                    this.addDropZoneListeners(subSegmentSection, 1);
                }
                
                subSegmentSection.classList.add('active');
                this.activeSubSegmentDropzone = subSegmentSection;
                this.activeManualTarget = { level: 1, sectionElem: subSegmentSection };
            }

            createSubsubsegmentSectionForAI(item, parentSubSegment) {
                const parentSegment = item.dataset.parentSegment;
                const droppedItems = item.parentElement;
                let subSubSegmentSection = droppedItems.querySelector(`.subsubsegment-section[data-parent-segment="${parentSegment}"][data-parent-sub-segment="${parentSubSegment}"]`);
                
                if (!subSubSegmentSection) {
                    subSubSegmentSection = this.createSubsegmentSection(parentSubSegment, 2);
                    subSubSegmentSection.classList.add('active');
                    subSubSegmentSection.dataset.parentSegment = parentSegment;
                    subSubSegmentSection.dataset.parentSubSegment = parentSubSegment;
                    droppedItems.appendChild(subSubSegmentSection);
                    // Use centralized dropzone binding
                    this.addDropZoneListeners(subSubSegmentSection, 2);
                }
                
                subSubSegmentSection.classList.add('active');
                this.activeSubSubSegmentDropzone = subSubSegmentSection;
                this.activeManualTarget = { level: 2, sectionElem: subSubSegmentSection };
            }

            createSubsubsubsegmentSectionForAI(item, parentSubSubSegment) {
                const parentSegment = item.dataset.parentSegment;
                const parentSubSegment = item.dataset.parentSubSegment;
                const droppedItems = item.parentElement;
                let subSubSubSegmentSection = droppedItems.querySelector(`.subsubsubsegment-section[data-parent-segment="${parentSegment}"][data-parent-sub-segment="${parentSubSegment}"][data-parent-sub-sub-segment="${parentSubSubSegment}"]`);
                
                if (!subSubSubSegmentSection) {
                    subSubSubSegmentSection = this.createSubsegmentSection(parentSubSubSegment, 3);
                    subSubSubSegmentSection.classList.add('active');
                    subSubSubSegmentSection.dataset.parentSegment = parentSegment;
                    subSubSubSegmentSection.dataset.parentSubSegment = parentSubSegment;
                    subSubSubSegmentSection.dataset.parentSubSubSegment = parentSubSubSegment;
                    droppedItems.appendChild(subSubSubSegmentSection);
                    // Use centralized dropzone binding
                    this.addDropZoneListeners(subSubSubSegmentSection, 3);
                }
                
                subSubSubSegmentSection.classList.add('active');
                this.activeSubSubSubSegmentDropzone = subSubSubSegmentSection;
                this.activeManualTarget = { level: 3, sectionElem: subSubSubSegmentSection };
            }

            createSubsubsubsubsegmentSectionForAI(item, parentSubSubSubSegment) {
                const parentSegment = item.dataset.parentSegment;
                const parentSubSegment = item.dataset.parentSubSegment;
                const parentSubSubSegment = item.dataset.parentSubSubSegment;
                const droppedItems = item.parentElement;
                let section = droppedItems.querySelector(`.subsubsubsubsegment-section[data-parent-segment="${parentSegment}"][data-parent-sub-segment="${parentSubSegment}"][data-parent-sub-sub-segment="${parentSubSubSegment}"][data-parent-sub-sub-sub-segment="${parentSubSubSubSegment}"]`);
                
                if (!section) {
                    section = this.createSubsegmentSection(parentSubSubSubSegment, 4);
                    section.classList.add('active');
                    section.dataset.parentSegment = parentSegment;
                    section.dataset.parentSubSegment = parentSubSegment;
                    section.dataset.parentSubSubSegment = parentSubSubSegment;
                    section.dataset.parentSubSubSubSegment = parentSubSubSubSegment;
                    droppedItems.appendChild(section);
                    // Use centralized dropzone binding
                    this.addDropZoneListeners(section, 4);
                }
                
                section.classList.add('active');
                this.activeSubSubSubSubSegmentDropzone = section;
                this.activeManualTarget = { level: 4, sectionElem: section };
            }

            createSegmentItem(name, level, index, hierarchicalNumber = null, parentData = {}) {
                const item = document.createElement('div');
                item.classList.add('dropped-item');
                item.draggable = true;
                
                // Add parent data attributes for tracking relationships
                if (parentData.parentSegment) item.dataset.parentSegment = parentData.parentSegment;
                if (parentData.parentSubSegment) item.dataset.parentSubSegment = parentData.parentSubSegment;
                if (parentData.parentSubSubSegment) item.dataset.parentSubSubSegment = parentData.parentSubSubSegment;
                if (parentData.parentSubSubSubSegment) item.dataset.parentSubSubSubSegment = parentData.parentSubSubSubSegment;
                
                let levelClass, buttonText, buttonAction;
                switch(level) {
                    case 1:
                        levelClass = 'segment';
                        buttonText = '+ lvl-2';
                        buttonAction = 'add-subsegment';
                        break;
                    case 2:
                        levelClass = 'subsegment';
                        buttonText = '+ lvl-3';
                        buttonAction = 'add-subsubsegment';
                        break;
                    case 3:
                        levelClass = 'subsubsegment';
                        buttonText = '+ lvl-4';
                        buttonAction = 'add-subsubsubsegment';
                        break;
                    case 4:
                        levelClass = 'subsubsubsegment';
                        buttonText = '+ lvl-5';
                        buttonAction = 'add-subsubsubsubsegment';
                        break;
                    case 5:
                        levelClass = 'subsubsubsubsegment';
                        buttonText = ''; // No button for level 6
                        buttonAction = '';
                        break;
                    default:
                        levelClass = 'segment';
                        buttonText = '+ lvl-2';
                        buttonAction = 'add-subsegment';
                }
                
                item.classList.add(levelClass);
                item.dataset.type = levelClass;
                item.draggable = true;
                
                const displayText = hierarchicalNumber ? `${hierarchicalNumber}. ${name}` : (level === 1 ? `${index}. ${name}` : name);
                
                item.innerHTML = `
                    <span>${this.escapeHtml(displayText)}</span>
                    <div class="item-controls">
                        <button class="edit-button" data-action="edit">Edit</button>
                        ${level < 5 ? `<button class="${buttonAction.replace('add-', 'add-')}-button" data-action="${buttonAction}">${buttonText}</button>` : ''}
                        <button class="close-button">
                            <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                `;
                
                // Add event listeners
                const closeButton = item.querySelector('.close-button');
                closeButton.addEventListener('click', () => {
                    item.remove();
                    this.renumberSegments();
                });

                // Add drag event listeners
                item.addEventListener('dragstart', this.handleDragStart.bind(this));
                item.addEventListener('dragend', this.handleDragEnd.bind(this));

                // Add edit functionality
                const editButton = item.querySelector('[data-action="edit"]');
                if (editButton) {
                    editButton.addEventListener('click', () => {
                        this.editSegment(item);
                    });
                }

                // Add level-specific button listeners (only up to level 4)
                if (level < 5) {
                    const levelButton = item.querySelector(`[data-action="${buttonAction}"]`);
                    if (levelButton) {
                        this.addLevelButtonListener(item, levelButton, level, buttonAction);
                    }
                }
                
                return item;
            }

            createSubsegmentSection(parentName, level) {
                const section = document.createElement('div');
                let sectionClass, dropzoneClass, droppedClass, dropzoneText;
                
                switch(level) {
                    case 1:
                        sectionClass = 'subsegment-section';
                        dropzoneClass = 'subsegment-dropzone';
                        droppedClass = 'dropped-subsegments';
                        dropzoneText = 'Drag and drop sub-segments here';
                        break;
                    case 2:
                        sectionClass = 'subsubsegment-section';
                        dropzoneClass = 'subsubsegment-dropzone';
                        droppedClass = 'dropped-subsubsegments';
                        dropzoneText = 'Drag and drop sub-sub-segments here';
                        break;
                    case 3:
                        sectionClass = 'subsubsubsegment-section';
                        dropzoneClass = 'subsubsubsegment-dropzone';
                        droppedClass = 'dropped-subsubsubsegments';
                        dropzoneText = 'Drag and drop sub-sub-sub-segments here';
                        break;
                    case 4:
                        sectionClass = 'subsubsubsubsegment-section';
                        dropzoneClass = 'subsubsubsubsegment-dropzone';
                        droppedClass = 'dropped-subsubsubsubsegments';
                        dropzoneText = 'Drag and drop sub-sub-sub-sub-segments here';
                        break;
                    default:
                        sectionClass = 'subsegment-section';
                        dropzoneClass = 'subsegment-dropzone';
                        droppedClass = 'dropped-subsegments';
                        dropzoneText = 'Drag and drop sub-segments here';
                }
                
                section.classList.add(sectionClass);
                section.dataset.parentSegment = parentName;
                
                section.innerHTML = `
                    <div class="${dropzoneClass}">
                        <p class="dropzone-text">${dropzoneText}</p>
                    </div>
                    <div class="${droppedClass}"></div>
                `;
                
                return section;
            }

            toggleSegmentsViewer() {
                const viewer = document.querySelector('.segments-viewer');
                const toggle = document.querySelector('.view-segments-toggle');
                
                this.segmentsViewerVisible = !this.segmentsViewerVisible;
                
                if (this.segmentsViewerVisible) {
                    viewer.classList.add('active');
                    toggle.classList.add('active');
                    this.updateSegmentsViewer();
                } else {
                    viewer.classList.remove('active');
                    toggle.classList.remove('active');
                }
            }

            updateSegmentsViewer() {
                const segmentsList = document.querySelector('.segments-list');
                segmentsList.innerHTML = '';
                
                const segments = this.collectAllSegmentsForViewer();
                
                if (segments.length === 0) {
                    segmentsList.innerHTML = '<div class="segment-item">No segments added yet</div>';
                    return;
                }
                
                segments.forEach(segment => {
                    const segmentItem = document.createElement('div');
                    segmentItem.classList.add('segment-item');
                    
                    const level = this.getSegmentLevel(segment);
                    if (level === 2) segmentItem.classList.add('subsegment');
                    if (level === 3) segmentItem.classList.add('subsubsegment');
                    if (level === 4) segmentItem.classList.add('subsubsubsegment');
                    if (level === 5) segmentItem.classList.add('subsubsubsubsegment');
                    
                    segmentItem.textContent = segment;
                    segmentsList.appendChild(segmentItem);
                });
            }

            getSegmentLevel(segmentText) {
                const dotCount = (segmentText.match(/\./g) || []).length;
                return dotCount + 1;
            }

            collectAllSegmentsForViewer() {
                const segments = [];
                const segmentItems = document.querySelectorAll('.dropped-item.segment');

                segmentItems.forEach(segment => {
                    const segmentText = segment.querySelector('span').textContent;
                    segments.push(segmentText);

                    const parentSegment = segmentText.replace(/^\d+\.\s*/, '');
                    const subSegmentSection = document.querySelector(`.subsegment-section[data-parent-segment="${parentSegment}"]`);

                    if (subSegmentSection) {
                        const subSegmentItems = subSegmentSection.querySelectorAll('.dropped-item.subsegment');
                        subSegmentItems.forEach(subSegment => {
                            const subSegmentText = subSegment.querySelector('span').textContent;
                            segments.push(subSegmentText);

                            const parentSubSegment = subSegmentText.replace(/^\d+\.\d+\.\s*/, '');
                            const subSubSegmentSection = subSegmentSection.querySelector(`.subsubsegment-section[data-parent-sub-segment="${parentSubSegment}"]`);

                            if (subSubSegmentSection) {
                                const subSubSegmentItems = subSubSegmentSection.querySelectorAll('.dropped-item.subsubsegment');
                                subSubSegmentItems.forEach(subSubSegment => {
                                    const subSubSegmentText = subSubSegment.querySelector('span').textContent;
                                    segments.push(subSubSegmentText);

                                    const parentSubSubSegment = subSubSegmentText.replace(/^\d+\.\d+\.\d+\.\s*/, '');
                                    const subSubSubSegmentSection = subSubSegmentSection.querySelector(`.subsubsubsegment-section[data-parent-sub-sub-segment="${parentSubSubSegment}"]`);

                                    if (subSubSubSegmentSection) {
                                        const subSubSubSegmentItems = subSubSubSegmentSection.querySelectorAll('.dropped-item.subsubsubsegment');
                                        subSubSubSegmentItems.forEach(subSubSubSegment => {
                                            const subSubSubSegmentText = subSubSubSegment.querySelector('span').textContent;
                                            segments.push(subSubSubSegmentText);

                                            const parentSubSubSubSegment = subSubSubSegmentText.replace(/^\d+\.\d+\.\d+\.\d+\.\s*/, '');
                                            const subSubSubSubSegmentSection = subSubSubSegmentSection.querySelector(`.subsubsubsubsegment-section[data-parent-sub-sub-sub-segment="${parentSubSubSubSegment}"]`);

                                            if (subSubSubSubSegmentSection) {
                                                const subSubSubSubSegmentItems = subSubSubSubSegmentSection.querySelectorAll('.dropped-item.subsubsubsubsegment');
                                                subSubSubSubSegmentItems.forEach(subSubSubSubSegment => {
                                                    const subSubSubSubSegmentText = subSubSubSubSegment.querySelector('span').textContent;
                                                    segments.push(subSubSubSubSegmentText);
                                                });
                                            }
                                        });
                                    }
                                });
                            }
                        });
                    }
                });

                return segments;
            }

            switchTab(tab) {
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.toggle('tab-active', button.dataset.tab === tab);
                });
                this.currentTab = tab;
                this.redrawResults();
            }

            createResultBox(index, data = null) {
                const box = document.createElement('div');
                box.className = 'result-box';
                box.dataset.index = index;
                const hasData = data && data.url;
                const displayIndex = hasData ? this.escapeHtml(data.title || `Result ${index}`) : `Result ${index}`;
                const url = hasData ? this.escapeHtml(data.url) : '';
                const urlLink = hasData ? `<a href="${url}" target="_blank" rel="noopener noreferrer">Link</a>` : 'No data yet';
                
                box.innerHTML = `
                    <div class="result-header">
                        <div class="result-title-section">
                            <svg class="globe-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M8.00065 14.6666C11.6825 14.6666 14.6673 11.6818 14.6673 7.99992C14.6673 4.31802 11.6825 1.33325 8.00065 1.33325C4.31875 1.33325 1.33398 4.31802 1.33398 7.99992C1.33398 11.6818 4.31875 14.6666 8.00065 14.6666Z" stroke="#6014FA" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M8.00065 1.33325C6.28881 3.13069 5.33398 5.51775 5.33398 7.99992C5.33398 10.4821 6.28881 12.8691 8.00065 14.6666C9.71249 12.8691 10.6673 10.4821 10.6673 7.99992C10.6673 5.51775 9.71249 3.13069 8.00065 1.33325Z" stroke="#6014FA" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M1.33398 8H14.6673" stroke="#6014FA" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <h3 class="result-title">${displayIndex}</h3>
                        </div>
                        <button class="close-button" data-action="close">
                            <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                    <div class="divider"></div>
                    <div class="result-url">${urlLink}</div>
                    <div class="divider"></div>
                    <div class="result-content">
                        ${this.generateFileTree(hasData ? data : null)}
                    </div>
                `;

                box.querySelector('[data-action="close"]').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.clearResultBox(index);
                });

                if (hasData) {
                    box.querySelectorAll('.tree-item.file').forEach(item => {
                        item.draggable = true;
                        item.addEventListener('dragstart', this.handleDragStart.bind(this));
                        item.addEventListener('dragend', this.handleDragEnd.bind(this));
                    });
                }

                return box;
            }

            generateFileTree(data = null) {
                if (!data) return this.getDefaultFileTree();
                return this.currentTab === 'segments' ? this.buildSegmentsTree(data) : this.buildCompanyTree(data);
            }

            getDefaultFileTree() {
                return `
                    <div class="file-tree">
                        <div class="tree-item folder">
                            <svg class="chevron-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
                                <path d="M3 4.5L6 7.5L9 4.5" stroke="#2C2C2C" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <svg class="folder-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
                                <path d="M10 10C10.2652 10 10.5196 9.89464 10.7071 9.70711C10.8946 9.51957 11 9.26522 11 9V4C11 3.73478 10.8946 3.48043 10.7071 3.29289C10.5196 3.10536 10.2652 3 10 3H6.05C5.88276 3.00164 5.71777 2.96131 5.57015 2.88269C5.42253 2.80407 5.29698 2.68969 5.205 2.55L4.8 1.95C4.70895 1.81173 4.58499 1.69824 4.43925 1.6197C4.29351 1.54116 4.13055 1.50003 3.965 1.5H2C1.73478 1.5 1.48043 1.60536 1.29289 1.79289C1.10536 1.98043 1 2.23478 1 2.5V9C1 9.26522 1.10536 9.51957 1.29289 9.70711C1.48043 9.89464 1.73478 10 2 10H10Z" stroke="#6014FA" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Waiting for data...</span>
                        </div>
                    </div>
                `;
            }

            buildSegmentsTree(data) {
                let html = '<div class="file-tree">';
                if (data.table_of_contents?.length > 0) {
                    html += `
                        <div class="tree-item folder">
                            <svg class="chevron-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
                                <path d="M3 4.5L6 7.5L9 4.5" stroke="#2C2C2C" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <svg class="folder-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
                                <path d="M10 10C10.2652 10 10.5196 9.89464 10.7071 9.70711C10.8946 9.51957 11 9.26522 11 9V4C11 3.73478 10.8946 3.48043 10.7071 3.29289C10.5196 3.10536 10.2652 3 10 3H6.05C5.88276 3.00164 5.71777 2.96131 5.57015 2.88269C5.42253 2.80407 5.29698 2.68969 5.205 2.55L4.8 1.95C4.70895 1.81173 4.58499 1.69824 4.43925 1.6197C4.29351 1.54116 4.13055 1.50003 3.965 1.5H2C1.73478 1.5 1.48043 1.60536 1.29289 1.79289C1.10536 1.98043 1 2.23478 1 2.5V9C1 9.26522 1.10536 9.51957 1.29289 9.70711C1.48043 9.89464 1.73478 10 2 10H10Z" stroke="#6014FA" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Table of Contents</span>
                        </div>
                    `;
                    data.table_of_contents.forEach((item, idx) => {
                        const indent = item.match(/^\d+\.\d+\.\d+\.\d+\.\d+\.\s/) ? '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' : 
                                     item.match(/^\d+\.\d+\.\d+\.\d+\.\s/) ? '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' : 
                                     item.match(/^\d+\.\d+\.\d+\.\s/) ? '&nbsp;&nbsp;&nbsp;&nbsp;' : 
                                     item.match(/^\d+\.\d+\.\s/) ? '&nbsp;&nbsp;' : '';
                        html += `
                            <div class="tree-item file" data-item-index="${idx}" data-type="segment">
                                <svg class="file-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
                                    <path d="M7.5 1H3C2.73478 1 2.48043 1.29289 2.29289 1.29289C2.10536 1.48043 2 1.73478 2 2V10C2 10.2652 2.10536 10.5196 2.29289 10.7071C2.48043 10.8946 2.73478 11 3 11H9C9.26522 11 9.51957 10.8946 9.70711 10.7071C9.89464 10.5196 10 10.2652 10 10V3.5L7.5 1Z" stroke="#6B7280" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M7 1V3C7 3.26522 7.10536 3.51957 7.29289 3.70711C7.48043 3.89464 7.73478 4 8 4H10" stroke="#6B7280" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>${indent}${this.escapeHtml(item)}</span>
                            </div>
                        `;
                    });
                } else {
                    html += `
                        <div class="tree-item file">
                            <span>${data.table_of_contents?.length === 0 ? 'No table of contents found' : 'No data available'}</span>
                        </div>
                    `;
                }
                html += '</div>';
                return html;
            }

            buildCompanyTree(data) {
                let html = '<div class="file-tree">';
                if (data.company_profiles?.length > 0) {
                    html += `
                        <div class="tree-item folder">
                            <svg class="chevron-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
                                <path d="M3 4.5L6 7.5L9 4.5" stroke="#2C2C2C" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <svg class="folder-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
                                <path d="M10 10C10.2652 10 10.5196 9.89464 10.7071 9.70711C10.8946 9.51957 11 9.26522 11 9V4C11 3.73478 10.8946 3.48043 10.7071 3.29289C10.5196 3.10536 10.2652 3 10 3H6.05C5.88276 3.00164 5.71777 2.96131 5.57015 2.88269C5.42253 2.80407 5.29698 2.68969 5.205 2.55L4.8 1.95C4.70895 1.81173 4.58499 1.69824 4.43925 1.6197C4.29351 1.54116 4.13055 1.50003 3.965 1.5H2C1.73478 1.5 1.48043 1.60536 1.29289 1.79289C1.10536 1.98043 1 2.23478 1 2.5V9C1 9.26522 1.10536 9.51957 1.29289 9.70711C1.48043 9.89464 1.73478 10 2 10H10Z" stroke="#6014FA" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Company Profiles</span>
                        </div>
                    `;
                    data.company_profiles.forEach((company, idx) => {
                        html += `
                            <div class="tree-item file" data-item-index="${idx}" data-type="company">
                                <svg class="file-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
                                    <path d="M7.5 1H3C2.73478 1 2.48043 1.29289 2.29289 1.29289C2.10536 1.48043 2 1.73478 2 2V10C2 10.2652 2.10536 10.5196 2.29289 10.7071C2.48043 10.8946 2.73478 11 3 11H9C9.26522 11 9.51957 10.8946 9.70711 10.7071C9.89464 10.5196 10 10.2652 10 10V3.5L7.5 1Z" stroke="#6B7280" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M7 1V3C7 3.26522 7.10536 3.51957 7.29289 3.70711C7.48043 3.89464 7.73478 4 8 4H10" stroke="#6B7280" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>${this.escapeHtml(company)}</span>
                            </div>
                        `;
                    });
                } else {
                    html += `
                        <div class="tree-item file">
                            <span>${data.company_profiles?.length === 0 ? 'No company profiles found' : 'No data available'}</span>
                        </div>
                    `;
                }
                html += '</div>';
                return html;
            }

            escapeHtml(text) {
                return text ? String(text).replace(/[&<>"']/g, match => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                })[match]) : '';
            }

            async processLinks() {
                const linksInput = document.querySelector('.links-input');
                const processButton = document.querySelector('.process-button');
                const links = linksInput.value.trim().split('\n').map(link => link.trim()).filter(Boolean);

                if (!links.length) {
                    this.showNotification('Please enter at least one valid URL.', 'error');
                    return;
                }

                if (links.length > 6) {
                    this.showNotification('Maximum 6 links allowed. Processing first 6.', 'warning');
                    links.splice(6);
                }

                this.showLoading(true);
                processButton.disabled = true;
                processButton.textContent = 'Processing...';

                try {
                    const response = await fetch('/api/scrape', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ urls: links })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.error) {
                        this.showNotification(`Error: ${data.error}`, 'error');
                        return;
                    }

                    this.results = data;
                    this.redrawResults();
                    this.showNotification(`Successfully processed ${data.length} report${data.length > 1 ? 's' : ''}.`, 'success');
                } catch (error) {
                    console.error('Error processing links:', error);
                    this.showNotification('Failed to process links. Please check your connection and try again.', 'error');
                } finally {
                    this.showLoading(false);
                    processButton.disabled = false;
                    processButton.textContent = 'Process Links';
                }
            }

            adjustGrid(count) {
                const grid = document.querySelector('.results-grid');
                const classes = Array.from(grid.classList).filter(c => c.startsWith('count-'));
                classes.forEach(c => grid.classList.remove(c));
                grid.classList.add(`count-${count}`);
            }

            redrawResults() {
                const resultsGrid = document.querySelector('.results-grid');
                resultsGrid.innerHTML = '';
                if (this.results.length === 0) {
                    resultsGrid.innerHTML = `
                        <div class="guide">
                            <h2>How to Use Market Research Automation</h2>
                            <ol>
                                <li>Paste up to 6 market research report URLs in the left sidebar textarea, one per line.</li>
                                <li>Click "Process Links" to scrape the Table of Contents (TOC) and company profiles from the reports.</li>
                                <li>Once processed, results will appear here. Use the tabs "Segments" and "Company" to switch between TOC and company profiles views.</li>
                                <li>Drag and drop items from the results (segments or companies) into the right sidebar's "Segments" or "Companies" drop zones.</li>
                                <li>In the right sidebar, enter a title for your report, and ensure you have added segments and companies as needed.</li>
                                <li>Click "Generate Report" to create a combined DOCX file based on the selected items.</li>
                                <li>Once generated, click "Download Report" to save the DOCX file to your device.</li>
                            </ol>
                        </div>
                    `;
                } else {
                    this.results.forEach((result, index) => {
                        if (result) {
                            resultsGrid.appendChild(this.createResultBox(index + 1, result));
                        }
                    });
                }
                this.adjustGrid(this.results.length);
            }

            clearResultBox(index) {
                this.results.splice(index - 1, 1);
                this.redrawResults();
            }

            handleDragStart(e) {
                this.draggedElement = e.target;
                e.target.classList.add('dragging');
                const rawType = e.target.dataset.type;
                const type = rawType === 'company' ? 'company' : 'segment';
                const value = e.target.querySelector('span').textContent.trim().replace(/^\d+\.\d+\.\d+\.\d+\.\d+\.\s|^\d+\.\d+\.\d+\.\d+\.\s|^\d+\.\d+\.\d+\.\s|^\d+\.\d+\.\s|^\d+\.\s/, '');
                e.dataTransfer.setData('text/plain', JSON.stringify({ type, value }));
            }

            handleDragEnd(e) {
                if (this.draggedElement) {
                    this.draggedElement.classList.remove('dragging');
                    this.draggedElement = null;
                }
            }

            handleDragOver(e) {
                e.preventDefault();
                e.currentTarget.classList.add('drag-over');
            }

            handleDragLeave(e) {
                e.currentTarget.classList.remove('drag-over');
            }

            checkDuplicate(section, value, parentSegment = null, parentSubSegment = null, parentSubSubSegment = null, parentSubSubSubSegment = null) {
                let items;
                if (section === 'companies') {
                    items = Array.from(document.querySelectorAll('.dropped-companies .dropped-item span'))
                        .map(span => span.textContent.trim());
                } else if (section === 'segments') {
                    items = Array.from(document.querySelectorAll('.dropped-segments .dropped-item.segment span'))
                        .map(span => span.textContent.trim().replace(/^\d+\.\s*/, ''));
                } else if (section === 'subsegment') {
                    const subSegmentSection = document.querySelector(`.subsegment-section[data-parent-segment="${parentSegment}"]`);
                    if (!subSegmentSection) return false;
                    items = Array.from(subSegmentSection.querySelectorAll('.dropped-item.subsegment span'))
                        .map(span => span.textContent.trim().replace(/^\d+\.\d+\.\s*/, ''));
                } else if (section === 'subsubsegment') {
                    const subSubSegmentSection = document.querySelector(`.subsubsegment-section[data-parent-segment="${parentSegment}"][data-parent-sub-segment="${parentSubSegment}"]`);
                    if (!subSubSegmentSection) return false;
                    items = Array.from(subSubSegmentSection.querySelectorAll('.dropped-item.subsubsegment span'))
                        .map(span => span.textContent.trim().replace(/^\d+\.\d+\.\d+\.\s*/, ''));
                } else if (section === 'subsubsubsegment') {
                    const subSubSubSegmentSection = document.querySelector(`.subsubsubsegment-section[data-parent-segment="${parentSegment}"][data-parent-sub-segment="${parentSubSegment}"][data-parent-sub-sub-segment="${parentSubSubSegment}"]`);
                    if (!subSubSubSegmentSection) return false;
                    items = Array.from(subSubSubSegmentSection.querySelectorAll('.dropped-item.subsubsubsegment span'))
                        .map(span => span.textContent.trim().replace(/^\d+\.\d+\.\d+\.\d+\.\s*/, ''));
                } else if (section === 'subsubsubsubsegment') {
                    const subSubSubSubSegmentSection = document.querySelector(`.subsubsubsubsegment-section[data-parent-segment="${parentSegment}"][data-parent-sub-segment="${parentSubSegment}"][data-parent-sub-sub-segment="${parentSubSubSegment}"][data-parent-sub-sub-sub-segment="${parentSubSubSubSegment}"]`);
                    if (!subSubSubSubSegmentSection) return false;
                    items = Array.from(subSubSubSubSegmentSection.querySelectorAll('.dropped-item.subsubsubsubsegment span'))
                        .map(span => span.textContent.trim().replace(/^\d+\.\d+\.\d+\.\d+\.\d+\.\s*/, ''));
                }
                return items.includes(value);
            }

            handleDrop(section, e) {
                e.preventDefault();
                const dropzone = e.currentTarget;
                dropzone.classList.remove('drag-over');
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));

                if ((section === 'segments' && data.type !== 'segment') || (section === 'companies' && data.type !== 'company')) {
                    this.showNotification('Invalid drop type for this section.', 'error');
                    return;
                }

                if (this.checkDuplicate(section, data.value)) {
                    this.showNotification('This item already exists in the section.', 'error');
                    return;
                }

                const droppedItems = document.querySelector(`.dropped-${section}`);
                const item = document.createElement('div');
                item.classList.add('dropped-item', section === 'segments' ? 'segment' : 'company');
                // Ensure drag payload type is consistent: 'segment' for segments, 'company' for companies
                item.dataset.type = section === 'segments' ? 'segment' : 'company';

                if (section === 'segments') {
                    const segmentCount = Array.from(droppedItems.children).filter(child => child.dataset.type === 'segment').length + 1;
                    const displayText = `${segmentCount}. ${data.value}`;
                    item.innerHTML = `
                        <span>${this.escapeHtml(displayText)}</span>
                        <div class="item-controls">
                            <button class="edit-button" data-action="edit">Edit</button>
                            <button class="add-subsegment-button" data-action="add-subsegment">+ lvl-2</button>
                            <button class="close-button">
                                <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                    <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                    <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                                </svg>
                            </svg>
                        </button>
                    </div>
                `;

                const subSegmentSection = document.createElement('div');
                subSegmentSection.classList.add('subsegment-section');
                subSegmentSection.dataset.parentSegment = data.value;
                subSegmentSection.innerHTML = `
                    <div class="subsegment-dropzone">
                        <p class="dropzone-text">Drag and drop sub-segments here</p>
                    </div>
                    <div class="dropped-subsegments"></div>
                `;

                droppedItems.appendChild(item);
                droppedItems.appendChild(subSegmentSection);

                const subSegmentDropzone = subSegmentSection.querySelector('.subsegment-dropzone');
                subSegmentDropzone.addEventListener('dragover', this.handleDragOver.bind(this));
                subSegmentDropzone.addEventListener('drop', this.handleSubSegmentDrop.bind(this, subSegmentSection));
                subSegmentDropzone.addEventListener('dragleave', this.handleDragLeave.bind(this));

                item.querySelector('[data-action="add-subsegment"]').addEventListener('click', () => {
                    const isActive = subSegmentSection.classList.contains('active');
                    // Only deactivate other sections at the same level, not all sections
                    document.querySelectorAll('.subsegment-section').forEach(section => {
                        if (section !== subSegmentSection) {
                            section.classList.remove('active');
                        }
                    });
                    if (!isActive) {
                        subSegmentSection.classList.add('active');
                        this.activeSubSegmentDropzone = subSegmentSection;
                    }
                    this.renumberSegments();
                });

                // Add edit functionality
                item.querySelector('[data-action="edit"]').addEventListener('click', () => {
                    this.editSegment(item);
                });
                } else {
                    item.innerHTML = `
                        <span>${this.escapeHtml(data.value)}</span>
                        <button class="close-button">
                            <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                            </svg>
                        </button>
                    `;
                    droppedItems.appendChild(item);
                }

                item.querySelector('.close-button').addEventListener('click', () => {
                    if (section === 'segments') {
                        const parentSegment = item.querySelector('span').textContent.replace(/^\d+\.\s*/, '');
                        const subSegmentSection = droppedItems.querySelector(`.subsegment-section[data-parent-segment="${parentSegment}"]`);
                        subSegmentSection?.remove();
                    }
                    item.remove();
                    if (section === 'segments') this.renumberSegments();
                });

                if (section === 'segments') this.renumberSegments();
                
                // Update segments viewer if visible
                if (this.segmentsViewerVisible) {
                    this.updateSegmentsViewer();
                }
            }

            editSegment(segmentElement) {
                const span = segmentElement.querySelector('span');
                const currentText = span.textContent;
                const numberMatch = currentText.match(/^(\d+(?:\.\d+)*)\.\s*/);
                const numberPart = numberMatch ? numberMatch[1] + '. ' : '';
                const textPart = currentText.replace(/^(\d+(?:\.\d+)*)\.\s*/, '');
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = textPart;
                input.className = 'edit-input';
                
                span.style.display = 'none';
                segmentElement.querySelector('.item-controls').style.display = 'none';
                segmentElement.insertBefore(input, segmentElement.firstChild);
                
                input.focus();
                
                const saveEdit = () => {
                    const newText = input.value.trim();
                    if (newText && newText !== textPart) {
                        span.textContent = numberPart + newText;
                        // Log change
                        this.segmentChangeLog.push({ type: 'edit', from: currentText, to: numberPart + newText, at: new Date().toISOString() });
                        
                        // Update the data attributes if this is a parent segment
                        if (segmentElement.classList.contains('segment')) {
                            const oldParentSegment = textPart;
                            const newParentSegment = newText;
                            const subSegmentSection = document.querySelector(`.subsegment-section[data-parent-segment="${oldParentSegment}"]`);
                            if (subSegmentSection) {
                                subSegmentSection.dataset.parentSegment = newParentSegment;
                            }
                        } else if (segmentElement.classList.contains('subsegment')) {
                            const oldParentSubSegment = textPart;
                            const newParentSubSegment = newText;
                            const subSubSegmentSection = document.querySelector(`.subsubsegment-section[data-parent-sub-segment="${oldParentSubSegment}"]`);
                            if (subSubSegmentSection) {
                                subSubSegmentSection.dataset.parentSubSegment = newParentSubSegment;
                            }
                        } else if (segmentElement.classList.contains('subsubsegment')) {
                            const oldParentSubSubSegment = textPart;
                            const newParentSubSubSegment = newText;
                            const subSubSubSegmentSection = document.querySelector(`.subsubsubsegment-section[data-parent-sub-sub-segment="${oldParentSubSubSegment}"]`);
                            if (subSubSubSegmentSection) {
                                subSubSubSegmentSection.dataset.parentSubSubSegment = newParentSubSubSegment;
                            }
                        } else if (segmentElement.classList.contains('subsubsubsegment')) {
                            const oldParentSubSubSubSegment = textPart;
                            const newParentSubSubSubSegment = newText;
                            const subSubSubSubSegmentSection = document.querySelector(`.subsubsubsubsegment-section[data-parent-sub-sub-sub-segment="${oldParentSubSubSubSegment}"]`);
                            if (subSubSubSubSegmentSection) {
                                subSubSubSubSegmentSection.dataset.parentSubSubSubSegment = newParentSubSubSubSegment;
                            }
                        }
                    }
                    
                    input.remove();
                    span.style.display = '';
                    segmentElement.querySelector('.item-controls').style.display = 'flex';
                    
                    // Update segments viewer if visible
                    if (this.segmentsViewerVisible) {
                        this.updateSegmentsViewer();
                    }
                };
                
                input.addEventListener('blur', saveEdit);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        saveEdit();
                    } else if (e.key === 'Escape') {
                        input.remove();
                        span.style.display = '';
                        segmentElement.querySelector('.item-controls').style.display = 'flex';
                    }
                });
            }

            handleSubSegmentDrop(subSegmentSection, e) {
                e.preventDefault();
                const dropzone = e.currentTarget;
                dropzone.classList.remove('drag-over');
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));

                if (data.type !== 'segment') {
                    this.showNotification('Only segments can be dropped as sub-segments.', 'error');
                    return;
                }

                const parentSegment = subSegmentSection.dataset.parentSegment;
                if (this.checkDuplicate('subsegment', data.value, parentSegment)) {
                    this.showNotification('This sub-segment already exists.', 'error');
                    return;
                }

                const droppedItems = subSegmentSection.querySelector('.dropped-subsegments');
                const parentSegmentItem = Array.from(document.querySelector('.dropped-segments').children)
                    .find(item => item.classList.contains('segment') && 
                                  item.querySelector('span').textContent.replace(/^\d+\.\s*/, '') === parentSegment);

                if (!parentSegmentItem) return;

                const segmentIndex = parseInt(parentSegmentItem.querySelector('span').textContent.match(/^\d+/)[0]);
                const subSegmentCount = Array.from(droppedItems.children)
                    .filter(child => child.classList.contains('dropped-item') && child.dataset.type === 'subsegment')
                    .length + 1;
                const subSegmentItem = document.createElement('div');
                subSegmentItem.classList.add('dropped-item', 'subsegment');
                subSegmentItem.dataset.type = 'subsegment';
                subSegmentItem.dataset.parentSegment = parentSegment;
                const displayText = `${segmentIndex}.${subSegmentCount}. ${data.value}`;

                subSegmentItem.innerHTML = `
                    <span>${this.escapeHtml(displayText)}</span>
                    <div class="item-controls">
                        <button class="edit-button" data-action="edit">Edit</button>
                        <button class="add-subsubsegment-button" data-action="add-subsubsegment">+ lvl-3</button>
                        <button class="close-button">
                            <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                `;

                const subSubSegmentSection = document.createElement('div');
                subSubSegmentSection.classList.add('subsubsegment-section');
                subSubSegmentSection.dataset.parentSubSegment = data.value;
                subSubSegmentSection.dataset.parentSegment = parentSegment;
                subSubSegmentSection.innerHTML = `
                    <div class="subsubsegment-dropzone">
                        <p class="dropzone-text">Drag and drop sub-sub-segments here</p>
                    </div>
                    <div class="dropped-subsubsegments"></div>
                `;

                droppedItems.appendChild(subSegmentItem);
                droppedItems.appendChild(subSubSegmentSection);

                const subSubSegmentDropzone = subSubSegmentSection.querySelector('.subsubsegment-dropzone');
                subSubSegmentDropzone.addEventListener('dragover', this.handleDragOver.bind(this));
                subSubSegmentDropzone.addEventListener('drop', this.handleSubSubSegmentDrop.bind(this, subSubSegmentSection));
                subSubSegmentDropzone.addEventListener('dragleave', this.handleDragLeave.bind(this));

                subSegmentItem.querySelector('[data-action="add-subsubsegment"]').addEventListener('click', () => {
                    const isActive = subSubSegmentSection.classList.contains('active');
                    // Only deactivate other sections at the same level, not all sections
                    document.querySelectorAll('.subsubsegment-section').forEach(section => {
                        if (section !== subSubSegmentSection) {
                            section.classList.remove('active');
                        }
                    });
                    if (!isActive) {
                        subSubSegmentSection.classList.add('active');
                        this.activeSubSubSegmentDropzone = subSubSegmentSection;
                    }
                    this.renumberSegments();
                });

                // Add edit functionality
                subSegmentItem.querySelector('[data-action="edit"]').addEventListener('click', () => {
                    this.editSegment(subSegmentItem);
                });

                subSegmentItem.querySelector('.close-button').addEventListener('click', () => {
                    subSegmentItem.remove();
                    subSubSegmentSection.remove();
                    this.renumberSegments();
                });

                this.renumberSegments();
                
                // Update segments viewer if visible
                if (this.segmentsViewerVisible) {
                    this.updateSegmentsViewer();
                }
            }

            handleSubSubSegmentDrop(subSubSegmentSection, e) {
                e.preventDefault();
                const dropzone = e.currentTarget;
                dropzone.classList.remove('drag-over');
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));

                if (data.type !== 'segment') {
                    this.showNotification('Only segments can be dropped as sub-sub-segments.', 'error');
                    return;
                }

                const parentSubSegment = subSubSegmentSection.dataset.parentSubSegment;
                const parentSegment = subSubSegmentSection.dataset.parentSegment;

                if (this.checkDuplicate('subsubsegment', data.value, parentSegment, parentSubSegment)) {
                    this.showNotification('This sub-sub-segment already exists.', 'error');
                    return;
                }

                const droppedItems = subSubSegmentSection.querySelector('.dropped-subsubsegments');
                const parentSegmentItem = Array.from(document.querySelector('.dropped-segments').children)
                    .find(item => item.classList.contains('segment') && 
                                  item.querySelector('span').textContent.replace(/^\d+\.\s*/, '') === parentSegment);
                if (!parentSegmentItem) return;

                const segmentIndex = parseInt(parentSegmentItem.querySelector('span').textContent.match(/^\d+/)[0]);
                const parentSubSegmentItem = Array.from(document.querySelectorAll('.dropped-item.subsegment'))
                    .find(item => item.querySelector('span').textContent.includes(`${segmentIndex}.`) && 
                                  item.querySelector('span').textContent.includes(parentSubSegment));
                if (!parentSubSegmentItem) return;

                const subSegmentMatch = parentSubSegmentItem.querySelector('span').textContent.match(new RegExp(`${segmentIndex}\\.(\\d+)`));
                if (!subSegmentMatch) return;

                const subSegmentIndex = parseInt(subSegmentMatch[1]);
                const subSubSegmentCount = Array.from(droppedItems.children)
                    .filter(child => child.classList.contains('dropped-item') && child.dataset.type === 'subsubsegment')
                    .length + 1;
                const subSubSegmentItem = document.createElement('div');
                subSubSegmentItem.classList.add('dropped-item', 'subsubsegment');
                subSubSegmentItem.dataset.type = 'subsubsegment';
                subSubSegmentItem.dataset.parentSubSegment = parentSubSegment;
                subSubSegmentItem.dataset.parentSegment = parentSegment;
                const displayText = `${segmentIndex}.${subSegmentIndex}.${subSubSegmentCount}. ${data.value}`;

                subSubSegmentItem.innerHTML = `
                    <span>${this.escapeHtml(displayText)}</span>
                    <div class="item-controls">
                        <button class="edit-button" data-action="edit">Edit</button>
                        <button class="add-subsubsubsegment-button" data-action="add-subsubsubsegment">+ lvl-4</button>
                        <button class="close-button">
                            <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                `;

                const subSubSubSegmentSection = document.createElement('div');
                subSubSubSegmentSection.classList.add('subsubsubsegment-section');
                subSubSubSegmentSection.dataset.parentSubSubSegment = data.value;
                subSubSubSegmentSection.dataset.parentSubSegment = parentSubSegment;
                subSubSubSegmentSection.dataset.parentSegment = parentSegment;
                subSubSubSegmentSection.innerHTML = `
                    <div class="subsubsubsegment-dropzone">
                        <p class="dropzone-text">Drag and drop sub-sub-sub-segments here</p>
                    </div>
                    <div class="dropped-subsubsubsegments"></div>
                `;

                droppedItems.appendChild(subSubSegmentItem);
                droppedItems.appendChild(subSubSubSegmentSection);

                const subSubSubSegmentDropzone = subSubSubSegmentSection.querySelector('.subsubsubsegment-dropzone');
                subSubSubSegmentDropzone.addEventListener('dragover', this.handleDragOver.bind(this));
                subSubSubSegmentDropzone.addEventListener('drop', this.handleSubSubSubSegmentDrop.bind(this, subSubSubSegmentSection));
                subSubSubSegmentDropzone.addEventListener('dragleave', this.handleDragLeave.bind(this));

                subSubSegmentItem.querySelector('[data-action="add-subsubsubsegment"]').addEventListener('click', () => {
                    const isActive = subSubSubSegmentSection.classList.contains('active');
                    // Only deactivate other sections at the same level, not all sections
                    document.querySelectorAll('.subsubsubsegment-section').forEach(section => {
                        if (section !== subSubSubSegmentSection) {
                            section.classList.remove('active');
                        }
                    });
                    if (!isActive) {
                        subSubSubSegmentSection.classList.add('active');
                        this.activeSubSubSubSegmentDropzone = subSubSubSegmentSection;
                    }
                    this.renumberSegments();
                });

                // Add edit functionality
                subSubSegmentItem.querySelector('[data-action="edit"]').addEventListener('click', () => {
                    this.editSegment(subSubSegmentItem);
                });

                subSubSegmentItem.querySelector('.close-button').addEventListener('click', () => {
                    subSubSegmentItem.remove();
                    subSubSubSegmentSection.remove();
                    this.renumberSegments();
                });

                this.renumberSegments();
                
                // Update segments viewer if visible
                if (this.segmentsViewerVisible) {
                    this.updateSegmentsViewer();
                }
            }

            handleSubSubSubSegmentDrop(subSubSubSegmentSection, e) {
                e.preventDefault();
                const dropzone = e.currentTarget;
                dropzone.classList.remove('drag-over');
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));

                if (data.type !== 'segment') {
                    this.showNotification('Only segments can be dropped as sub-sub-sub-segments.', 'error');
                    return;
                }

                const parentSubSubSegment = subSubSubSegmentSection.dataset.parentSubSubSegment;
                const parentSubSegment = subSubSubSegmentSection.dataset.parentSubSegment;
                const parentSegment = subSubSubSegmentSection.dataset.parentSegment;

                if (this.checkDuplicate('subsubsubsegment', data.value, parentSegment, parentSubSegment, parentSubSubSegment)) {
                    this.showNotification('This sub-sub-sub-segment already exists.', 'error');
                    return;
                }

                const droppedItems = subSubSubSegmentSection.querySelector('.dropped-subsubsubsegments');
                const parentSegmentItem = Array.from(document.querySelector('.dropped-segments').children)
                    .find(item => item.classList.contains('segment') && 
                                  item.querySelector('span').textContent.replace(/^\d+\.\s*/, '') === parentSegment);
                if (!parentSegmentItem) return;

                const segmentIndex = parseInt(parentSegmentItem.querySelector('span').textContent.match(/^\d+/)[0]);
                const parentSubSegmentItem = Array.from(document.querySelectorAll('.dropped-item.subsegment'))
                    .find(item => item.querySelector('span').textContent.includes(`${segmentIndex}.`) && 
                                  item.querySelector('span').textContent.includes(parentSubSegment));
                if (!parentSubSegmentItem) return;

                const subSegmentMatch = parentSubSegmentItem.querySelector('span').textContent.match(new RegExp(`${segmentIndex}\\.(\\d+)`));
                if (!subSegmentMatch) return;

                const subSegmentIndex = parseInt(subSegmentMatch[1]);
                const parentSubSubSegmentItem = Array.from(document.querySelectorAll('.dropped-item.subsubsegment'))
                    .find(item => item.querySelector('span').textContent.includes(`${segmentIndex}.${subSegmentIndex}.`) && 
                                  item.querySelector('span').textContent.includes(parentSubSubSegment));
                if (!parentSubSubSegmentItem) return;

                const subSubSegmentMatch = parentSubSubSegmentItem.querySelector('span').textContent.match(new RegExp(`${segmentIndex}\\.${subSegmentIndex}\\.(\\d+)`));
                if (!subSubSegmentMatch) return;

                const subSubSegmentIndex = parseInt(subSubSegmentMatch[1]);
                const subSubSubSegmentCount = Array.from(droppedItems.children)
                    .filter(child => child.classList.contains('dropped-item') && child.dataset.type === 'subsubsubsegment')
                    .length + 1;
                const subSubSubSegmentItem = document.createElement('div');
                subSubSubSegmentItem.classList.add('dropped-item', 'subsubsubsegment');
                subSubSubSegmentItem.dataset.type = 'subsubsubsegment';
                subSubSubSegmentItem.dataset.parentSubSubSegment = parentSubSubSegment;
                subSubSubSegmentItem.dataset.parentSubSegment = parentSubSegment;
                subSubSubSegmentItem.dataset.parentSegment = parentSegment;
                const displayText = `${segmentIndex}.${subSegmentIndex}.${subSubSegmentIndex}.${subSubSubSegmentCount}. ${data.value}`;

                subSubSubSegmentItem.innerHTML = `
                    <span>${this.escapeHtml(displayText)}</span>
                    <div class="item-controls">
                        <button class="edit-button" data-action="edit">Edit</button>
                        <button class="add-subsubsubsubsegment-button" data-action="add-subsubsubsubsegment">+ lvl-5</button>
                        <button class="close-button">
                            <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                `;

                const subSubSubSubSegmentSection = document.createElement('div');
                subSubSubSubSegmentSection.classList.add('subsubsubsubsegment-section');
                subSubSubSubSegmentSection.dataset.parentSubSubSubSegment = data.value;
                subSubSubSubSegmentSection.dataset.parentSubSubSegment = parentSubSubSegment;
                subSubSubSubSegmentSection.dataset.parentSubSegment = parentSubSegment;
                subSubSubSubSegmentSection.dataset.parentSegment = parentSegment;
                subSubSubSubSegmentSection.innerHTML = `
                    <div class="subsubsubsubsegment-dropzone">
                        <p class="dropzone-text">Drag and drop sub-sub-sub-sub-segments here</p>
                    </div>
                    <div class="dropped-subsubsubsubsegments"></div>
                `;

                droppedItems.appendChild(subSubSubSegmentItem);
                droppedItems.appendChild(subSubSubSubSegmentSection);

                const subSubSubSubSegmentDropzone = subSubSubSubSegmentSection.querySelector('.subsubsubsubsegment-dropzone');
                subSubSubSubSegmentDropzone.addEventListener('dragover', this.handleDragOver.bind(this));
                subSubSubSubSegmentDropzone.addEventListener('drop', this.handleSubSubSubSubSegmentDrop.bind(this, subSubSubSubSegmentSection));
                subSubSubSubSegmentDropzone.addEventListener('dragleave', this.handleDragLeave.bind(this));

                subSubSubSegmentItem.querySelector('[data-action="add-subsubsubsubsegment"]').addEventListener('click', () => {
                    const isActive = subSubSubSubSegmentSection.classList.contains('active');
                    // Only deactivate other sections at the same level, not all sections
                    document.querySelectorAll('.subsubsubsubsegment-section').forEach(section => {
                        if (section !== subSubSubSubSegmentSection) {
                            section.classList.remove('active');
                        }
                    });
                    if (!isActive) {
                        subSubSubSubSegmentSection.classList.add('active');
                        this.activeSubSubSubSubSegmentDropzone = subSubSubSubSegmentSection;
                    }
                    this.renumberSegments();
                });

                // Add edit functionality
                subSubSubSegmentItem.querySelector('[data-action="edit"]').addEventListener('click', () => {
                    this.editSegment(subSubSubSegmentItem);
                });

                subSubSubSegmentItem.querySelector('.close-button').addEventListener('click', () => {
                    subSubSubSegmentItem.remove();
                    subSubSubSubSegmentSection.remove();
                    this.renumberSegments();
                });

                this.renumberSegments();
                
                // Update segments viewer if visible
                if (this.segmentsViewerVisible) {
                    this.updateSegmentsViewer();
                }
            }

            handleSubSubSubSubSegmentDrop(subSubSubSubSegmentSection, e) {
                e.preventDefault();
                const dropzone = e.currentTarget;
                dropzone.classList.remove('drag-over');
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));

                if (data.type !== 'segment') {
                    this.showNotification('Only segments can be dropped as sub-sub-sub-sub-segments.', 'error');
                    return;
                }

                const parentSubSubSubSegment = subSubSubSubSegmentSection.dataset.parentSubSubSubSegment;
                const parentSubSubSegment = subSubSubSubSegmentSection.dataset.parentSubSubSegment;
                const parentSubSegment = subSubSubSubSegmentSection.dataset.parentSubSegment;
                const parentSegment = subSubSubSubSegmentSection.dataset.parentSegment;

                if (this.checkDuplicate('subsubsubsubsegment', data.value, parentSegment, parentSubSegment, parentSubSubSegment, parentSubSubSubSegment)) {
                    this.showNotification('This sub-sub-sub-sub-segment already exists.', 'error');
                    return;
                }

                const droppedItems = subSubSubSubSegmentSection.querySelector('.dropped-subsubsubsubsegments');
                const parentSegmentItem = Array.from(document.querySelector('.dropped-segments').children)
                    .find(item => item.classList.contains('segment') && 
                                  item.querySelector('span').textContent.replace(/^\d+\.\s*/, '') === parentSegment);
                if (!parentSegmentItem) return;

                const segmentIndex = parseInt(parentSegmentItem.querySelector('span').textContent.match(/^\d+/)[0]);
                const parentSubSegmentItem = Array.from(document.querySelectorAll('.dropped-item.subsegment'))
                    .find(item => item.querySelector('span').textContent.includes(`${segmentIndex}.`) && 
                                  item.querySelector('span').textContent.includes(parentSubSegment));
                if (!parentSubSegmentItem) return;

                const subSegmentMatch = parentSubSegmentItem.querySelector('span').textContent.match(new RegExp(`${segmentIndex}\\.(\\d+)`));
                if (!subSegmentMatch) return;

                const subSegmentIndex = parseInt(subSegmentMatch[1]);
                const parentSubSubSegmentItem = Array.from(document.querySelectorAll('.dropped-item.subsubsegment'))
                    .find(item => item.querySelector('span').textContent.includes(`${segmentIndex}.${subSegmentIndex}.`) && 
                                  item.querySelector('span').textContent.includes(parentSubSubSegment));
                if (!parentSubSubSegmentItem) return;

                const subSubSegmentMatch = parentSubSubSegmentItem.querySelector('span').textContent.match(new RegExp(`${segmentIndex}\\.${subSegmentIndex}\\.(\\d+)`));
                if (!subSubSegmentMatch) return;

                const subSubSegmentIndex = parseInt(subSubSegmentMatch[1]);
                const parentSubSubSubSegmentItem = Array.from(document.querySelectorAll('.dropped-item.subsubsubsegment'))
                    .find(item => item.querySelector('span').textContent.includes(`${segmentIndex}.${subSegmentIndex}.${subSubSegmentIndex}.`) && 
                                  item.querySelector('span').textContent.includes(parentSubSubSubSegment));
                if (!parentSubSubSubSegmentItem) return;

                const subSubSubSegmentMatch = parentSubSubSubSegmentItem.querySelector('span').textContent.match(new RegExp(`${segmentIndex}\\.${subSegmentIndex}\\.${subSubSegmentIndex}\\.(\\d+)`));
                if (!subSubSubSegmentMatch) return;

                const subSubSubSegmentIndex = parseInt(subSubSubSegmentMatch[1]);
                const subSubSubSubSegmentCount = Array.from(droppedItems.children)
                    .filter(child => child.classList.contains('dropped-item') && child.dataset.type === 'subsubsubsubsegment')
                    .length + 1;
                const subSubSubSubSegmentItem = document.createElement('div');
                subSubSubSubSegmentItem.classList.add('dropped-item', 'subsubsubsubsegment');
                subSubSubSubSegmentItem.dataset.type = 'subsubsubsubsegment';
                subSubSubSubSegmentItem.dataset.parentSubSubSubSegment = parentSubSubSubSegment;
                subSubSubSubSegmentItem.dataset.parentSubSubSegment = parentSubSubSegment;
                subSubSubSubSegmentItem.dataset.parentSubSegment = parentSubSegment;
                subSubSubSubSegmentItem.dataset.parentSegment = parentSegment;
                const displayText = `${segmentIndex}.${subSegmentIndex}.${subSubSegmentIndex}.${subSubSubSegmentIndex}.${subSubSubSubSegmentCount}. ${data.value}`;

                // NO LEVEL 6 BUTTON - removed the add-subsubsubsubsubsegment button
                subSubSubSubSegmentItem.innerHTML = `
                    <span>${this.escapeHtml(displayText)}</span>
                    <div class="item-controls">
                        <button class="edit-button" data-action="edit">Edit</button>
                        <button class="close-button">
                            <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                `;

                // NO LEVEL 6 SECTION CREATION - removed subsubsubsubsubsegment-section creation

                // Add edit functionality
                subSubSubSubSegmentItem.querySelector('[data-action="edit"]').addEventListener('click', () => {
                    this.editSegment(subSubSubSubSegmentItem);
                });

                subSubSubSubSegmentItem.querySelector('.close-button').addEventListener('click', () => {
                    subSubSubSubSegmentItem.remove();
                    this.renumberSegments();
                });

                droppedItems.appendChild(subSubSubSubSegmentItem);
                this.renumberSegments();
                
                // Update segments viewer if visible
                if (this.segmentsViewerVisible) {
                    this.updateSegmentsViewer();
                }
            }

            renumberSegments() {
                const droppedItems = document.querySelector('.dropped-segments');
                const segments = Array.from(droppedItems.querySelectorAll('.dropped-item.segment'));

                segments.forEach((segment, segmentIndex) => {
                    const segmentNumber = segmentIndex + 1;
                    const segmentSpan = segment.querySelector('span');
                    const segmentText = segmentSpan.textContent.replace(/^\d+\.\s*/, '');
                    segmentSpan.textContent = `${segmentNumber}. ${segmentText}`;

                    const parentSegmentText = segmentText;
                    const subSegmentSection = droppedItems.querySelector(`.subsegment-section[data-parent-segment="${parentSegmentText}"]`);
                    if (subSegmentSection) {
                        const subSegments = subSegmentSection.querySelectorAll('.dropped-item.subsegment');
                        subSegments.forEach((subSegment, subIndex) => {
                            const subSegmentNumber = subIndex + 1;
                            const subSegmentSpan = subSegment.querySelector('span');
                            const subSegmentText = subSegmentSpan.textContent.replace(/^\d+\.\d+\.\s*/, '');
                            subSegmentSpan.textContent = `${segmentNumber}.${subSegmentNumber}. ${subSegmentText}`;

                            const parentSubSegmentText = subSegmentText;
                            const subSubSegmentSection = subSegmentSection.querySelector(`.subsubsegment-section[data-parent-sub-segment="${parentSubSegmentText}"]`);
                            if (subSubSegmentSection) {
                                const subSubSegments = subSubSegmentSection.querySelectorAll('.dropped-item.subsubsegment');
                                subSubSegments.forEach((subSubSegment, subSubIndex) => {
                                    const subSubSegmentNumber = subSubIndex + 1;
                                    const subSubSegmentSpan = subSubSegment.querySelector('span');
                                    const subSubSegmentText = subSubSegmentSpan.textContent.replace(/^\d+\.\d+\.\d+\.\s*/, '');
                                    subSubSegmentSpan.textContent = `${segmentNumber}.${subSegmentNumber}.${subSubSegmentNumber}. ${subSubSegmentText}`;

                                    const parentSubSubSegmentText = subSubSegmentText;
                                    const subSubSubSegmentSection = subSubSegmentSection.querySelector(`.subsubsubsegment-section[data-parent-sub-sub-segment="${parentSubSubSegmentText}"]`);
                                    if (subSubSubSegmentSection) {
                                        const subSubSubSegments = subSubSubSegmentSection.querySelectorAll('.dropped-item.subsubsubsegment');
                                        subSubSubSegments.forEach((subSubSubSegment, subSubSubIndex) => {
                                            const subSubSubSegmentNumber = subSubSubIndex + 1;
                                            const subSubSubSegmentSpan = subSubSubSegment.querySelector('span');
                                            const subSubSubSegmentText = subSubSubSegmentSpan.textContent.replace(/^\d+\.\d+\.\d+\.\d+\.\s*/, '');
                                            subSubSubSegmentSpan.textContent = `${segmentNumber}.${subSegmentNumber}.${subSubSegmentNumber}.${subSubSubSegmentNumber}. ${subSubSubSegmentText}`;

                                            const parentSubSubSubSegmentText = subSubSubSegmentText;
                                            const subSubSubSubSegmentSection = subSubSubSegmentSection.querySelector(`.subsubsubsubsegment-section[data-parent-sub-sub-sub-segment="${parentSubSubSubSegmentText}"]`);
                                            if (subSubSubSubSegmentSection) {
                                                const subSubSubSubSegments = subSubSubSubSegmentSection.querySelectorAll('.dropped-item.subsubsubsubsegment');
                                                subSubSubSubSegments.forEach((subSubSubSubSegment, subSubSubSubIndex) => {
                                                    const subSubSubSubSegmentNumber = subSubSubSubIndex + 1;
                                                    const subSubSubSubSegmentSpan = subSubSubSubSegment.querySelector('span');
                                                    const subSubSubSubSegmentText = subSubSubSubSegmentSpan.textContent.replace(/^\d+\.\d+\.\d+\.\d+\.\d+\.\s*/, '');
                                                    subSubSubSubSegmentSpan.textContent = `${segmentNumber}.${subSegmentNumber}.${subSubSegmentNumber}.${subSubSubSegmentNumber}.${subSubSubSubSegmentNumber}. ${subSubSubSubSegmentText}`;
                                                });
                                            }
                                        });
                                    }
                                });
                            }
                        });
                    }
                });
                
                // Update segments viewer if visible
                if (this.segmentsViewerVisible) {
                    this.updateSegmentsViewer();
                }
            }

            handleManualAdd(section) {
                const manualEntry = document.querySelector(`.manual-entry[data-section="${section}"]`);
                const inputField = manualEntry.querySelector('input, textarea');
                const value = inputField.value.trim();
                if (!value) {
                    this.showNotification('Please enter a name.', 'warning');
                    return;
                }
                if (section === 'companies') {
                    // Check if input contains multiple lines (bulk entry)
                    const lines = value.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                    
                    if (lines.length > 1) {
                        // Bulk entry mode: add each company separately
                        let addedCount = 0;
                        let skippedCount = 0;
                        const droppedItems = document.querySelector('.dropped-companies');
                        
                        lines.forEach(company => {
                            if (this.checkDuplicate('companies', company)) {
                                skippedCount++;
                                return;
                            }
                            const item = document.createElement('div');
                            item.classList.add('dropped-item', 'company');
                            item.innerHTML = `
                                <span>${this.escapeHtml(company)}</span>
                                <div class="item-controls">
                                    <button class="edit-button" data-action="edit">Edit</button>
                                    <button class="close-button">
                                        <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                            <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                            <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                </div>
                            `;
                            item.querySelector('[data-action="edit"]').addEventListener('click', () => {
                                this.editCompany(item);
                            });
                            item.querySelector('.close-button').addEventListener('click', () => {
                                item.remove();
                            });
                            droppedItems.appendChild(item);
                            addedCount++;
                        });
                        
                        if (addedCount > 0) {
                            this.showNotification(`Added ${addedCount} companies${skippedCount > 0 ? ` (${skippedCount} duplicates skipped)` : ''}.`, 'success');
                        }
                        if (skippedCount > 0 && addedCount === 0) {
                            this.showNotification(`All entries are duplicates.`, 'warning');
                        }
                        inputField.value = '';
                    } else {
                        // Single entry mode: process as before
                        if (this.checkDuplicate('companies', value)) {
                            this.showNotification('This company already exists.', 'error');
                            return;
                        }
                        const droppedItems = document.querySelector('.dropped-companies');
                        const item = document.createElement('div');
                        item.classList.add('dropped-item', 'company');
                        item.innerHTML = `
                            <span>${this.escapeHtml(value)}</span>
                            <div class="item-controls">
                                <button class="edit-button" data-action="edit">Edit</button>
                                <button class="close-button">
                                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                        <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                        <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        `;
                        item.querySelector('[data-action="edit"]').addEventListener('click', () => {
                            this.editCompany(item);
                        });
                        item.querySelector('.close-button').addEventListener('click', () => {
                            item.remove();
                        });
                        droppedItems.appendChild(item);
                        inputField.value = '';
                    }
                } else if (section === 'segments') {
                    // Handle manual segment addition with proper hierarchical structure
                    // Route manual addition to the last clicked level section if present
                    if (this.activeManualTarget && this.activeManualTarget.sectionElem) {
                        const level = this.activeManualTarget.level;
                        const sectionElem = this.activeManualTarget.sectionElem;
                        // Reset all, then set only the targeted level as active
                        this.activeSubSegmentDropzone = null;
                        this.activeSubSubSegmentDropzone = null;
                        this.activeSubSubSubSegmentDropzone = null;
                        this.activeSubSubSubSubSegmentDropzone = null;
                        if (level === 1) {
                            this.activeSubSegmentDropzone = sectionElem;
                        } else if (level === 2) {
                            this.activeSubSubSegmentDropzone = sectionElem;
                        } else if (level === 3) {
                            this.activeSubSubSubSegmentDropzone = sectionElem;
                        } else if (level === 4) {
                            this.activeSubSubSubSubSegmentDropzone = sectionElem;
                        }
                    }
                    if (this.activeSubSubSubSubSegmentDropzone) {
                        // Level 5 segments - NO LEVEL 6
                        const sectionElem = this.activeSubSubSubSubSegmentDropzone;
                        const parentSegment = sectionElem.dataset.parentSegment;
                        const parentSubSegment = sectionElem.dataset.parentSubSegment;
                        const parentSubSubSegment = sectionElem.dataset.parentSubSubSegment;
                        const parentSubSubSubSegment = sectionElem.dataset.parentSubSubSubSegment;
                        
                        if (this.checkDuplicate('subsubsubsubsegment', value, parentSegment, parentSubSegment, parentSubSubSegment, parentSubSubSubSegment)) {
                            this.showNotification('This item already exists in the section.', 'error');
                            return;
                        }
                        
                        const droppedItems = sectionElem.querySelector('.dropped-subsubsubsubsegments');
                        const parentSegmentItem = Array.from(document.querySelector('.dropped-segments').children)
                            .find(item => item.classList.contains('segment') && item.querySelector('span').textContent.replace(/^\d+\.\s*/, '') === parentSegment);
                        const segmentIndex = parseInt(parentSegmentItem.querySelector('span').textContent.match(/^\d+/)[0]);
                        
                        // Find all parent items to get their indices
                        const parentSubSegmentItem = Array.from(document.querySelectorAll('.dropped-item.subsegment'))
                            .find(item => item.dataset.parentSegment === parentSegment && item.querySelector('span').textContent.replace(/^\d+\.\d+\.\s*/, '') === parentSubSegment);
                        const subSegmentMatch = parentSubSegmentItem.querySelector('span').textContent.match(/^\d+\.(\d+)/);
                        const subSegmentIndex = parseInt(subSegmentMatch[1]);
                        
                        const parentSubSubSegmentItem = Array.from(document.querySelectorAll('.dropped-item.subsubsegment'))
                            .find(item => item.dataset.parentSegment === parentSegment && item.dataset.parentSubSegment === parentSubSegment && item.querySelector('span').textContent.replace(/^\d+\.\d+\.\d+\.\s*/, '') === parentSubSubSegment);
                        const subSubSegmentMatch = parentSubSubSegmentItem.querySelector('span').textContent.match(/^\d+\.\d+\.(\d+)/);
                        const subSubSegmentIndex = parseInt(subSubSegmentMatch[1]);
                        
                        const parentSubSubSubSegmentItem = Array.from(document.querySelectorAll('.dropped-item.subsubsubsegment'))
                            .find(item => item.dataset.parentSegment === parentSegment && item.dataset.parentSubSegment === parentSubSegment && item.dataset.parentSubSubSegment === parentSubSubSegment && item.querySelector('span').textContent.replace(/^\d+\.\d+\.\d+\.\d+\.\s*/, '') === parentSubSubSubSegment);
                        const subSubSubSegmentMatch = parentSubSubSubSegmentItem.querySelector('span').textContent.match(/^\d+\.\d+\.\d+\.(\d+)/);
                        const subSubSubSegmentIndex = parseInt(subSubSubSegmentMatch[1]);
                        
                        const subSubSubSubSegmentCount = Array.from(droppedItems.children)
                            .filter(child => child.classList.contains('dropped-item') && child.dataset.type === 'subsubsubsubsegment')
                            .length + 1;
                        const item = document.createElement('div');
                        item.classList.add('dropped-item', 'subsubsubsubsegment');
                        item.dataset.type = 'subsubsubsubsegment';
                        item.dataset.parentSubSubSubSegment = parentSubSubSubSegment;
                        item.dataset.parentSubSubSegment = parentSubSubSegment;
                        item.dataset.parentSubSegment = parentSubSegment;
                        item.dataset.parentSegment = parentSegment;
                        const displayText = `${segmentIndex}.${subSegmentIndex}.${subSubSegmentIndex}.${subSubSubSegmentIndex}.${subSubSubSubSegmentCount}. ${value}`;
                        
                        // NO LEVEL 6 BUTTON
                        item.innerHTML = `
                            <span>${this.escapeHtml(displayText)}</span>
                            <div class="item-controls">
                                <button class="edit-button" data-action="edit">Edit</button>
                                <button class="close-button">
                                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                        <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                        <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        `;
                        
                        // NO LEVEL 6 SECTION CREATION
                        
                        // Add edit functionality
                        item.querySelector('[data-action="edit"]').addEventListener('click', () => {
                            this.editSegment(item);
                        });
                        
                        item.querySelector('.close-button').addEventListener('click', () => {
                            item.remove();
                            this.renumberSegments();
                        });
                        
                        droppedItems.appendChild(item);
                        this.renumberSegments();
                    } else if (this.activeSubSubSubSegmentDropzone) {
                        // Level 4 segments
                        const sectionElem = this.activeSubSubSubSegmentDropzone;
                        const parentSegment = sectionElem.dataset.parentSegment;
                        const parentSubSegment = sectionElem.dataset.parentSubSegment;
                        const parentSubSubSegment = sectionElem.dataset.parentSubSubSegment;
                        
                        if (this.checkDuplicate('subsubsubsegment', value, parentSegment, parentSubSegment, parentSubSubSegment)) {
                            this.showNotification('This item already exists in the section.', 'error');
                            return;
                        }
                        
                        const droppedItems = sectionElem.querySelector('.dropped-subsubsubsegments');
                        const parentSegmentItem = Array.from(document.querySelector('.dropped-segments').children)
                            .find(item => item.classList.contains('segment') && item.querySelector('span').textContent.replace(/^\d+\.\s*/, '') === parentSegment);
                        const segmentIndex = parseInt(parentSegmentItem.querySelector('span').textContent.match(/^\d+/)[0]);
                        
                        const parentSubSegmentItem = Array.from(document.querySelectorAll('.dropped-item.subsegment'))
                            .find(item => item.dataset.parentSegment === parentSegment && item.querySelector('span').textContent.replace(/^\d+\.\d+\.\s*/, '') === parentSubSegment);
                        const subSegmentMatch = parentSubSegmentItem.querySelector('span').textContent.match(/^\d+\.(\d+)/);
                        const subSegmentIndex = parseInt(subSegmentMatch[1]);
                        
                        const parentSubSubSegmentItem = Array.from(document.querySelectorAll('.dropped-item.subsubsegment'))
                            .find(item => item.dataset.parentSegment === parentSegment && item.dataset.parentSubSegment === parentSubSegment && item.querySelector('span').textContent.replace(/^\d+\.\d+\.\d+\.\s*/, '') === parentSubSubSegment);
                        const subSubSegmentMatch = parentSubSubSegmentItem.querySelector('span').textContent.match(/^\d+\.\d+\.(\d+)/);
                        const subSubSegmentIndex = parseInt(subSubSegmentMatch[1]);
                        
                        const subSubSubSegmentCount = Array.from(droppedItems.children)
                            .filter(child => child.classList.contains('dropped-item') && child.dataset.type === 'subsubsubsegment')
                            .length + 1;
                        const item = document.createElement('div');
                        item.classList.add('dropped-item', 'subsubsubsegment');
                        item.dataset.type = 'subsubsubsegment';
                        item.dataset.parentSubSubSegment = parentSubSubSegment;
                        item.dataset.parentSubSegment = parentSubSegment;
                        item.dataset.parentSegment = parentSegment;
                        const displayText = `${segmentIndex}.${subSegmentIndex}.${subSubSegmentIndex}.${subSubSubSegmentCount}. ${value}`;
                        
                        item.innerHTML = `
                            <span>${this.escapeHtml(displayText)}</span>
                            <div class="item-controls">
                                <button class="edit-button" data-action="edit">Edit</button>
                                <button class="add-subsubsubsubsegment-button" data-action="add-subsubsubsubsegment">+ lvl-5</button>
                                <button class="close-button">
                                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                        <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                        <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        `;
                        
                        const subSubSubSubSegmentSection = document.createElement('div');
                        subSubSubSubSegmentSection.classList.add('subsubsubsubsegment-section');
                        subSubSubSubSegmentSection.dataset.parentSubSubSubSegment = value;
                        subSubSubSubSegmentSection.dataset.parentSubSubSegment = parentSubSubSegment;
                        subSubSubSubSegmentSection.dataset.parentSubSegment = parentSubSegment;
                        subSubSubSubSegmentSection.dataset.parentSegment = parentSegment;
                        subSubSubSubSegmentSection.innerHTML = `
                            <div class="subsubsubsubsegment-dropzone">
                                <p class="dropzone-text">Drag and drop sub-sub-sub-sub-segments here</p>
                            </div>
                            <div class="dropped-subsubsubsubsegments"></div>
                        `;
                        
                        droppedItems.appendChild(item);
                        droppedItems.appendChild(subSubSubSubSegmentSection);
                        
                        const subSubSubSubSegmentDropzone = subSubSubSubSegmentSection.querySelector('.subsubsubsubsegment-dropzone');
                        subSubSubSubSegmentDropzone.addEventListener('dragover', this.handleDragOver.bind(this));
                        subSubSubSubSegmentDropzone.addEventListener('drop', this.handleSubSubSubSubSegmentDrop.bind(this, subSubSubSubSegmentSection));
                        subSubSubSubSegmentDropzone.addEventListener('dragleave', this.handleDragLeave.bind(this));
                        
                        item.querySelector('[data-action="add-subsubsubsubsegment"]').addEventListener('click', () => {
                            const isActive = subSubSubSubSegmentSection.classList.contains('active');
                            // Only deactivate other sections at the same level, not all sections
                            document.querySelectorAll('.subsubsubsubsegment-section').forEach(section => {
                                if (section !== subSubSubSubSegmentSection) {
                                    section.classList.remove('active');
                                }
                            });
                            if (!isActive) {
                                subSubSubSubSegmentSection.classList.add('active');
                                this.activeSubSubSubSubSegmentDropzone = subSubSubSubSegmentSection;
                                this.activeManualTarget = { level: 4, sectionElem: subSubSubSubSegmentSection };
                            }
                            this.renumberSegments();
                        });
                        
                        // Add edit functionality
                        item.querySelector('[data-action="edit"]').addEventListener('click', () => {
                            this.editSegment(item);
                        });
                        
                        item.querySelector('.close-button').addEventListener('click', () => {
                            item.remove();
                            subSubSubSubSegmentSection.remove();
                            this.renumberSegments();
                        });
                        
                        this.renumberSegments();
                    } else if (this.activeSubSubSegmentDropzone) {
                        // Level 3 segments
                        const sectionElem = this.activeSubSubSegmentDropzone;
                        const parentSegment = sectionElem.dataset.parentSegment;
                        const parentSubSegment = sectionElem.dataset.parentSubSegment;
                        
                        if (this.checkDuplicate('subsubsegment', value, parentSegment, parentSubSegment)) {
                            this.showNotification('This item already exists in the section.', 'error');
                            return;
                        }
                        
                        const droppedItems = sectionElem.querySelector('.dropped-subsubsegments');
                        const parentSegmentItem = Array.from(document.querySelector('.dropped-segments').children)
                            .find(item => item.classList.contains('segment') && item.querySelector('span').textContent.replace(/^\d+\.\s*/, '') === parentSegment);
                        const segmentIndex = parseInt(parentSegmentItem.querySelector('span').textContent.match(/^\d+/)[0]);
                        
                        const parentSubSegmentItem = Array.from(document.querySelectorAll('.dropped-item.subsegment'))
                            .find(item => item.dataset.parentSegment === parentSegment && item.querySelector('span').textContent.replace(/^\d+\.\d+\.\s*/, '') === parentSubSegment);
                        const subSegmentMatch = parentSubSegmentItem.querySelector('span').textContent.match(/^\d+\.(\d+)/);
                        const subSegmentIndex = parseInt(subSegmentMatch[1]);
                        
                        const subSubSegmentCount = Array.from(droppedItems.children)
                            .filter(child => child.classList.contains('dropped-item') && child.dataset.type === 'subsubsegment')
                            .length + 1;
                        const item = document.createElement('div');
                        item.classList.add('dropped-item', 'subsubsegment');
                        item.dataset.type = 'subsubsegment';
                        item.dataset.parentSubSegment = parentSubSegment;
                        item.dataset.parentSegment = parentSegment;
                        const displayText = `${segmentIndex}.${subSegmentIndex}.${subSubSegmentCount}. ${value}`;
                        
                        item.innerHTML = `
                            <span>${this.escapeHtml(displayText)}</span>
                            <div class="item-controls">
                                <button class="edit-button" data-action="edit">Edit</button>
                                <button class="add-subsubsubsegment-button" data-action="add-subsubsubsegment">+ lvl-4</button>
                                <button class="close-button">
                                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                        <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                        <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        `;
                        
                        const subSubSubSegmentSection = document.createElement('div');
                        subSubSubSegmentSection.classList.add('subsubsubsegment-section');
                        subSubSubSegmentSection.dataset.parentSubSubSegment = value;
                        subSubSubSegmentSection.dataset.parentSubSegment = parentSubSegment;
                        subSubSubSegmentSection.dataset.parentSegment = parentSegment;
                        subSubSubSegmentSection.innerHTML = `
                            <div class="subsubsubsegment-dropzone">
                                <p class="dropzone-text">Drag and drop sub-sub-sub-segments here</p>
                            </div>
                            <div class="dropped-subsubsubsegments"></div>
                        `;
                        
                        droppedItems.appendChild(item);
                        droppedItems.appendChild(subSubSubSegmentSection);
                        
                        const subSubSubSegmentDropzone = subSubSubSegmentSection.querySelector('.subsubsubsegment-dropzone');
                        subSubSubSegmentDropzone.addEventListener('dragover', this.handleDragOver.bind(this));
                        subSubSubSegmentDropzone.addEventListener('drop', this.handleSubSubSubSegmentDrop.bind(this, subSubSubSegmentSection));
                        subSubSubSegmentDropzone.addEventListener('dragleave', this.handleDragLeave.bind(this));
                        
                        item.querySelector('[data-action="add-subsubsubsegment"]').addEventListener('click', () => {
                            const isActive = subSubSubSegmentSection.classList.contains('active');
                            // Only deactivate other sections at the same level, not all sections
                            document.querySelectorAll('.subsubsubsegment-section').forEach(section => {
                                if (section !== subSubSubSegmentSection) {
                                    section.classList.remove('active');
                                }
                            });
                            if (!isActive) {
                                subSubSubSegmentSection.classList.add('active');
                                this.activeSubSubSubSegmentDropzone = subSubSubSegmentSection;
                                this.activeManualTarget = { level: 3, sectionElem: subSubSubSegmentSection };
                            }
                            this.renumberSegments();
                        });
                        
                        // Add edit functionality
                        item.querySelector('[data-action="edit"]').addEventListener('click', () => {
                            this.editSegment(item);
                        });
                        
                        item.querySelector('.close-button').addEventListener('click', () => {
                            item.remove();
                            subSubSubSegmentSection.remove();
                            this.renumberSegments();
                        });
                        
                        this.renumberSegments();
                    } else if (this.activeSubSegmentDropzone) {
                        // Level 2 segments
                        const sectionElem = this.activeSubSegmentDropzone;
                        const parentSegment = sectionElem.dataset.parentSegment;
                        
                        if (this.checkDuplicate('subsegment', value, parentSegment)) {
                            this.showNotification('This item already exists in the section.', 'error');
                            return;
                        }
                        
                        const droppedItems = sectionElem.querySelector('.dropped-subsegments');
                        const parentSegmentItem = Array.from(document.querySelector('.dropped-segments').children)
                            .find(item => item.classList.contains('segment') && item.querySelector('span').textContent.replace(/^\d+\.\s*/, '') === parentSegment);
                        const segmentIndex = parseInt(parentSegmentItem.querySelector('span').textContent.match(/^\d+/)[0]);
                        
                        const subSegmentCount = Array.from(droppedItems.children)
                            .filter(child => child.classList.contains('dropped-item') && child.dataset.type === 'subsegment')
                            .length + 1;
                        const item = document.createElement('div');
                        item.classList.add('dropped-item', 'subsegment');
                        item.dataset.type = 'subsegment';
                        item.dataset.parentSegment = parentSegment;
                        const displayText = `${segmentIndex}.${subSegmentCount}. ${value}`;
                        
                        item.innerHTML = `
                            <span>${this.escapeHtml(displayText)}</span>
                            <div class="item-controls">
                                <button class="edit-button" data-action="edit">Edit</button>
                                <button class="add-subsubsegment-button" data-action="add-subsubsegment">+ lvl-3</button>
                                <button class="close-button">
                                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                        <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                        <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        `;
                        
                        const subSubSegmentSection = document.createElement('div');
                        subSubSegmentSection.classList.add('subsubsegment-section');
                        subSubSegmentSection.dataset.parentSubSegment = value;
                        subSubSegmentSection.dataset.parentSegment = parentSegment;
                        subSubSegmentSection.innerHTML = `
                            <div class="subsubsegment-dropzone">
                                <p class="dropzone-text">Drag and drop sub-sub-segments here</p>
                            </div>
                            <div class="dropped-subsubsegments"></div>
                        `;
                        
                        droppedItems.appendChild(item);
                        droppedItems.appendChild(subSubSegmentSection);
                        
                        const subSubSegmentDropzone = subSubSegmentSection.querySelector('.subsubsegment-dropzone');
                        subSubSegmentDropzone.addEventListener('dragover', this.handleDragOver.bind(this));
                        subSubSegmentDropzone.addEventListener('drop', this.handleSubSubSegmentDrop.bind(this, subSubSegmentSection));
                        subSubSegmentDropzone.addEventListener('dragleave', this.handleDragLeave.bind(this));
                        
                        item.querySelector('[data-action="add-subsubsegment"]').addEventListener('click', () => {
                            const isActive = subSubSegmentSection.classList.contains('active');
                            // Only deactivate other sections at the same level, not all sections
                            document.querySelectorAll('.subsubsegment-section').forEach(section => {
                                if (section !== subSubSegmentSection) {
                                    section.classList.remove('active');
                                }
                            });
                            if (!isActive) {
                                subSubSegmentSection.classList.add('active');
                                this.activeSubSubSegmentDropzone = subSubSegmentSection;
                                this.activeManualTarget = { level: 2, sectionElem: subSubSegmentSection };
                            }
                            this.renumberSegments();
                        });
                        
                        // Add edit functionality
                        item.querySelector('[data-action="edit"]').addEventListener('click', () => {
                            this.editSegment(item);
                        });
                        
                        item.querySelector('.close-button').addEventListener('click', () => {
                            item.remove();
                            subSubSegmentSection.remove();
                            this.renumberSegments();
                        });
                        
                        this.renumberSegments();
                    } else {
                        // Level 1 segments
                        const droppedItems = document.querySelector('.dropped-segments');
                        if (this.checkDuplicate('segments', value)) {
                            this.showNotification('This item already exists in the section.', 'error');
                            return;
                        }
                        
                        const segmentCount = Array.from(droppedItems.children).filter(child => child.dataset.type === 'segment').length + 1;
                        const item = document.createElement('div');
                        item.classList.add('dropped-item', 'segment');
                        item.dataset.type = 'segment';
                        const displayText = `${segmentCount}. ${value}`;
                        
                        item.innerHTML = `
                            <span>${this.escapeHtml(displayText)}</span>
                            <div class="item-controls">
                                <button class="edit-button" data-action="edit">Edit</button>
                                <button class="add-subsegment-button" data-action="add-subsegment">+ lvl-2</button>
                                <button class="close-button">
                                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                                        <path d="M1 1L9 9" stroke="#464646" stroke-linecap="round"/>
                                        <path d="M9 1L1 9" stroke="#464646" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        `;
                        
                        const subSegmentSection = document.createElement('div');
                        subSegmentSection.classList.add('subsegment-section');
                        subSegmentSection.dataset.parentSegment = value;
                        subSegmentSection.innerHTML = `
                            <div class="subsegment-dropzone">
                                <p class="dropzone-text">Drag and drop sub-segments here</p>
                            </div>
                            <div class="dropped-subsegments"></div>
                        `;
                        
                        droppedItems.appendChild(item);
                        droppedItems.appendChild(subSegmentSection);
                        
                        const subSegmentDropzone = subSegmentSection.querySelector('.subsegment-dropzone');
                        subSegmentDropzone.addEventListener('dragover', this.handleDragOver.bind(this));
                        subSegmentDropzone.addEventListener('drop', this.handleSubSegmentDrop.bind(this, subSegmentSection));
                        subSegmentDropzone.addEventListener('dragleave', this.handleDragLeave.bind(this));
                        
                        item.querySelector('[data-action="add-subsegment"]').addEventListener('click', () => {
                            const isActive = subSegmentSection.classList.contains('active');
                            // Only deactivate other sections at the same level, not all sections
                            document.querySelectorAll('.subsegment-section').forEach(section => {
                                if (section !== subSegmentSection) {
                                    section.classList.remove('active');
                                }
                            });
                            if (!isActive) {
                                subSegmentSection.classList.add('active');
                                this.activeSubSegmentDropzone = subSegmentSection;
                                this.activeManualTarget = { level: 1, sectionElem: subSegmentSection };
                            }
                            this.renumberSegments();
                        });
                        
                        // Add edit functionality
                        item.querySelector('[data-action="edit"]').addEventListener('click', () => {
                            this.editSegment(item);
                        });
                        
                        item.querySelector('.close-button').addEventListener('click', () => {
                            item.remove();
                            subSegmentSection.remove();
                            this.renumberSegments();
                        });
                        
                        this.renumberSegments();
                    }
                    input.value = '';
                    
                    // Update segments viewer if visible
                    if (this.segmentsViewerVisible) {
                        this.updateSegmentsViewer();
                    }
                }
            }

            // Explicitly clear any active sub-level selection so manual typing targets Level 1
            resetActiveDropzones() {
                try {
                    document.querySelectorAll('.subsegment-section, .subsubsegment-section, .subsubsubsegment-section, .subsubsubsubsegment-section').forEach(section => {
                        section.classList.remove('active');
                    });
                } catch (err) {
                    // no-op
                }
                this.activeSubSegmentDropzone = null;
                this.activeSubSubSegmentDropzone = null;
                this.activeSubSubSubSegmentDropzone = null;
                this.activeSubSubSubSubSegmentDropzone = null;
            }

            // Move targeting up by one level (e.g., 5->4->3->2->1)
            goUpOneLevel() {
                const deactivateAll = () => {
                    document.querySelectorAll('.subsegment-section, .subsubsegment-section, .subsubsubsegment-section, .subsubsubsubsegment-section').forEach(section => {
                        section.classList.remove('active');
                    });
                };

                // From Level 5 to Level 4
                if (this.activeSubSubSubSubSegmentDropzone) {
                    const cur = this.activeSubSubSubSubSegmentDropzone;
                    const parentSegment = cur.dataset.parentSegment;
                    const parentSubSegment = cur.dataset.parentSubSegment;
                    const parentSubSubSegment = cur.dataset.parentSubSubSegment;
                    const target = Array.from(document.querySelectorAll('.subsubsubsegment-section')).find(sec =>
                        sec.dataset.parentSegment === parentSegment &&
                        sec.dataset.parentSubSegment === parentSubSegment &&
                        sec.dataset.parentSubSubSegment === parentSubSubSegment
                    );
                    deactivateAll();
                    this.activeSubSubSubSubSegmentDropzone = null;
                    if (target) {
                        target.classList.add('active');
                        this.activeSubSubSubSegmentDropzone = target;
                        this.showNotification('Target set to Level 4.', 'info');
                    } else {
                        this.activeSubSubSubSegmentDropzone = null;
                        this.showNotification('Target set to Level 1.', 'info');
                    }
                    return;
                }

                // From Level 4 to Level 3
                if (this.activeSubSubSubSegmentDropzone) {
                    const cur = this.activeSubSubSubSegmentDropzone;
                    const parentSegment = cur.dataset.parentSegment;
                    const parentSubSegment = cur.dataset.parentSubSegment;
                    const target = Array.from(document.querySelectorAll('.subsubsegment-section')).find(sec =>
                        sec.dataset.parentSegment === parentSegment &&
                        sec.dataset.parentSubSegment === parentSubSegment
                    );
                    deactivateAll();
                    this.activeSubSubSubSegmentDropzone = null;
                    if (target) {
                        target.classList.add('active');
                        this.activeSubSubSegmentDropzone = target;
                        this.showNotification('Target set to Level 3.', 'info');
                    } else {
                        this.activeSubSubSegmentDropzone = null;
                        this.showNotification('Target set to Level 1.', 'info');
                    }
                    return;
                }

                // From Level 3 to Level 2
                if (this.activeSubSubSegmentDropzone) {
                    const cur = this.activeSubSubSegmentDropzone;
                    const parentSegment = cur.dataset.parentSegment;
                    const target = Array.from(document.querySelectorAll('.subsegment-section')).find(sec =>
                        sec.dataset.parentSegment === parentSegment
                    );
                    deactivateAll();
                    this.activeSubSubSegmentDropzone = null;
                    if (target) {
                        target.classList.add('active');
                        this.activeSubSegmentDropzone = target;
                        this.showNotification('Target set to Level 2.', 'info');
                    } else {
                        this.activeSubSegmentDropzone = null;
                        this.showNotification('Target set to Level 1.', 'info');
                    }
                    return;
                }

                // From Level 2 to Level 1
                if (this.activeSubSegmentDropzone) {
                    this.resetActiveDropzones();
                    this.showNotification('Target set to Level 1.', 'info');
                    return;
                }

                // Already Level 1
                this.showNotification('Already at Level 1.', 'info');
            }

            clearComparison() {
                document.querySelector('#report-title').value = '';
                document.querySelector('.dropped-segments').innerHTML = '';
                document.querySelector('.dropped-companies').innerHTML = '';
                // Hide download section when clearing comparison
                document.querySelector('.download-section').style.display = 'none';
                document.querySelector('.download-button').disabled = true;
                this.reportBlob = null;
                this.showNotification('Comparison area cleared.', 'info');
                
                // Update segments viewer if visible
                if (this.segmentsViewerVisible) {
                    this.updateSegmentsViewer();
                }
            }

            async generateReport() {
                const title = document.querySelector('#report-title').value.trim();
                const segments = this.collectAllSegmentsForViewer();
                const companies = Array.from(document.querySelectorAll('.dropped-companies .dropped-item span')).map(span => span.textContent);

                // Collect market inputs
                const unit = (document.querySelector('#value-unit')?.value || '').trim();
                const cagrStr = (document.querySelector('#cagr-2025-2033')?.value || '').trim();
                const val2024Str = (document.querySelector('#market-size-2024')?.value || '').trim();
                const val2033Str = (document.querySelector('#projected-size-2033')?.value || '').trim();
                const cagrVal = parseFloat(cagrStr);
                const val2024 = parseFloat(val2024Str);
                const val2033 = parseFloat(val2033Str);

                // Collect industry classification data
                const sector = (document.querySelector('#sector-dropdown')?.value || '').trim();
                const industryGroup = (document.querySelector('#industry-group-dropdown')?.value || '').trim();
                const industry = (document.querySelector('#industry-dropdown')?.value || '').trim();
                const subIndustry = (document.querySelector('#sub-industry-dropdown')?.value || '').trim();

                // Get display names from dropdown options
                const getSectorName = () => {
                    const sel = document.querySelector('#sector-dropdown');
                    return sel?.options[sel.selectedIndex]?.text || sector;
                };
                const getIndustryGroupName = () => {
                    const sel = document.querySelector('#industry-group-dropdown');
                    return sel?.options[sel.selectedIndex]?.text || industryGroup;
                };
                const getIndustryName = () => {
                    const sel = document.querySelector('#industry-dropdown');
                    return sel?.options[sel.selectedIndex]?.text || industry;
                };
                const getSubIndustryName = () => {
                    const sel = document.querySelector('#sub-industry-dropdown');
                    return sel?.options[sel.selectedIndex]?.text || subIndustry;
                };

                // Basic validation
                const showErr = (sel) => { const el = document.querySelector(sel); if (el) el.style.display = 'block'; };
                const hideErrs = () => {
                    ['.unit-error','.cagr-error','.ms2024-error','.ms2025-error','.ms2033-error'].forEach(s=>{ const el=document.querySelector(s); if(el) el.style.display='none'; });
                };
                hideErrs();
                let missing = false;
                if (!unit) { showErr('.unit-error'); missing = true; }
                if (!(cagrStr && !isNaN(cagrVal))) { showErr('.cagr-error'); missing = true; }
                if (!(val2024Str && !isNaN(val2024))) { showErr('.ms2024-error'); missing = true; }
                if (!(val2033Str && !isNaN(val2033))) { showErr('.ms2033-error'); missing = true; }

                if (!title || !segments.length || !companies.length) {
                    this.showNotification('Please provide title, segments, and companies.', 'warning');
                    return;
                }
                if (missing) {
                    this.showNotification('Please fill all market inputs.', 'warning');
                    return;
                }

                const generateButton = document.getElementById('generate-report-btn') || document.querySelector('.generate-item-button');
                if (generateButton) {
                    // Store original text so it can be restored later
                    const originalGenerateText = generateButton.textContent;
                    generateButton.dataset.originalText = originalGenerateText;

                    // Set disabled state, change text to use ellipsis, and mark busy
                    generateButton.disabled = true;
                    generateButton.textContent = 'Generating\u2026';
                    generateButton.setAttribute('aria-busy', 'true');
                }

                try {
                    // Hide download section when starting generation
                    document.querySelector('.download-section').style.display = 'none';
                    document.querySelector('.download-button').disabled = true;

                    // Autosave current view segments (fire-and-forget)
                    try {
                        fetch('/api/save-current-segments', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ market_name: title, segments })
                        }).catch(() => {});
                    } catch (e) {}

                    const response = await fetch('/api/generate-report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            reports: [{
                                title,
                                url: "https://www.marketsandmarkets.com/Market-Reports/example-market-123.html",
                                table_of_contents: segments,
                                company_profiles: companies,
                                market_inputs: {
                                    unit,
                                    cagr: cagrVal,
                                    value_2024: val2024,
                                    value_2033: val2033
                                },
                                industry_classification: {
                                    sector: getSectorName(),
                                    industry_group: getIndustryGroupName(),
                                    industry: getIndustryName(),
                                    sub_industry: getSubIndustryName()
                                }
                            }]
                        })
                    });

                    // Handle auth redirect (not logged in) or HTML login page
                    const ct = response.headers.get('content-type') || '';
                    const redirectedToLogin = response.redirected || (response.url && response.url.includes('/auth/login')) || ct.includes('text/html');
                    if (redirectedToLogin) {
                        this.showNotification('Please log in to generate reports.', 'warning');
                        throw new Error('Not authorized: login required');
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    this.reportBlob = await response.blob();
                    this.lastGeneratedDoc = this.reportBlob;
                    this.lastGeneratedMeta = { title, segments, companies };
                    // Only show download section after successful generation
                    document.querySelector('.download-section').style.display = 'block';
                    document.querySelector('.download-button').disabled = false;
                    const excelBtn = document.querySelector('.generate-excel-button');
                    if (excelBtn) {
                        excelBtn.style.display = 'block';
                        excelBtn.disabled = false;
                    }
                    this.showNotification('Report generated successfully.', 'success');
                } catch (error) {
                    console.error('Error generating report:', error);
                    this.showNotification('Failed to generate report. Please try again.', 'error');
                    // Ensure download section is hidden on error
                    document.querySelector('.download-section').style.display = 'none';
                    document.querySelector('.download-button').disabled = true;
                    const excelBtn = document.querySelector('.generate-excel-button');
                    if (excelBtn) {
                        excelBtn.style.display = 'none';
                        excelBtn.disabled = true;
                    }
                } finally {
                    const genBtn = document.getElementById('generate-report-btn') || document.querySelector('.generate-item-button');
                    if (genBtn) {
                        genBtn.disabled = false;
                        genBtn.textContent = genBtn.dataset.originalText || 'Generate Report';
                        genBtn.removeAttribute('aria-busy');
                        delete genBtn.dataset.originalText;
                    }
                }
            }

            collectAllSegments() {
                const segments = [];
                const segmentItems = document.querySelectorAll('.dropped-item.segment');

                segmentItems.forEach(segment => {
                    const segmentText = segment.querySelector('span').textContent;
                    segments.push(segmentText);

                    const parentSegment = segmentText.replace(/^\d+\.\s*/, '');
                    const subSegmentSection = document.querySelector(`.subsegment-section[data-parent-segment="${parentSegment}"]`);

                    if (subSegmentSection) {
                        const subSegmentItems = subSegmentSection.querySelectorAll('.dropped-item.subsegment');
                        subSegmentItems.forEach(subSegment => {
                            const subSegmentText = subSegment.querySelector('span').textContent;
                            segments.push(subSegmentText);

                            const parentSubSegment = subSegmentText.replace(/^\d+\.\d+\.\s*/, '');
                            const subSubSegmentSection = subSegmentSection.querySelector(`.subsubsegment-section[data-parent-sub-segment="${parentSubSegment}"]`);

                            if (subSubSegmentSection) {
                                const subSubSegmentItems = subSubSegmentSection.querySelectorAll('.dropped-item.subsubsegment');
                                subSubSegmentItems.forEach(subSubSegment => {
                                    const subSubSegmentText = subSubSegment.querySelector('span').textContent;
                                    segments.push(subSubSegmentText);

                                    const parentSubSubSegment = subSubSegmentText.replace(/^\d+\.\d+\.\d+\.\s*/, '');
                                    const subSubSubSegmentSection = subSubSegmentSection.querySelector(`.subsubsubsegment-section[data-parent-sub-sub-segment="${parentSubSubSegment}"]`);

                                    if (subSubSubSegmentSection) {
                                        const subSubSubSegmentItems = subSubSubSegmentSection.querySelectorAll('.dropped-item.subsubsubsegment');
                                        subSubSubSegmentItems.forEach(subSubSubSegment => {
                                            const subSubSubSegmentText = subSubSubSegment.querySelector('span').textContent;
                                            segments.push(subSubSubSegmentText);

                                            const parentSubSubSubSegment = subSubSubSegmentText.replace(/^\d+\.\d+\.\d+\.\d+\.\s*/, '');
                                            const subSubSubSubSegmentSection = subSubSubSegmentSection.querySelector(`.subsubsubsubsegment-section[data-parent-sub-sub-sub-segment="${parentSubSubSubSegment}"]`);

                                            if (subSubSubSubSegmentSection) {
                                                const subSubSubSubSegmentItems = subSubSubSubSegmentSection.querySelectorAll('.dropped-item.subsubsubsubsegment');
                                                subSubSubSubSegmentItems.forEach(subSubSubSubSegment => {
                                                    const subSubSubSubSegmentText = subSubSubSubSegment.querySelector('span').textContent;
                                                    segments.push(subSubSubSubSegmentText);
                                                });
                                            }
                                        });
                                    }
                                });
                            }
                        });
                    }
                });

                return segments;
            }

            collectEditedSegmentsFromUI() {
                /**
                 * Collect edited/added segments from the frontend UI (.dropped-segments)
                 * and convert them to the hierarchical format for backend
                 */
                const segments = [];
                const droppedSegmentsContainer = document.querySelector('.dropped-segments');
                
                if (!droppedSegmentsContainer) return segments;

                // Get all level-0 segments (main segments)
                const mainSegments = droppedSegmentsContainer.querySelectorAll('.dropped-item.segment');

                mainSegments.forEach(mainSegmentEl => {
                    const segmentName = mainSegmentEl.querySelector('span').textContent.trim();
                    
                    const segmentObj = {
                        name: segmentName,
                        subsegments: []
                    };

                    // Get subsegments for this segment
                    const parentSegment = segmentName.replace(/^\d+\.\s*/, '');
                    const subSegmentSection = droppedSegmentsContainer.querySelector(`.subsegment-section[data-parent-segment="${parentSegment}"]`);

                    if (subSegmentSection) {
                        const subSegments = subSegmentSection.querySelectorAll('.dropped-item.subsegment');
                        subSegments.forEach(subSegmentEl => {
                            const subSegmentName = subSegmentEl.querySelector('span').textContent.trim();
                            
                            const subSegmentObj = {
                                name: subSegmentName,
                                subsegments: []
                            };

                            // Get sub-subsegments
                            const parentSubSegment = subSegmentName.replace(/^\d+\.\d+\.\s*/, '');
                            const subSubSegmentSection = subSegmentSection.querySelector(`.subsubsegment-section[data-parent-sub-segment="${parentSubSegment}"]`);

                            if (subSubSegmentSection) {
                                const subSubSegments = subSubSegmentSection.querySelectorAll('.dropped-item.subsubsegment');
                                subSubSegments.forEach(subSubSegmentEl => {
                                    const subSubSegmentName = subSubSegmentEl.querySelector('span').textContent.trim();
                                    
                                    const subSubSegmentObj = {
                                        name: subSubSegmentName,
                                        subsegments: []
                                    };

                                    subSegmentObj.subsegments.push(subSubSegmentObj);
                                });
                            }

                            segmentObj.subsegments.push(subSegmentObj);
                        });
                    }

                    segments.push(segmentObj);
                });

                // Return in the format expected by backend
                return segments.length > 0 ? { segments: segments } : null;
            }

            downloadReport() {
                if (!this.reportBlob) return;
                const url = URL.createObjectURL(this.reportBlob);
                const a = document.createElement('a');
                a.href = url;
                const title = document.querySelector('#report-title').value.trim() || 'report';
                a.download = title + '.docx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Mark as downloaded in database
                fetch('/api/mark-downloaded', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ market_name: title })
                }).catch(err => console.warn('Failed to mark as downloaded:', err));
            }

            async generateExcel() {
                if (!this.lastGeneratedMeta) {
                    this.showNotification('Please generate the report first.', 'warning');
                    return;
                }

                const title = this.lastGeneratedMeta.title || 'report';
                const generateExcelButton = document.querySelector('.generate-excel-button');
                const originalText = generateExcelButton.textContent;
                generateExcelButton.disabled = true;
                generateExcelButton.textContent = 'Generating Excel...';

                try {
                    const response = await fetch('/api/generate-excel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            market_name: title
                        })
                    });

                    // Handle auth redirect
                    const ct = response.headers.get('content-type') || '';
                    const redirectedToLogin = response.redirected || (response.url && response.url.includes('/auth/login')) || ct.includes('text/html');
                    if (redirectedToLogin) {
                        this.showNotification('Please log in to generate Excel files.', 'warning');
                        throw new Error('Not authorized: login required');
                    }

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                    }

                    // Get the Excel file as blob
                    const excelBlob = await response.blob();

                    // Create download link
                    const url = URL.createObjectURL(excelBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = title + '.xlsx';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    // Mark as downloaded in database
                    fetch('/api/mark-downloaded', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ market_name: title })
                    }).catch(err => console.warn('Failed to mark as downloaded:', err));

                    this.showNotification('Excel file generated and downloaded successfully.', 'success');
                    generateExcelButton.textContent = 'Generate Excel';
                } catch (error) {
                    console.error('Error generating Excel:', error);
                    this.showNotification('Failed to generate Excel file: ' + error.message, 'error');
                    generateExcelButton.textContent = originalText;
                } finally {
                    generateExcelButton.disabled = false;
                }
            }

            // Removed: submitToCreator() - creator role removed

            showLoading(show) {
                document.querySelector('.loading-indicator').style.display = show ? 'flex' : 'none';
            }

            showNotification(message, type = 'info') {
                const bgColor = {
                    info: 'var(--primary)',
                    error: 'var(--error)',
                    warning: 'var(--warning)',
                    success: 'var(--success)'
                }[type] || 'var(--primary)';

                const notification = document.createElement('div');
                Object.assign(notification.style, {
                    position: 'fixed',
                    top: '100px',
                    right: '20px',
                    background: bgColor,
                    color: 'white',
                    padding: '12px 16px',
                    borderRadius: '6px',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.2)',
                    zIndex: '10000',
                    fontSize: '14px',
                    maxWidth: '300px',
                    opacity: '0',
                    transform: 'translateX(20px)',
                    transition: 'all 0.3s ease'
                });
                notification.textContent = message;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '1';
                    notification.style.transform = 'translateX(0)';
                }, 10);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(20px)';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            initializeImageGenerator() {
                const generateBtn = document.getElementById('generate-image-btn');
                const imageTitleInput = document.getElementById('image-title-input');
                const autofillBtn = document.getElementById('autofill-image-title-btn');
                const previewContainer = document.getElementById('image-preview-container');
                const closePreviewBtn = document.getElementById('close-preview-btn');
                const downloadImageBtn = document.getElementById('download-image-btn');
                const useImageBtn = document.getElementById('use-image-btn');
                const generatedImage = document.getElementById('generated-image');
                const statusMessage = document.getElementById('image-status-message');
                const spinner = document.getElementById('generate-spinner');
                const reportTitleInput = document.getElementById('report-title');

                // Auto Fill button handler
                autofillBtn.addEventListener('click', () => {
                    const reportTitle = reportTitleInput.value.trim();
                    if (!reportTitle) {
                        this.showStatusMessage('Please enter a title first', 'error');
                        return;
                    }
                    imageTitleInput.value = reportTitle;
                    imageTitleInput.focus();
                });

                generateBtn.addEventListener('click', async () => {
                    const title = imageTitleInput.value.trim();
                    if (!title) {
                        this.showStatusMessage('Please enter a title', 'error');
                        return;
                    }

                    generateBtn.disabled = true;
                    spinner.style.display = 'inline-block';
                    this.showStatusMessage('Generating image... This may take a minute...', 'info');

                    try {
                        const response = await fetch('/api/generate-image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title })
                        });

                        const data = await response.json();
                        if (!response.ok) {
                            throw new Error(data.error || 'Failed to generate image');
                        }

                        generatedImage.src = data.image;
                        previewContainer.style.display = 'block';
                        statusMessage.style.display = 'none';
                        
                        // Store the image data for download
                        this.currentGeneratedImage = {
                            data: data.image,
                            filename: data.filename
                        };
                    } catch (error) {
                        console.error('Image generation error:', error);
                        this.showStatusMessage(`Error: ${error.message}`, 'error');
                    } finally {
                        generateBtn.disabled = false;
                        spinner.style.display = 'none';
                    }
                });

                closePreviewBtn.addEventListener('click', () => {
                    previewContainer.style.display = 'none';
                });

                downloadImageBtn.addEventListener('click', () => {
                    if (!this.currentGeneratedImage) return;
                    
                    const link = document.createElement('a');
                    link.href = this.currentGeneratedImage.data;
                    link.download = this.currentGeneratedImage.filename || 'market-image.webp';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showStatusMessage('Image downloaded!', 'success');
                });

                useImageBtn.addEventListener('click', () => {
                    // Fill the title input with the image title
                    reportTitleInput.value = imageTitleInput.value;
                    previewContainer.style.display = 'none';
                    this.showStatusMessage('Title updated! Ready to generate report.', 'success');
                });

                // Allow Enter key to generate image
                imageTitleInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        generateBtn.click();
                    }
                });
            }

            showStatusMessage(message, type = 'info') {
                const statusMessage = document.getElementById('image-status-message');
                statusMessage.textContent = message;
                statusMessage.style.display = 'block';
                
                const bgColor = {
                    info: '#D1E7F7',
                    error: '#FEE2E2',
                    warning: '#FEF3C7',
                    success: '#D1FAE5'
                }[type] || '#D1E7F7';
                
                const textColor = {
                    info: '#0369A1',
                    error: '#DC2626',
                    warning: '#D97706',
                    success: '#059669'
                }[type] || '#0369A1';
                
                statusMessage.style.background = bgColor;
                statusMessage.style.color = textColor;
                statusMessage.style.border = `1px solid ${textColor}`;
                
                setTimeout(() => {
                    if (statusMessage.style.display !== 'none') {
                        statusMessage.style.display = 'none';
                    }
                }, 4000);
            }

            async saveAllData() {
                // Collect title
                const title = document.querySelector('#report-title').value.trim();
                if (!title) {
                    this.showNotification('Please enter a title before saving.', 'warning');
                    return;
                }

                // Collect industry classification
                const sector = (document.querySelector('#sector-dropdown')?.value || '').trim();
                const industryGroup = (document.querySelector('#industry-group-dropdown')?.value || '').trim();
                const industry = (document.querySelector('#industry-dropdown')?.value || '').trim();
                const subIndustry = (document.querySelector('#sub-industry-dropdown')?.value || '').trim();

                // Get display names from dropdown options
                const getSectorName = () => {
                    const sel = document.querySelector('#sector-dropdown');
                    return sel?.options[sel.selectedIndex]?.text || sector;
                };
                const getIndustryGroupName = () => {
                    const sel = document.querySelector('#industry-group-dropdown');
                    return sel?.options[sel.selectedIndex]?.text || industryGroup;
                };
                const getIndustryName = () => {
                    const sel = document.querySelector('#industry-dropdown');
                    return sel?.options[sel.selectedIndex]?.text || industry;
                };
                const getSubIndustryName = () => {
                    const sel = document.querySelector('#sub-industry-dropdown');
                    return sel?.options[sel.selectedIndex]?.text || subIndustry;
                };

                // Collect market inputs
                const unit = (document.querySelector('#value-unit')?.value || '').trim();
                const cagr = (document.querySelector('#cagr-2025-2033')?.value || '').trim();
                const marketSize2024 = (document.querySelector('#market-size-2024')?.value || '').trim();
                const marketSize2025 = (document.querySelector('#market-size-2025')?.value || '').trim();
                const projectedSize2033 = (document.querySelector('#projected-size-2033')?.value || '').trim();

                // Collect segments visible in View Segments (final edited list)
                const segments = this.collectAllSegmentsForViewer();

                // Collect companies
                const companies = Array.from(document.querySelectorAll('.dropped-companies .dropped-item span')).map(span => span.textContent);

                // Validate that all required fields are filled
                let validationErrors = [];
                if (!sector) validationErrors.push('Sector');
                if (!industryGroup) validationErrors.push('Industry Group');
                if (!industry) validationErrors.push('Industry');
                if (!subIndustry) validationErrors.push('Sub-Industry');
                if (!unit) validationErrors.push('Value Unit');
                if (!cagr) validationErrors.push('CAGR');
                if (!marketSize2024) validationErrors.push('Market Size 2024');
                if (!projectedSize2033) validationErrors.push('Projected Size 2033');
                if (segments.length === 0) validationErrors.push('Segments');
                if (companies.length === 0) validationErrors.push('Companies');

                if (validationErrors.length > 0) {
                    this.showNotification(`Please fill in: ${validationErrors.join(', ')}`, 'warning');
                    return;
                }

                const saveButton = document.getElementById('save-data-btn');
                saveButton.disabled = true;
                saveButton.textContent = 'ðŸ’¾ Saving...';

                try {
                    // Prepare data structure
                    // Determine ai_gen_seg to send: prefer immutable originalAiSegments, fall back to aiSegmentsJSON.segments if present
                    const aiToSend = (this.originalAiSegments && Array.isArray(this.originalAiSegments) && this.originalAiSegments.length > 0)
                        ? this.originalAiSegments
                        : (this.aiSegmentsJSON && Array.isArray(this.aiSegmentsJSON.segments) && this.aiSegmentsJSON.segments.length > 0)
                            ? this.aiSegmentsJSON.segments
                            : [];

                    console.log('Saving data: ai_gen_seg length=', aiToSend.length, 'sample=', aiToSend.slice ? aiToSend.slice(0,3) : aiToSend);

                    const dataToSave = {
                        title: title,
                        timestamp: new Date().toISOString(),
                        industryClassification: {
                            sector: getSectorName(),
                            industryGroup: getIndustryGroupName(),
                            industry: getIndustryName(),
                            subIndustry: getSubIndustryName()
                        },
                        marketInputs: {
                            valueUnit: unit,
                            cagr2025_2033: parseFloat(cagr),
                            marketSize2024: parseFloat(marketSize2024),
                            marketSize2025: parseFloat(marketSize2025),
                            projectedSize2033: parseFloat(projectedSize2033)
                        },
                        segments: segments,
                        ai_gen_seg: aiToSend,
                        companies: companies,
                        createdBy: 'user',
                        version: '1.0',
                        active_seconds: window._activeTimer ? window._activeTimer.flush() : null,
                        additional_kmi: (document.getElementById('kmi-data-input')?.value.trim() || '').split('\n').map(s => s.trim()).filter(Boolean).join(',')
                    };

                    const response = await fetch('/api/save-data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataToSave)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        this.showNotification(`Save failed: ${errorData.error || 'Unknown error'}`, 'error');
                        return;
                    }

                    const result = await response.json();
                    this.showNotification(`âœ“ Data saved successfully to ${result.filename}`, 'success');
                    
                } catch (error) {
                    console.error('Error saving data:', error);
                    this.showNotification(`Error saving data: ${error.message}`, 'error');
                } finally {
                    saveButton.disabled = false;
                    saveButton.textContent = 'ðŸ’¾ Save';
                }
            }

            async generateTOC() {
                // Collect title
                const title = document.querySelector('#report-title').value.trim();
                if (!title) {
                    this.showNotification('Please enter a title before generating TOC.', 'warning');
                    return;
                }

                // Collect KMI data: fixed checkboxes + additional from textarea
                const fixedKmi = Array.from(document.querySelectorAll('.kmi-fixed-cb:checked')).map(cb => cb.value);
                const extraKmi = (document.getElementById('kmi-data-input')?.value.trim() || '')
                    .split('\n').map(s => s.trim()).filter(Boolean);
                const kmiData = [...fixedKmi, ...extraKmi].join('\n');
                
                // Collect segments visible in View Segments (final edited list)
                const segments = this.collectAllSegmentsForViewer();
                if (segments.length === 0) {
                    this.showNotification('Please add at least one segment.', 'warning');
                    return;
                }

                // Collect companies
                const companies = Array.from(document.querySelectorAll('.dropped-companies .dropped-item span')).map(span => span.textContent).join('\n');

                // **COLLECT EDITED SEGMENTS FROM FRONTEND** (from .dropped-segments)
                const editedSegments = this.collectEditedSegmentsFromUI();

                const tocBtn = document.getElementById('generate-toc-btn');
                tocBtn.disabled = true;
                tocBtn.textContent = 'â³ Generating TOC...';

                try {
                    const requestData = {
                        market_name: title,
                        segments: segments, // final edited view segments from UI (strings)
                        company_data: companies,
                        kmi_data: kmiData,
                        additional_kmi: (document.getElementById('kmi-data-input')?.value.trim() || '').split('\n').map(s => s.trim()).filter(Boolean).join(',')
                    };

                    // Optionally include the original AI segments for reference (not used if `segments` provided)
                    if (this.originalAiSegments) {
                        requestData.ai_gen_seg = this.originalAiSegments;
                    }

                    // Autosave current view segments (fire-and-forget) so backend can pick them up without explicit Save
                    try {
                        fetch('/api/save-current-segments', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ market_name: title, segments, additional_kmi: requestData.additional_kmi })
                        }).catch(() => {});
                    } catch (e) {}


                    const response = await fetch('/api/generate-toc', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to generate TOC');
                    }

                    const result = await response.json();
                    
                    // Download the file
                    const link = document.createElement('a');
                    link.href = `/api/download-file?file_path=${encodeURIComponent(result.file_path)}`;
                    link.download = result.filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification(`âœ“ TOC generated and downloaded: ${result.filename}`, 'success');
                } catch (error) {
                    console.error('Error generating TOC:', error);
                    this.showNotification(`Error generating TOC: ${error.message}`, 'error');
                } finally {
                    tocBtn.disabled = false;
                    tocBtn.textContent = 'ðŸ“„ Generate TOC';
                }
            }

            async generateShortRD() {
                // Collect title
                const title = document.querySelector('#report-title').value.trim();
                if (!title) {
                    this.showNotification('Please enter a title before generating Short RD.', 'warning');
                    return;
                }

                // Collect segments visible in View Segments (final edited list)
                const segments = this.collectAllSegmentsForViewer();
                if (segments.length === 0) {
                    this.showNotification('Please add at least one segment.', 'warning');
                    return;
                }

                // Collect companies
                const companies = Array.from(document.querySelectorAll('.dropped-companies .dropped-item span')).map(span => span.textContent).join('\n');
                if (!companies.trim()) {
                    this.showNotification('Please add at least one company.', 'warning');
                    return;
                }

            // Collect market inputs (REQUIRED for Short RD)
            const unit = document.querySelector('#value-unit')?.value || 'million';
            const cagr = document.querySelector('#cagr-2025-2033')?.value || '';
            const marketSize2024 = document.querySelector('#market-size-2024')?.value || '';
            const projectedSize2033 = document.querySelector('#projected-size-2033')?.value || '';
            
            // Validate Market Inputs before proceeding
            if (!unit || !cagr || !marketSize2024 || !projectedSize2033) {
                this.showNotification('Please fill in all Market Inputs fields (Unit, CAGR, Market Size 2024, Projected Size 2033)', 'error');
                return;
            }

            const rdBtn = document.getElementById('generate-short-rd-btn');
            rdBtn.disabled = true;
            rdBtn.textContent = 'â³ Generating Short RD...';

            try {
                const requestData = {
                    market_name: title,
                    segments: segments, // final edited view segments from UI
                    company_data: companies,
                    value_2024: parseFloat(marketSize2024),
                    currency: unit,
                    cagr: parseFloat(cagr),
                    // IMPORTANT: Include marketInputs object for backend validation
                    marketInputs: {
                        unit: unit,
                        cagr: parseFloat(cagr),
                        marketSize2024: parseFloat(marketSize2024),
                        projectedSize2033: parseFloat(projectedSize2033)
                    },
                    additional_kmi: (document.getElementById('kmi-data-input')?.value.trim() || '').split('\n').map(s => s.trim()).filter(Boolean).join(',')
                };

                    // Optionally include the original AI segments for reference
                    if (this.originalAiSegments) {
                        requestData.ai_gen_seg = this.originalAiSegments;
                    }

                // Autosave current view segments with Market Inputs (fire-and-forget)
                try {
                    fetch('/api/save-current-segments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            market_name: title, 
                            segments,
                            companies: companies.split('\n'),
                            value_2024: parseFloat(marketSize2024),
                            currency: unit,
                            cagr: parseFloat(cagr),
                            marketInputs: {
                                unit: unit,
                                cagr: parseFloat(cagr),
                                marketSize2024: parseFloat(marketSize2024),
                                projectedSize2033: parseFloat(projectedSize2033)
                            },
                            additional_kmi: requestData.additional_kmi
                        })
                    }).catch(() => {});
                } catch (e) {}

                const response = await fetch('/api/generate-short-rd', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to generate Short RD');
                    }

                    const result = await response.json();
                    
                    // Download the file
                    const link = document.createElement('a');
                    link.href = `/api/download-file?file_path=${encodeURIComponent(result.file_path)}`;
                    link.download = result.filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification(`âœ“ Short RD generated and downloaded: ${result.filename}`, 'success');
                } catch (error) {
                    console.error('Error generating Short RD:', error);
                    this.showNotification(`Error generating Short RD: ${error.message}`, 'error');
                } finally {
                    rdBtn.disabled = false;
                    rdBtn.textContent = 'ðŸ“‹ Generate Short RD';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const app = new MarketResearchAutomation();
            app.initializeImageGenerator();
        });
    </script>

    <script>
    // Active-time tracker: counts only seconds when tab is visible AND user was recently active
    (function () {
        const IDLE_THRESHOLD_MS = 5 * 60 * 1000;
        let accumulated = 0;    
        let tickStart = null;      
        let lastActivity = Date.now();
        let visible = !document.hidden;

        function isActive() {
            return visible && (Date.now() - lastActivity) < IDLE_THRESHOLD_MS;
        }

        function startTick() {
            if (tickStart === null && isActive()) {
                tickStart = Date.now();
            }
        }

        function pauseTick() {
            if (tickStart !== null) {
                accumulated += Math.floor((Date.now() - tickStart) / 1000);
                tickStart = null;
            }
        }

        // Tick every second: if active, keep counting; if gone idle/hidden, pause
        setInterval(() => {
            if (isActive()) {
                startTick();
            } else {
                pauseTick();
            }
        }, 1000);

        // Visibility change: pause when hidden, resume when visible
        document.addEventListener('visibilitychange', () => {
            visible = !document.hidden;
            if (visible) {
                lastActivity = Date.now();
                startTick();
            } else {
                pauseTick();
            }
        });

        // Activity events: reset idle clock
        ['mousemove', 'keydown', 'mousedown', 'touchstart', 'scroll'].forEach(ev => {
            document.addEventListener(ev, () => {
                lastActivity = Date.now();
                if (visible && tickStart === null) startTick();
            }, { passive: true });
        });

        startTick();

        window._activeTimer = {
            // Call on save: captures remaining tick and returns total, then resets for next title
            flush() {
                pauseTick();
                const total = accumulated;
                accumulated = 0;
                startTick();
                return total > 0 ? total : null;
            },
            getSeconds() { return accumulated + (tickStart ? Math.floor((Date.now() - tickStart) / 1000) : 0); }
        };
    })();
    </script>
</body>
</html>